<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê¸°ë¶„ê¸°ë¡ì§€ 1.0 | ë¶„ë‹¹ì„œìš¸ëŒ€í•™êµë³‘ì›</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* --- CSS ìŠ¤íƒ€ì¼ ì •ì˜ --- */
    :root { 
        --primary: #005eb8; /* SNUH Blue */
        --line-color: #555; 
        --line-light: #ccc;
        --bg-mania: #ffebee; 
        --bg-dep: #e3f2fd; 
        --bg-head: #f8f9fa;
    }
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; background: #fff; color: #333; font-size: 12px; }
    .hidden { display: none !important; }
    input, button, select { outline: none; font-family: inherit; }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #auth-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: #f0f4f8; }
    .auth-box { width: 360px; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
    .auth-inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
    .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 15px; margin-top: 10px; }
    .toggle-auth { margin-top: 15px; font-size: 13px; color: #666; cursor: pointer; text-decoration: underline; display: inline-block; }

    /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
    .container { max-width: 100%; padding: 10px; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; flex-wrap: wrap; gap: 10px; }
    .month-nav { font-size: 1.4rem; font-weight: bold; display: flex; align-items: center; gap: 15px; color: #333; }
    .btn-nav { background: white; border: 1px solid #ccc; padding: 5px 12px; cursor: pointer; border-radius: 4px; font-size: 13px; display: flex; align-items: center; gap: 5px; }
    .btn-nav:hover { background: #f0f0f0; }
    
    #date-picker { border: 1px solid #ccc; padding: 4px; border-radius: 4px; font-size: 14px; }

    /* ì—‘ì…€ ê·¸ë¦¬ë“œ */
    .grid-wrapper { overflow-x: auto; border: 1px solid var(--line-color); height: calc(100vh - 180px); }
    table { border-collapse: separate; border-spacing: 0; min-width: 1600px; width: 100%; table-layout: fixed; }
    
    th, td { border-right: 1px solid var(--line-light); border-bottom: 1px solid var(--line-light); text-align: center; height: 38px; padding: 0; box-sizing: border-box; font-size: 12px; vertical-align: middle; background: #fff; }
    
    /* í—¤ë” ë° ì²«ì—´ ê³ ì • */
    thead th { position: sticky; top: 0; background: var(--bg-head); z-index: 10; border-bottom: 2px solid var(--line-color); height: 45px; }
    .col-label { position: sticky; left: 0; background: #fff; z-index: 20; width: 220px; min-width: 220px; border-right: 2px solid var(--line-color); text-align: left; padding-left: 10px; font-weight: bold; white-space: pre-wrap; line-height: 1.3; }
    
    /* ì£¼ë§ ë° íœ´ì¼ */
    .day-sun { color: red; background-color: #fff5f5 !important; border-right: 2px solid #555 !important; }
    .day-sat { color: blue; background-color: #f5faff !important; }
    .day-holiday { color: red !important; background-color: #fff0f0 !important; font-weight: bold; }

    /* í–‰ ë°°ê²½ìƒ‰ */
    .bg-mania { background-color: var(--bg-mania); }
    .bg-dep { background-color: var(--bg-dep); }
    
    /* ì…ë ¥ ì»¨íŠ¸ë¡¤ */
    .cell-check { cursor: pointer; font-size: 18px; color: #ccc; user-select: none; }
    .cell-check.checked { font-weight: 900; color: #000; }
    .cell-check.checked::after { content: "âœ”"; }
    
    .cell-select { width: 100%; height: 100%; border: none; text-align: center; text-align-last: center; background: transparent; font-size: 12px; appearance: none; -webkit-appearance: none; cursor: pointer; }
    .cell-input { width: 100%; height: 100%; border: none; text-align: center; background: transparent; font-size: 12px; }
    .cell-text input { width: 96%; border: none; background: transparent; font-size: 11px; text-align: left; padding-left: 5px; }
    .disabled-cell { background-color: #eee; pointer-events: none; }

    /* íˆ´íŒ */
    .tooltip-target:hover::after {
        content: attr(data-tip);
        position: fixed; left: 240px; top: 50%; transform: translateY(-50%);
        background: #333; color: #fff; padding: 12px; border-radius: 8px;
        width: 220px; font-size: 13px; line-height: 1.5; z-index: 1000;
        box-shadow: 4px 4px 15px rgba(0,0,0,0.3); pointer-events: none;
    }

    /* í•˜ë‹¨ ì„¹ì…˜ */
    .footer { margin-top: 10px; padding: 15px; background: #f9f9f9; border-top: 2px solid #555; font-size: 11px; color: #555; line-height: 1.6; display: flex; justify-content: space-between; align-items: flex-start; }
    .data-controls { display: flex; gap: 10px; flex-shrink: 0; }
    
    @media (max-width: 768px) {
        .col-label { width: 140px; min-width: 140px; font-size: 11px; }
        .grid-wrapper { height: calc(100vh - 260px); } /* í•˜ë‹¨ ë¬¸êµ¬ ê³µê°„ í™•ë³´ */
        .tooltip-target:hover::after { display: none; }
        .footer { flex-direction: column; gap: 10px; }
    }
</style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--primary); margin-top:0;">ê¸°ë¶„ê¸°ë¡ì§€</h2>
        <div id="login-form">
            <input id="l-id" class="auth-inp" placeholder="ì•„ì´ë””">
            <input id="l-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-auth" onclick="login()">ë¡œê·¸ì¸</button>
            <span class="toggle-auth" onclick="toggleAuth('join')">íšŒì›ê°€ì…</span>
        </div>
        <div id="join-form" class="hidden">
            <input id="j-id" class="auth-inp" placeholder="í¬ë§ ì•„ì´ë””">
            <input id="j-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input id="j-hosp" class="auth-inp" placeholder="ë³‘ì› í™˜ìë²ˆí˜¸ (ì„ íƒ)">
            <div style="text-align:left; font-size:11px; margin:10px 0; background:#eee; padding:8px; border-radius:4px; word-break: keep-all;">
                <strong>[ì´ìš© ì•ˆë‚´ ë° ë©´ì±… ì¡°í•­]</strong><br>
                ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš© í”„ë¡œê·¸ë¨ì´ ì•„ë‹™ë‹ˆë‹¤. <br>
                ì´ í”„ë¡œê·¸ë¨ì˜ ì‚¬ìš©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì±…ì„ì€ ì˜ë£Œì§„ì´ ì•„ë‹Œ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ìœ ë…í•˜ì„¸ìš”.
            </div>
            <label style="font-size:12px; cursor:pointer;"><input type="checkbox" id="j-agree"> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.</label>
            <button class="btn-auth" style="background:#28a745;" onclick="join()">ê°€ì…ì™„ë£Œ</button>
            <span class="toggle-auth" onclick="toggleAuth('login')">ëŒì•„ê°€ê¸°</span>
        </div>
    </div>
</div>

<div id="main-screen" class="hidden">
    <div class="container">
        <div class="header">
            <div class="month-nav">
                <button class="btn-nav" onclick="moveMonth(-1)">â—€</button>
                <input type="date" id="date-picker" onchange="jumpToDate(this.value)">
                <button class="btn-nav" onclick="moveMonth(1)">â–¶</button>
            </div>
            <div style="text-align:right; display:flex; align-items:center; gap:10px;">
                <span id="user-display" style="font-weight:bold;"></span>
                <button class="btn-nav" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ</button>
                <div id="doc-panel" class="hidden">
                    <input id="search-id" placeholder="í™˜ìID ì¡°íšŒ" style="padding:4px; width:100px;">
                    <button class="btn-nav" onclick="loadData()">ì¡°íšŒ</button>
                </div>
            </div>
        </div>

        <div class="grid-wrapper">
            <table id="mood-table">
                <thead>
                    <tr id="header-row"><th class="col-label" style="text-align:center;">í•­ëª© / ë‚ ì§œ</th></tr>
                    <tr id="dow-row"><th class="col-label" style="text-align:center; background:#f9f9f9; color:#666;">ìš”ì¼</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="footer">
            <div style="word-break: keep-all; margin-right: 20px;">
                <strong>[ì•ˆë‚´]</strong> ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš© í”„ë¡œê·¸ë¨ì´ ì•„ë‹™ë‹ˆë‹¤. <br>
                ì´ í”„ë¡œê·¸ë¨ì˜ ì‚¬ìš©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì±…ì„ì€ ì˜ë£Œì§„ì´ ì•„ë‹Œ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ë¯¼ê°ì •ë³´ ë° ê°œì¸ì‹ë³„ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”.
            </div>
            <div class="data-controls">
                <button class="btn-nav" onclick="exportData()" style="border:1px solid var(--primary); color:var(--primary);">ğŸ’¾ ë‚´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
                <input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importData(this)">
                <button class="btn-nav" onclick="document.getElementById('import-file').click()">ğŸ“‚ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
    // [ì¤‘ìš”] Supabase ì„¤ì • (ë³¸ì¸ì˜ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”)
    const SUPABASE_URL = 'https://vzybcxvwpqhdmrxbxzmq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bAlzb9dPdxb5lpzudvqwHQ_MxpUVkNj;
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // [ê³µíœ´ì¼ ë°ì´í„° 2025~2040]
    // ì–‘ë ¥ ê³ ì • ê³µíœ´ì¼ì€ ë‚ ì§œë§Œ, ìŒë ¥/ëŒ€ì²´ ê³µíœ´ì¼ì€ ì „ì²´ ë‚ ì§œ(YYYY-MM-DD)
    const krHolidays = {
        // ì–‘ë ¥ ê³ ì •
        '01-01': 'ì‹ ì •', '03-01': 'ì‚¼ì¼ì ˆ', '05-05': 'ì–´ë¦°ì´ë‚ ', '06-06': 'í˜„ì¶©ì¼', 
        '08-15': 'ê´‘ë³µì ˆ', '10-03': 'ê°œì²œì ˆ', '10-09': 'í•œê¸€ë‚ ', '12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        
        // 2025
        '2025-01-28':'ì„¤ë‚ ', '2025-01-29':'ì„¤ë‚ ', '2025-01-30':'ì„¤ë‚ ', '2025-03-03':'ëŒ€ì²´ê³µíœ´ì¼', '2025-05-06':'ëŒ€ì²´ê³µíœ´ì¼',
        '2025-10-05':'ì¶”ì„', '2025-10-06':'ì¶”ì„', '2025-10-07':'ì¶”ì„', '2025-10-08':'ëŒ€ì²´ê³µíœ´ì¼',
        
        // 2026
        '2026-02-16':'ì„¤ë‚ ', '2026-02-17':'ì„¤ë‚ ', '2026-02-18':'ì„¤ë‚ ', '2026-05-24':'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25':'ëŒ€ì²´ê³µíœ´ì¼',
        '2026-09-24':'ì¶”ì„', '2026-09-25':'ì¶”ì„', '2026-09-26':'ì¶”ì„', 
        
        // 2027
        '2027-02-06':'ì„¤ë‚ ', '2027-02-07':'ì„¤ë‚ ', '2027-02-08':'ì„¤ë‚ ', '2027-02-09':'ëŒ€ì²´ê³µíœ´ì¼', '2027-05-13':'ì„ê°€íƒ„ì‹ ì¼',
        '2027-09-14':'ì¶”ì„', '2027-09-15':'ì¶”ì„', '2027-09-16':'ì¶”ì„',
        
        // 2028
        '2028-01-26':'ì„¤ë‚ ', '2028-01-27':'ì„¤ë‚ ', '2028-01-28':'ì„¤ë‚ ', '2028-05-02':'ì„ê°€íƒ„ì‹ ì¼',
        '2028-10-02':'ì¶”ì„', '2028-10-03':'ê°œì²œì ˆ/ì¶”ì„', '2028-10-04':'ì¶”ì„', '2028-10-05':'ëŒ€ì²´ê³µíœ´ì¼',
        
        // 2029
        '2029-02-12':'ì„¤ë‚ ', '2029-02-13':'ì„¤ë‚ ', '2029-02-14':'ì„¤ë‚ ', '2029-05-20':'ì„ê°€íƒ„ì‹ ì¼', '2029-05-21':'ëŒ€ì²´ê³µíœ´ì¼',
        '2029-09-21':'ì¶”ì„', '2029-09-22':'ì¶”ì„', '2029-09-23':'ì¶”ì„',
        
        // 2030
        '2030-02-02':'ì„¤ë‚ ', '2030-02-03':'ì„¤ë‚ ', '2030-02-04':'ì„¤ë‚ ', '2030-02-05':'ëŒ€ì²´ê³µíœ´ì¼', '2030-05-09':'ì„ê°€íƒ„ì‹ ì¼',
        '2030-09-11':'ì¶”ì„', '2030-09-12':'ì¶”ì„', '2030-09-13':'ì¶”ì„',

        // 2031
        '2031-01-22':'ì„¤ë‚ ', '2031-01-23':'ì„¤ë‚ ', '2031-01-24':'ì„¤ë‚ ', '2031-05-28':'ì„ê°€íƒ„ì‹ ì¼',
        '2031-09-30':'ì¶”ì„', '2031-10-01':'ì¶”ì„', '2031-10-02':'ì¶”ì„',

        // 2032
        '2032-02-10':'ì„¤ë‚ ', '2032-02-11':'ì„¤ë‚ ', '2032-02-12':'ì„¤ë‚ ', '2032-05-16':'ì„ê°€íƒ„ì‹ ì¼', '2032-05-17':'ëŒ€ì²´ê³µíœ´ì¼',
        '2032-09-18':'ì¶”ì„', '2032-09-19':'ì¶”ì„', '2032-09-20':'ì¶”ì„', '2032-09-21':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2033
        '2033-01-30':'ì„¤ë‚ ', '2033-01-31':'ì„¤ë‚ ', '2033-02-01':'ì„¤ë‚ ', '2033-05-06':'ì„ê°€íƒ„ì‹ ì¼',
        '2033-10-07':'ì¶”ì„', '2033-10-08':'ì¶”ì„', '2033-10-09':'ì¶”ì„', '2033-10-10':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2034
        '2034-02-18':'ì„¤ë‚ ', '2034-02-19':'ì„¤ë‚ ', '2034-02-20':'ì„¤ë‚ ', '2034-02-21':'ëŒ€ì²´ê³µíœ´ì¼', '2034-05-25':'ì„ê°€íƒ„ì‹ ì¼',
        '2034-09-26':'ì¶”ì„', '2034-09-27':'ì¶”ì„', '2034-09-28':'ì¶”ì„',

        // 2035
        '2035-02-07':'ì„¤ë‚ ', '2035-02-08':'ì„¤ë‚ ', '2035-02-09':'ì„¤ë‚ ', '2035-05-15':'ì„ê°€íƒ„ì‹ ì¼',
        '2035-09-15':'ì¶”ì„', '2035-09-16':'ì¶”ì„', '2035-09-17':'ì¶”ì„', '2035-09-18':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2036
        '2036-01-27':'ì„¤ë‚ ', '2036-01-28':'ì„¤ë‚ ', '2036-01-29':'ì„¤ë‚ ', '2036-05-02':'ì„ê°€íƒ„ì‹ ì¼',
        '2036-10-03':'ì¶”ì„', '2036-10-04':'ì¶”ì„', '2036-10-05':'ì¶”ì„', '2036-10-06':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2037
        '2037-02-14':'ì„¤ë‚ ', '2037-02-15':'ì„¤ë‚ ', '2037-02-16':'ì„¤ë‚ ', '2037-02-17':'ëŒ€ì²´ê³µíœ´ì¼', '2037-05-22':'ì„ê°€íƒ„ì‹ ì¼',
        '2037-09-23':'ì¶”ì„', '2037-09-24':'ì¶”ì„', '2037-09-25':'ì¶”ì„',

        // 2038
        '2038-02-03':'ì„¤ë‚ ', '2038-02-04':'ì„¤ë‚ ', '2038-02-05':'ì„¤ë‚ ', '2038-05-11':'ì„ê°€íƒ„ì‹ ì¼',
        '2038-09-12':'ì¶”ì„', '2038-09-13':'ì¶”ì„', '2038-09-14':'ì¶”ì„', '2038-09-15':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2039
        '2039-01-23':'ì„¤ë‚ ', '2039-01-24':'ì„¤ë‚ ', '2039-01-25':'ì„¤ë‚ ', '2039-05-01':'ì„ê°€íƒ„ì‹ ì¼', '2039-05-02':'ëŒ€ì²´ê³µíœ´ì¼',
        '2039-10-01':'ì¶”ì„', '2039-10-02':'ì¶”ì„', '2039-10-03':'ì¶”ì„',

        // 2040
        '2040-02-11':'ì„¤ë‚ ', '2040-02-12':'ì„¤ë‚ ', '2040-02-13':'ì„¤ë‚ ', '2040-02-14':'ëŒ€ì²´ê³µíœ´ì¼', '2040-05-19':'ì„ê°€íƒ„ì‹ ì¼',
        '2040-09-20':'ì¶”ì„', '2040-09-21':'ì¶”ì„', '2040-09-22':'ì¶”ì„'
    };

    const items = [
        { id: 'm_p4', label: '+4 ê·¹íˆ ìƒìŠ¹', desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', group: 'mood' },
        { id: 'm_p3', label: '+3 ìƒë‹¹í•œ ìƒìŠ¹', desc: 'ìƒë‹¹í•œ ì§€ì¥, ì£¼ë³€ì—ì„œ í˜ë“¤ì–´í•¨', group: 'mood' },
        { id: 'm_p2', label: '+2 ë¶„ëª…í•œ ìƒìŠ¹', desc: 'ë‹¤ì†Œ ì§€ì¥, ì „ê³¼ ë‹¤ë¥´ë‹¤ëŠ” ì§€ì ', group: 'mood' },
        { id: 'm_p1', label: '+1 ë¯¸ì„¸í•œ ìƒìŠ¹', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ë³¸ì¸ì€ ê¸°ë¶„ ì¢‹ìŒ', group: 'mood' },
        { id: 'm_0',  label: '0  ë³´í†µ ê¸°ë¶„',   desc: 'í‰ì˜¨í•˜ê³  ì •ìƒì ì¸ ìƒíƒœ', group: 'mood' },
        { id: 'm_m1', label: '-1 ë¯¸ì„¸í•œ ì €í•˜', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ì˜ìš• ì €í•˜', group: 'mood' },
        { id: 'm_m2', label: '-2 ë¶„ëª…í•œ ì €í•˜', desc: 'ì¼ìƒì„ ìœ ì§€í•˜ë ¤ ë…¸ë ¥ í•„ìš”', group: 'mood' },
        { id: 'm_m3', label: '-3 ìƒë‹¹í•œ ì €í•˜', desc: 'ë…¸ë ¥í•´ë„ ê¸°ëŠ¥ì´ ë–¨ì–´ì§', group: 'mood' },
        { id: 'm_m4', label: '-4 ê·¹íˆ ì €í•˜',   desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', group: 'mood' },
        
        // ì²™ë„í˜• (-4 ~ +4)
        { id: 's_anx', label: 'ì •ì„œ ë°˜ì‘\n(ë¶ˆì•ˆ/ìš°ìš¸ ë“±)', desc: '-4(ë¬´ê°ê°) ~ +4(ê³¼ë¯¼)', group: 'scale' },
        { id: 's_mot', label: 'ì˜ìš•/í¥ë¯¸', desc: '-4(ë¬´ì˜ìš•) ~ +4(ì¶©ë™ì )', group: 'scale' },
        { id: 's_tht', label: 'ìƒê°ì˜ ì†ë„/ì–‘', desc: '-4(ëŠë¦¼/ì—†ìŒ) ~ +4(ë¹ ë¦„/ë§ìŒ)', group: 'scale' },

        // ìˆ˜ì¹˜ ì…ë ¥
        { id: 'sleep', label: 'ìˆ˜ë©´ì‹œê°„ (ì‹œê°„)', desc: '0~24ì‹œê°„ ì„ íƒ', group: 'val_sleep' },
        { id: 'weight',label: 'ì²´ì¤‘ (kg)\n*ì¼ìš”ì¼ë§Œ', desc: 'ì¼ìš”ì¼ ì•„ì¹¨ ì¸¡ì • ê¶Œì¥', group: 'val_weight' },

        // ì²´í¬ë°•ìŠ¤
        { id: 'panic', label: 'ê³µí™©ë°œì‘ (âˆš)', desc: 'ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê³µí¬/ì‹ ì²´ì¦ìƒ', group: 'chk' },
        { id: 'hyper', label: 'ê³¼í˜¸í¡ (âˆš)', desc: 'ìˆ¨ì´ ê°€ì˜ê³  ì†ë°œ ì €ë¦¼ ë“±', group: 'chk' },
        { id: 'cry',   label: 'ìš¸ìŒ (âˆš)', desc: '', group: 'chk' },
        { id: 'pain',  label: 'í†µì¦ (âˆš)', desc: '', group: 'chk' },
        { id: 'meds',  label: 'ì•½ë¬¼ë³µìš© (âˆš)', desc: '', group: 'chk' },
        { id: 'period',label: 'ìƒë¦¬ê¸°ê°„ (âˆš)', desc: '', group: 'chk' },
        { id: 'alcoh', label: 'ìŒì£¼ (âˆš)', desc: '', group: 'chk' },
        { id: 'binge', label: 'í­ì‹ (âˆš)', desc: '', group: 'chk' },

        // í…ìŠ¤íŠ¸
        { id: 'event', label: 'ìƒí™œì‚¬ê±´ (ê¸°ë¡)', desc: 'ìŠ¤íŠ¸ë ˆìŠ¤ ìš”ì¸ ë“± ìƒì„¸ ê¸°ë¡', group: 'text' }
    ];

    let user = null, target = null, curDate = new Date();

    // --- ì¸ì¦ ë¡œì§ ---
    function toggleAuth(m) {
        document.getElementById('login-form').classList.toggle('hidden', m !== 'login');
        document.getElementById('join-form').classList.toggle('hidden', m !== 'join');
    }

    async function join() {
        if(!document.getElementById('j-agree').checked) return alert("ì´ìš© ì•ˆë‚´ ë° ë©´ì±… ì¡°í•­ì— ë™ì˜í•´ì•¼ ê°€ì… ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        const id = document.getElementById('j-id').value, pw = document.getElementById('j-pw').value, h = document.getElementById('j-hosp').value;
        if(!id || !pw) return alert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        const { error } = await sb.from('user_profiles').insert([{ username:id, password:pw, hospital_id:h }]);
        if(error) alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); else { alert('ê°€ì… ì™„ë£Œ. ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.'); toggleAuth('login'); }
    }

    async function login() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        const { data } = await sb.from('user_profiles').select('*').eq('username',id).eq('password',pw).single();
        if(!data) return alert('ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        user = data; target = id;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = id + (user.role==='doctor'?'(ì˜ë£Œì§„)':'');
        if(user.role==='doctor') { document.getElementById('doc-panel').classList.remove('hidden'); target = null; }
        renderTable();
    }

    // --- í…Œì´ë¸” ë Œë”ë§ (í•µì‹¬ UI) ---
    function renderTable() {
        // ë‚ ì§œ ë™ê¸°í™”
        const year = curDate.getFullYear(), month = curDate.getMonth();
        const dateStr = `${year}-${String(month+1).padStart(2,'0')}-01`;
        document.getElementById('date-picker').value = dateStr;

        const lastDay = new Date(year, month+1, 0).getDate();
        const header = document.getElementById('header-row');
        const dowRow = document.getElementById('dow-row');
        const body = document.getElementById('table-body');

        while(header.children.length > 1) header.removeChild(header.lastChild);
        while(dowRow.children.length > 1) dowRow.removeChild(dowRow.lastChild);
        body.innerHTML = '';

        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

        // ë‚ ì§œ/ìš”ì¼ í—¤ë” ìƒì„±
        for(let d=1; d<=lastDay; d++) {
            const dt = new Date(year, month, d);
            const dayIdx = dt.getDay();
            const dateKeyShort = `${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; // MM-DD (ì–‘ë ¥)
            const dateKeyFull = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; // YYYY-MM-DD (ìŒë ¥ ë“±)
            
            // ê³µíœ´ì¼ íŒë³„
            const holName = krHolidays[dateKeyShort] || krHolidays[dateKeyFull];
            const isRed = dayIdx === 0 || holName;

            let th = document.createElement('th'); 
            th.innerText = d; 
            if(isRed) th.className = 'day-holiday';
            if(holName) th.title = holName; // íˆ´íŒìœ¼ë¡œ ê³µíœ´ì¼ ì´ë¦„ í‘œì‹œ
            if(dayIdx===6 && !isRed) th.className = 'day-sat';
            header.appendChild(th);

            let td = document.createElement('th'); 
            td.innerText = days[dayIdx];
            if(isRed) td.className = 'day-holiday';
            if(dayIdx===6 && !isRed) td.className = 'day-sat';
            dowRow.appendChild(td);
        }

        // ë³¸ë¬¸ í–‰ ìƒì„±
        items.forEach(item => {
            let tr = document.createElement('tr');
            
            // í–‰ ìƒ‰ìƒ êµ¬ë¶„
            if(item.group === 'mood') {
                if(item.id.includes('p')) tr.classList.add('bg-mania');
                else if(item.id.includes('m')) tr.classList.add('bg-dep');
            }

            // ì²« ì—´ (ë¼ë²¨)
            let th = document.createElement('th');
            th.className = 'col-label tooltip-target';
            th.innerText = item.label;
            th.setAttribute('data-tip', item.desc);
            tr.appendChild(th);

            // ë°ì´í„° ì…€ ìƒì„±
            for(let d=1; d<=lastDay; d++) {
                const dt = new Date(year, month, d);
                const dayIdx = dt.getDay();
                let td = document.createElement('td');
                
                // ì¼ìš”ì¼ êµ¬ë¶„ì„  ì ìš©
                if(dayIdx === 0) td.style.borderRight = "2px solid #555"; 

                td.dataset.d = d; td.dataset.c = item.id; td.dataset.g = item.group;

                // 1. ê¸°ë¶„ ì²´í¬ (Exclusive Checkbox)
                if(item.group === 'mood') {
                    td.className = 'cell-check';
                    td.onclick = () => {
                        if(user.role === 'doctor') return;
                        const siblings = document.querySelectorAll(`td[data-d="${d}"][data-g="mood"]`);
                        siblings.forEach(sib => sib.classList.remove('checked'));
                        td.classList.add('checked');
                        saveData(d, item.id, 'Y', 'mood'); 
                    };
                }
                // 2. ì²™ë„ ì„ íƒ (-4 ~ +4)
                else if(item.group === 'scale') {
                    let sel = createSelect(-4, 4);
                    sel.onchange = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(sel);
                }
                // 3. ìˆ˜ë©´ ì‹œê°„ (0 ~ 24)
                else if(item.group === 'val_sleep') {
                    let sel = createSelect(0, 24);
                    sel.onchange = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(sel);
                }
                // 4. ì²´ì¤‘ (ì¼ìš”ì¼ë§Œ)
                else if(item.group === 'val_weight') {
                    let inp = document.createElement('input');
                    inp.type = 'number'; inp.className = 'cell-input';
                    if(dayIdx !== 0) { // ì¼ìš”ì¼ ì•„ë‹ˆë©´ ë¹„í™œì„±
                        td.classList.add('disabled-cell');
                        inp.disabled = true;
                    } else {
                        inp.onblur = (e) => saveData(d, item.id, e.target.value);
                    }
                    td.appendChild(inp);
                }
                // 5. ì¼ë°˜ ì²´í¬ë°•ìŠ¤
                else if(item.group === 'chk') {
                    td.className = 'cell-check';
                    td.onclick = () => {
                        if(user.role === 'doctor') return;
                        let val = td.classList.toggle('checked') ? 'Y' : null;
                        saveData(d, item.id, val);
                    };
                }
                // 6. í…ìŠ¤íŠ¸ (ìƒí™œì‚¬ê±´)
                else if(item.group === 'text') {
                    td.className = 'cell-text';
                    let inp = document.createElement('input');
                    inp.onblur = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(inp);
                }
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });

        if(target) loadData();
    }

    // í—¬í¼: Select ë°•ìŠ¤ ìƒì„±
    function createSelect(min, max) {
        let s = document.createElement('select');
        s.className = 'cell-select';
        let def = document.createElement('option'); def.text='-'; def.value=''; s.add(def);
        for(let i=min; i<=max; i++) {
            let o = document.createElement('option'); o.text=i; o.value=i; s.add(o);
        }
        return s;
    }

    // --- ë°ì´í„° ì €ì¥/ë¡œë“œ ---
    async function saveData(day, cat, val, group) {
        if(user.role==='doctor') return;
        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const date = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        
        // ê¸°ë¶„(Mood) ê·¸ë£¹ì¼ ê²½ìš°: í•´ë‹¹ ë‚ ì§œì˜ ë‹¤ë¥¸ ê¸°ë¶„ ê¸°ë¡ ë¨¼ì € ì‚­ì œ (Exclusive Logic)
        if(group === 'mood' && val === 'Y') {
            const moodCats = items.filter(i=>i.group==='mood').map(i=>i.id);
            await sb.from('mood_records').delete().eq('username', user.username).eq('record_date', date).in('category', moodCats);
        }

        if(!val) await sb.from('mood_records').delete().match({username:user.username, record_date:date, category:cat});
        else await sb.from('mood_records').upsert({username:user.username, record_date:date, category:cat, value:val});
    }

    async function loadData() {
        if(user.role==='doctor') target = document.getElementById('search-id').value;
        if(!target) return;

        // ì´ˆê¸°í™”
        document.querySelectorAll('.checked').forEach(e=>e.classList.remove('checked'));
        document.querySelectorAll('input, select').forEach(e => { if(!e.id.includes('search') && !e.id.includes('date')) e.value=''; });

        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const lastDay = new Date(y, m, 0).getDate();
        const start = `${y}-${String(m).padStart(2,'0')}-01`;
        const end = `${y}-${String(m).padStart(2,'0')}-${lastDay}`;

        const { data } = await sb.from('mood_records').select('*').eq('username',target).gte('record_date',start).lte('record_date',end);
        
        data?.forEach(rec => {
            const day = new Date(rec.record_date).getDate();
            const cell = document.querySelector(`td[data-d="${day}"][data-c="${rec.category}"]`);
            if(cell) {
                if(cell.classList.contains('cell-check')) {
                    if(rec.value === 'Y') cell.classList.add('checked');
                } else if(cell.querySelector('select')) {
                    cell.querySelector('select').value = rec.value;
                } else if(cell.querySelector('input')) {
                    cell.querySelector('input').value = rec.value;
                }
            }
        });
    }

    // --- ìœ í‹¸ë¦¬í‹° ê¸°ëŠ¥ ---
    function moveMonth(n) { curDate.setMonth(curDate.getMonth() + n); renderTable(); }
    function jumpToDate(dateStr) { curDate = new Date(dateStr); renderTable(); }

    // ë°ì´í„° ë‹¤ìš´ë¡œë“œ
    async function exportData() {
        if(user.role === 'doctor') return alert("ì˜ë£Œì§„ì€ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        const { data, error } = await sb.from('mood_records').select('*').eq('username', user.username).order('record_date');
        if(error || !data.length) return alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");

        let csvContent = "data:text/csv;charset=utf-8,Date,Category,Value\n";
        data.forEach(row => { csvContent += `${row.record_date},${row.category},"${row.value}"\n`; });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `mood_data_${user.username}.csv`);
        document.body.appendChild(link);
        link.click();
    }

    // ë°ì´í„° ì—…ë¡œë“œ
    async function importData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            const text = e.target.result;
            const rows = text.split("\n").slice(1);
            let upsertData = [];
            
            rows.forEach(row => {
                const cols = row.split(",");
                if(cols.length >= 3) {
                    const rDate = cols[0].trim();
                    const rCat = cols[1].trim();
                    const rVal = cols[2].replace(/"/g, '').trim();
                    if(rDate && rCat) {
                        upsertData.push({ username: user.username, record_date: rDate, category: rCat, value: rVal });
                    }
                }
            });

            if(upsertData.length > 0) {
                for (let i = 0; i < upsertData.length; i += 100) {
                    const chunk = upsertData.slice(i, i + 100);
                    await sb.from('mood_records').upsert(chunk);
                }
                alert("ë°ì´í„° ë³µì› ì™„ë£Œ. í™”ë©´ì„ ê°±ì‹ í•©ë‹ˆë‹¤.");
                loadData();
            }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
