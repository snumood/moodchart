<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>ê¸°ë¶„ê¸°ë¡ì§€ 2.2 | ë¶„ë‹¹ì„œìš¸ëŒ€í•™êµë³‘ì›</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

<style>
    /* --- ë””ìì¸ ì‹œìŠ¤í…œ --- */
    :root { 
        --primary: #005eb8; 
        --primary-dark: #004a94;
        --today-bg: #fffde7; 
        --today-border: #d50000;
        --text: #2c3e50;
        --bg-main: #f0f2f5;
        --bg-white: #ffffff;
        --border: #ccc;
        
        --bg-block-mood: #fff5f5;   
        --bg-block-scale: #fffdeb;  
        --bg-block-body: #e8f5e9;   
        --bg-block-event: #ffffff;  
        
        --header-h: 46px;      
        --top-bar-h: 42px; 
        --cell-h: 30px;        
        --col-w: 160px; 
        --date-w: 42px;
    }

    /* í…Œë§ˆ */
    [data-theme="pink"] { --primary: #d81b60; --bg-main: #fce4ec; --bg-block-mood: #ffcdd2; --bg-block-scale: #e1bee7; --bg-block-body: #f8bbd0; }
    [data-theme="green"] { --primary: #2e7d32; --bg-main: #e8f5e9; --bg-block-mood: #c8e6c9; --bg-block-scale: #dcedc8; --bg-block-body: #b9f6ca; }
    [data-theme="dark"] { --primary: #90caf9; --text: #eeeeee; --bg-main: #121212; --bg-white: #1e1e1e; --border: #444; --bg-block-mood: #263238; --bg-block-scale: #37474f; --bg-block-body: #212121; --bg-block-event: #212121; }

    body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; margin: 0; background: var(--bg-main); color: var(--text); font-size: 11px; overflow: hidden; height: 100dvh; position: relative; }
    .hidden { display: none !important; }
    input, button, select, textarea { outline: none; font-family: inherit; font-size: inherit; }
    a { text-decoration: none; color: inherit; }
    * { box-sizing: border-box; }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #auth-screen { 
        height: 100dvh; display: flex; justify-content: center; align-items: center; 
        position: fixed; width: 100%; z-index: 9999; top: 0; left: 0;
        background: url('https://github.com/snumood/moodchart/blob/main/bg.jpg?raw=true') no-repeat center center fixed;
        background-size: cover;
    }
    #auth-screen::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: -1; }
    .auth-box { width: 420px; padding: 30px; background: rgba(255, 255, 255, 0.95); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; }
    .auth-inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px; }
    .save-login-wrap { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin: 10px 0; align-items: center; }
    .warning-text { color: #d32f2f; font-weight: bold; font-size: 11px; }
    .toggle-auth { margin-top: 20px; font-size: 13px; color: #555; cursor: pointer; text-decoration: underline; display: inline-block; }
    .legal-text { text-align: left; font-size: 12px; margin: 15px 0; background: #f1f3f5; padding: 12px; border-radius: 6px; color: #444; line-height: 1.5; word-break: keep-all; border: 1px solid #eee; }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .container { height: 100dvh; display: flex; flex-direction: column; background: var(--bg-white); position: relative; }
    
    /* í—¤ë” */
    .header { height: var(--header-h); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; background: var(--bg-white); border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .month-nav { font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .btn-nav { background: var(--bg-white); border: 1px solid var(--border); color: var(--text); padding: 0 8px; cursor: pointer; border-radius: 4px; font-size: 12px; height: 28px; display: flex; align-items: center; justify-content: center; }
    #date-picker { border: 1px solid var(--border); background: var(--bg-white); color: var(--text); padding: 0 5px; border-radius: 4px; height: 28px; font-size: 13px; cursor: pointer; width: 115px; }
    .btn-menu { font-size: 24px; background: none; border: none; cursor: pointer; color: var(--text); padding: 0 5px; }

    /* ì›”ê°„ í‰ê°€ ë°” & ë°°ì§€ ì˜ì—­ */
    .top-assessment-bar { 
        height: var(--top-bar-h); background: var(--bg-main); border-bottom: 1px solid var(--border); 
        display: flex; align-items: center; justify-content: flex-start; gap: 8px; 
        font-size: 12px; flex-shrink: 0; padding: 0 10px; overflow-x: auto; white-space: nowrap; z-index: 90;
    }
    .top-assessment-bar a { font-weight: bold; color: var(--primary); text-decoration: underline; font-size: 11px; }
    .top-assessment-bar input { width: 50px; height: 24px; text-align: center; border: 1px solid var(--border); background: var(--bg-white); color: var(--text); border-radius: 4px; font-size: 12px; padding: 0; font-weight: bold; }
    
    .stat-badge {
        background: #e3f2fd; color: var(--primary); padding: 3px 8px; 
        border-radius: 12px; font-weight: bold; font-size: 11px; 
        border: 1px solid #90caf9; margin-left: 5px; display: flex; align-items: center; gap: 4px;
    }
    .streak-badge { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc80; }
    .badge-icon { font-size: 14px; margin-right: 2px; }

    /* ê·¸ë¦¬ë“œ */
    .grid-wrapper { flex: 1; overflow: auto; background: var(--bg-white); position: relative; scroll-behavior: smooth; }
    
    #sticker-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; overflow: hidden; }
    .sticker-placed { 
        position: absolute; font-size: 28px; cursor: grab; pointer-events: auto; 
        text-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s; user-select: none;
    }
    .sticker-placed:active { transform: scale(1.2); cursor: grabbing; z-index: 100; }

    table { border-collapse: separate; border-spacing: 0; table-layout: fixed; width: max-content; margin-bottom: 50px; }
    th, td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); text-align: center; height: var(--cell-h); padding: 0; vertical-align: middle; width: var(--date-w); min-width: var(--date-w); max-width: var(--date-w); overflow: hidden; white-space: nowrap; transition: background-color 0.2s; }
    thead th { position: sticky; top: 0; background: var(--bg-white); z-index: 10; border-bottom: 2px solid #999; height: 34px; font-weight: 700; color: var(--text); }
    .col-label { position: sticky; left: 0; z-index: 20; width: var(--col-w) !important; min-width: var(--col-w) !important; max-width: var(--col-w) !important; border-right: 2px solid #999; text-align: left; padding-left: 10px; font-weight: 700; font-size: 11px; color: var(--text); background: var(--bg-white); }
    .block-divider td, .block-divider th { border-top: 3px solid #888; } 

    /* ë°°ê²½ ë° ìƒ‰ìƒ */
    .bg-scale { background-color: var(--bg-block-scale); }
    .bg-body { background-color: var(--bg-block-body); }
    .bg-event { background-color: var(--bg-block-event); }
    .today-header { background-color: var(--today-bg) !important; color: #d50000; border: 2px solid var(--today-border) !important; border-bottom: none !important; position: sticky; top: 0; z-index: 15; }
    .today-dow { background-color: var(--today-bg) !important; border-left: 2px solid var(--today-border) !important; border-right: 2px solid var(--today-border) !important; border-bottom: 2px solid var(--today-border) !important; color: #d50000; font-weight: bold; }
    .active-row td { box-shadow: inset 0 0 0 1000px rgba(0, 94, 184, 0.05); } 
    .active-col { box-shadow: inset 0 0 0 1000px rgba(0, 94, 184, 0.05); }
    .day-sun { color: #e53935; background-color: #fff5f5 !important; border-right: 2px solid #888 !important; }
    .day-sat { color: #1e88e5; background-color: #f0f8ff !important; }
    .day-holiday { color: #e53935 !important; background-color: #ffebee !important; font-weight: bold; }
    [data-theme="dark"] .day-sun { background-color: #3e2723 !important; color: #ffab91; }
    [data-theme="dark"] .day-sat { background-color: #263238 !important; color: #90caf9; }
    [data-theme="dark"] .day-holiday { background-color: #3e2723 !important; color: #ffab91; }

    .cell-check { cursor: pointer; color: #ccc; font-size: 14px; }
    .cell-check.checked { font-weight: 900; color: var(--text); font-size: 16px; }
    .cell-check.checked::after { content: "âœ”"; }
    .cell-mixed { font-size: 14px; color: #ccc; pointer-events: none; }
    .cell-mixed.checked { color: #7b1fa2; font-weight: bold; }
    .cell-mixed.checked::after { content: "âœ”"; }
    .cell-select { width: 100%; height: 100%; border: none; background: transparent; color:var(--text); text-align-last: center; -webkit-appearance: none; cursor: pointer; font-weight: 600; font-size: 11px; padding: 0; margin: 0; }
    .cell-input { width: 100%; height: 100%; border: none; background: transparent; color:var(--text); text-align: center; font-size: 11px; padding: 0; margin: 0; min-width: 0; }
    .cell-event { cursor: pointer; text-align: left; padding: 0 5px; color: var(--primary); font-size: 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .disabled-cell { background-color: #eee !important; pointer-events: none; }
    .cell-icon { cursor: pointer; font-size: 18px; line-height: 1; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* í”Œë¡œíŒ… í™”ì‚´í‘œ */
    .scroll-arrow { position: absolute; width: 36px; height: 36px; border-radius: 50%; background: rgba(0, 94, 184, 0.6); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; pointer-events: none; z-index: 900; opacity: 0; transition: opacity 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); animation: floatArrow 1.5s infinite ease-in-out; }
    .scroll-arrow.visible { opacity: 1; }
    .arrow-down { bottom: 80px; left: 50%; transform: translateX(-50%); } 
    .arrow-right { top: 50%; right: 15px; transform: translateY(-50%); animation-name: floatArrowH; }
    @keyframes floatArrow { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, 5px); } }
    @keyframes floatArrowH { 0%, 100% { transform: translate(0, -50%); } 50% { transform: translate(5px, -50%); } }

    /* ìŠ¤í‹°ì»¤ ê°€ë°© FAB */
    #sticker-btn { 
        position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; border-radius: 50%; 
        background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; font-size: 28px; 
        display: flex; align-items: center; justify-content: center; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 1000; border: 2px solid #fff;
        transition: transform 0.2s;
    }
    #sticker-btn:active { transform: scale(0.9); }
    #sticker-inventory {
        position: fixed; bottom: 90px; right: 20px; width: 300px; 
        background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
        padding: 15px; display: none; z-index: 1000;
        max-height: 350px; overflow-y: auto;
    }
    #sticker-inventory.show { display: block; }
    .sticker-list { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; }
    .inv-item { font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 4px; transition: 0.2s; }
    .inv-item:hover { background: #f0f0f0; transform: scale(1.2); }

    /* ì‚¬ì´ë“œë°”, ëª¨ë‹¬ */
    #sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: var(--bg-white); box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; transition: right 0.3s ease; display: flex; flex-direction: column; color: var(--text); }
    #sidebar.open { right: 0; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: flex-end; align-items: center; background: var(--primary); color: white; height: 50px; }
    .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1500; display: none; }
    .sidebar-overlay.show { display: block; }
    .menu-section { margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
    .menu-title { font-weight: bold; font-size: 13px; color: #666; margin-bottom: 10px; }
    .menu-item { display: block; padding: 10px 0; font-size: 13px; color: var(--text); cursor: pointer; }
    .menu-item:hover { color: var(--primary); font-weight: bold; }
    .user-badge { background: var(--bg-block-mood); color: var(--primary); padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 10px; border: 1px solid var(--primary); }
    
    .theme-select-wrap { display: flex; flex-direction: column; gap: 8px; }
    .theme-btn { padding: 10px; border: 1px solid #ddd; border-radius: 6px; text-align: left; cursor: pointer; font-size: 12px; background: #fff; color: #333; display: flex; align-items: center; gap: 8px; }
    .theme-btn.locked { opacity: 0.5; cursor: not-allowed; background: #eee; }
    .theme-color-preview { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
    .theme-btn.active { border: 2px solid var(--primary); font-weight: bold; }

    #doc-panel { display: none; margin-bottom: 15px; background: var(--bg-block-scale); padding: 10px; border-radius: 8px; }
    #doc-panel.active { display: block; }
    #doc-panel input { width: 70%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
    #doc-panel button { width: 25%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; }

    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: var(--bg-white); color: var(--text); padding: 25px; border-radius: 12px; width: 90%; max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .icon-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; max-height: 120px; overflow-y: auto; margin-bottom: 15px; padding: 5px; border: 1px solid #eee; border-radius: 8px; }
    .icon-item { cursor: pointer; font-size: 20px; text-align: center; padding: 4px; border-radius: 4px; transition: background 0.2s; }
    .icon-item:hover { background-color: #f0f0f0; }
    .icon-item.selected { background-color: #e3f2fd; border: 1px solid var(--primary); }

    .chart-modal-content { background: var(--bg-white); color: var(--text); padding: 20px; border-radius: 20px; width: 95%; height: 80%; max-width: 800px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
    .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
    .modal-header { font-weight: bold; margin-bottom: 15px; font-size: 15px; display: flex; justify-content: space-between; color: var(--primary); }
    .modal-textarea { width: 100%; height: 120px; border: 1px solid var(--border); padding: 10px; resize: none; border-radius: 6px; font-size: 13px; background: var(--bg-white); color: var(--text); }
    .modal-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: var(--bg-white); color: var(--text); }
    .modal-btns { text-align: right; margin-top: 10px; }
    .btn-modal { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-save { background: var(--primary); color: white; }
    .btn-cancel { background: #eee; color: #333; margin-right: 5px; }

    .tooltip-target:hover::after { content: attr(data-tip); position: fixed; left: 190px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; width: 250px; font-size: 12px; z-index: 9999; pointer-events: none; white-space: pre-wrap; text-align: left; }
    .tooltip-target[data-tip=""]:hover::after { display: none; }

    @media (max-width: 768px) {
        :root { --col-w: 130px; }
    }
</style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">ê¸°ë¶„ê¸°ë¡ì§€ 2.1</h2>
        <div id="login-form">
            <input id="l-id" class="auth-inp" placeholder="ì•„ì´ë””">
            <input id="l-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div class="save-login-wrap">
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px;"><input type="checkbox" id="remember-me"> ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥</label>
                <div class="warning-text">â€»ê³µìš©ê¸°ê¸°ì—ì„œ ë¹„ë°€ë²ˆí˜¸ìœ ì¶œì£¼ì˜</div>
            </div>
            <button class="btn-auth" onclick="login()">ë¡œê·¸ì¸</button>
            <span class="toggle-auth" onclick="toggleAuth('join')">íšŒì›ê°€ì…</span>
        </div>
        <div id="join-form" class="hidden">
            <input id="j-id" class="auth-inp" placeholder="í¬ë§ ì•„ì´ë””">
            <input id="j-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input id="j-hosp" class="auth-inp" placeholder="ë“±ë¡ë²ˆí˜¸ ë˜ëŠ” ì´ë‹ˆì…œ+ìƒë…„ì›”ì¼ (í•„ìˆ˜)">
            <div style="font-size:11px; color:#666; text-align:left; margin-bottom:5px;">ì˜ˆ: 43445678 ë˜ëŠ” HGD19990305</div>
            <div class="legal-text">
                ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš©ì´ ì•„ë‹ˆë©° ëª¨ë“  ì‚¬ìš© ì±…ì„ì€ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ ë° ë¯¼ê°ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”. ìµëª… í”„ë¡œê·¸ë¨ì´ë¯€ë¡œ ê³„ì •ì„ ë¶„ì‹¤í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </div>
            <label style="font-size:12px; cursor:pointer; display:block; text-align:left; margin-bottom:15px;"><input type="checkbox" id="j-agree"> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.</label>
            <button class="btn-auth" style="background:#28a745;" onclick="join()">ê°€ì…ì™„ë£Œ</button>
            <span class="toggle-auth" onclick="toggleAuth('login')">ëŒì•„ê°€ê¸°</span>
        </div>
    </div>
</div>

<div id="main-screen" class="hidden">
    <div class="container">
        <div class="header">
            <div class="month-nav">
                <button class="btn-nav" onclick="moveMonth(-1)">â—€</button>
                <input type="date" id="date-picker" onchange="jumpToDate(this.value)">
                <button class="btn-nav" onclick="moveMonth(1)">â–¶</button>
            </div>
            <button class="btn-menu" onclick="toggleSidebar()">â˜°</button>
        </div>

        <div class="top-assessment-bar">
            <a href="https://snumood.github.io/homepage/ls.html" target="_blank">ì›”ê°„ìƒí™œìŠµê´€ì ìˆ˜</a>
            <input id="score-ls" type="number" inputmode="decimal" placeholder="ì " min="0" onchange="checkMin(this)" onblur="saveMonthlyScore('ls', this.value)">
            <span style="color:#ddd">|</span>
            <a href="https://snumood.github.io/homepage/mssi.html" target="_blank">ê¸°ë¶„ì•ˆì •ì„±í‰ê°€ì ìˆ˜</a>
            <input id="score-mssi" type="number" inputmode="decimal" placeholder="ì " min="0" onchange="checkMin(this)" onblur="saveMonthlyScore('mssi', this.value)">
            
            <div style="display:flex; gap:5px; margin-left:8px;">
                <span id="total-days-display" class="stat-badge">ê´€ì°° 0ì¼</span>
                <span id="streak-display" class="stat-badge streak-badge hidden">ì—°ì† 0ì¼</span>
                <span id="badge-container"></span>
            </div>
        </div>

        <div class="grid-wrapper" id="grid-container">
            <div id="sticker-layer"></div>
            <table id="mood-table">
                <thead>
                    <tr id="header-row"><th class="col-label">í•­ëª© / ë‚ ì§œ</th></tr>
                    <tr id="dow-row"><th class="col-label" style="background:var(--bg-white);">ìš”ì¼</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
            <div style="height: 100px;"></div>
        </div>

        <div id="arrow-down" class="scroll-arrow arrow-down">â–¼</div>
        <div id="arrow-right" class="scroll-arrow arrow-right">â–¶</div>
        
        <div id="sticker-btn" onclick="toggleStickerInventory()">ğŸ’</div>
        <div id="sticker-inventory">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span style="font-weight:bold;">âœ¨ ë³´ìƒ ìŠ¤í‹°ì»¤ë¶</span>
                <span style="cursor:pointer;" onclick="toggleStickerInventory()">âœ•</span>
            </div>
            <div style="font-size:11px; color:#666; margin-bottom:10px;">ì›”ê°„ ì ìˆ˜ë¥¼ ì…ë ¥í•˜ë©´ í¬ê·€í•œ ìŠ¤í‹°ì»¤ê°€ ë‚˜ì™€ìš”! (ë§¤ì£¼ 1íšŒ íšë“)</div>
            <div id="sticker-list-container"></div>
        </div>
    </div>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
    <div class="sidebar-header"><span style="cursor:pointer; font-size:20px; font-weight:bold;" onclick="toggleSidebar()">âœ•</span></div>
    <div class="sidebar-content">
        <div class="user-badge" id="user-badge"></div>
        <div id="doc-panel">
            <div style="font-weight:bold; margin-bottom:5px; color:#1565c0;">í™˜ì ì¡°íšŒ</div>
            <div style="display:flex; justify-content:space-between;"><input id="search-id" placeholder="ID ë˜ëŠ” ë²ˆí˜¸"><button onclick="searchPatient()">ê²€ìƒ‰</button></div>
        </div>
        <div class="menu-section">
            <div class="menu-title">ğŸ¨ í…Œë§ˆ ì„¤ì • (ê¸°ë¡ ë³´ìƒ)</div>
            <div class="theme-select-wrap">
                <div class="theme-btn active" onclick="setTheme('default')" id="theme-default"><span class="theme-color-preview" style="background:#005eb8;"></span> ê¸°ë³¸ (ë¶„ë‹¹ ë¸”ë£¨)</div>
                <div class="theme-btn locked" onclick="setTheme('pink')" id="theme-pink"><span class="theme-color-preview" style="background:#d81b60;"></span> ğŸ”’ 30ì¼: ë¡œë§¨í‹± í•‘í¬</div>
                <div class="theme-btn locked" onclick="setTheme('green')" id="theme-green"><span class="theme-color-preview" style="background:#2e7d32;"></span> ğŸ”’ 180ì¼: íë§ í¬ë ˆìŠ¤íŠ¸</div>
                <div class="theme-btn locked" onclick="setTheme('dark')" id="theme-dark"><span class="theme-color-preview" style="background:#424242;"></span> ğŸ”’ 365ì¼: ëª¨ë˜ ë‹¤í¬</div>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-title">ë¶„ì„ ë¦¬í¬íŠ¸</div>
            <div class="menu-item" onclick="openChartModal('ls')">ğŸ“Š ì›”ê°„ìƒí™œìŠµê´€ì ìˆ˜ ì¶”ì„¸ë³´ê¸°</div>
            <div class="menu-item" onclick="openChartModal('mssi')">ğŸ“ˆ ê¸°ë¶„ì•ˆì •ì„±í‰ê°€ì ìˆ˜ ì¶”ì„¸ë³´ê¸°</div>
        </div>
        <div class="menu-section"><div class="menu-title">ê³„ì • ê´€ë¦¬</div><div class="menu-item" onclick="openPwModal()">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div><div class="menu-item" onclick="doLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div></div>
        <div class="menu-section"><div class="menu-title">ë°ì´í„° ê´€ë¦¬</div><div class="menu-item" onclick="exportData()">ğŸ’¾ ëª¨ë“  ê¸°ë¡ì„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</div><input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importData(this)"><div class="menu-item" onclick="document.getElementById('import-file').click()">ğŸ“‚ íŒŒì¼ì„ ê¸°ë¡ìœ¼ë¡œ ì—…ë¡œë“œ (ì´ì „ê¸°ë¡ì‚­ì œ)</div></div>
        <div class="menu-section"><div class="menu-title">ì•ˆë‚´</div><a href="https://drive.google.com/file/d/1UKEOr5OjR42Ipv64zL1FsI8XPLvz3QhI/view?usp=sharing" target="_blank" class="menu-item">ğŸ“– ê¸°ë¶„ê¸°ë¡ì§€ ì‘ì„±ë°©ë²• ë³´ê¸°</a></div>
        <div style="font-size:10px; color:#999; line-height:1.4; margin-top:20px;">ë³¸ í”„ë¡œê·¸ë¨ì€ ì˜ë£Œìš©ì´ ì•„ë‹ˆë©° ì‚¬ìš© ì±…ì„ì€ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤.</div>
    </div>
</div>

<div id="event-modal" class="modal-wrap">
    <div class="modal-content">
        <div class="modal-header"><span id="modal-title"></span><span style="cursor:pointer;" onclick="closeEventModal()">âœ•</span></div>
        <div id="icon-container" class="icon-grid"></div><input type="hidden" id="selected-icon">
        <textarea id="modal-text" class="modal-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="closeEventModal()">ì·¨ì†Œ</button><button class="btn-modal btn-save" onclick="saveEventFromModal()">ì €ì¥í•˜ê¸°</button></div>
    </div>
</div>
<div id="pw-modal" class="modal-wrap">
    <div class="modal-content">
        <div class="modal-header"><span>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span><span style="cursor:pointer;" onclick="closePwModal()">âœ•</span></div>
        <input type="password" id="pw-old" class="modal-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"><input type="password" id="pw-new" class="modal-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"><input type="password" id="pw-cfm" class="modal-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="closePwModal()">ì·¨ì†Œ</button><button class="btn-modal btn-save" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button></div>
    </div>
</div>
<div id="chart-modal" class="modal-wrap"><div class="chart-modal-content"><div class="modal-header"><span id="chart-title">ì¶”ì„¸ ê·¸ë˜í”„</span><span style="cursor:pointer; font-size:20px;" onclick="closeChartModal()">âœ•</span></div><div class="chart-container"><canvas id="scoreChart"></canvas></div></div></div>

<script>
    const SUPABASE_URL = 'https://vzybcxvwpqhdmrxbxzmq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bAlzb9dPdxb5lpzudvqwHQ_MxpUVkNj';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function hashPassword(str) {
        const msgBuffer = new TextEncoder().encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const krHolidays = {
        '01-01': 'ì‹ ì •', '03-01': 'ì‚¼ì¼ì ˆ', '05-05': 'ì–´ë¦°ì´ë‚ ', '06-06': 'í˜„ì¶©ì¼', '07-17': 'ì œí—Œì ˆ', '08-15': 'ê´‘ë³µì ˆ', '10-03': 'ê°œì²œì ˆ', '10-09': 'í•œê¸€ë‚ ', '12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        '2025-01-28':'ì„¤ë‚ ', '2025-01-29':'ì„¤ë‚ ', '2025-01-30':'ì„¤ë‚ ', '2025-03-03':'ëŒ€ì²´ê³µíœ´ì¼', '2025-05-06':'ëŒ€ì²´ê³µíœ´ì¼', '2025-10-05':'ì¶”ì„', '2025-10-06':'ì¶”ì„', '2025-10-07':'ì¶”ì„', '2025-10-08':'ëŒ€ì²´ê³µíœ´ì¼',
        '2026-02-16':'ì„¤ë‚ ', '2026-02-17':'ì„¤ë‚ ', '2026-02-18':'ì„¤ë‚ ', '2026-03-02':'ëŒ€ì²´ê³µíœ´ì¼', '2026-05-24':'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25':'ëŒ€ì²´ê³µíœ´ì¼', '2026-06-03':'ì§€ë°©ì„ ê±°', '2026-08-17':'ëŒ€ì²´ê³µíœ´ì¼', '2026-09-24':'ì¶”ì„', '2026-09-25':'ì¶”ì„', '2026-09-26':'ì¶”ì„', '2026-10-05':'ëŒ€ì²´ê³µíœ´ì¼',
        '2027-02-06':'ì„¤ë‚ ', '2027-02-07':'ì„¤ë‚ ', '2027-02-08':'ì„¤ë‚ ', '2027-02-09':'ëŒ€ì²´ê³µíœ´ì¼', '2027-03-03':'ëŒ€í†µë ¹ì„ ê±°', '2027-05-13':'ì„ê°€íƒ„ì‹ ì¼', '2027-08-16':'ëŒ€ì²´ê³µíœ´ì¼', '2027-09-14':'ì¶”ì„', '2027-09-15':'ì¶”ì„', '2027-09-16':'ì¶”ì„', '2027-10-04':'ëŒ€ì²´ê³µíœ´ì¼', '2027-10-11':'ëŒ€ì²´ê³µíœ´ì¼', '2027-12-27':'ëŒ€ì²´ê³µíœ´ì¼',
        '2028-01-26':'ì„¤ë‚ ', '2028-01-27':'ì„¤ë‚ ', '2028-01-28':'ì„¤ë‚ ', '2028-04-12':'êµ­íšŒì˜ì›ì„ ê±°', '2028-05-02':'ì„ê°€íƒ„ì‹ ì¼', '2028-10-02':'ì¶”ì„', '2028-10-03':'ê°œì²œì ˆ', '2028-10-04':'ì¶”ì„', '2028-10-05':'ëŒ€ì²´ê³µíœ´ì¼',
        '2029-02-12':'ì„¤ë‚ ', '2029-02-13':'ì„¤ë‚ ', '2029-02-14':'ì„¤ë‚ ', '2029-05-20':'ì„ê°€íƒ„ì‹ ì¼', '2029-05-21':'ëŒ€ì²´ê³µíœ´ì¼', '2029-09-21':'ì¶”ì„', '2029-09-22':'ì¶”ì„', '2029-09-23':'ì¶”ì„', '2029-09-24':'ëŒ€ì²´ê³µíœ´ì¼',
        '2030-02-02':'ì„¤ë‚ ', '2030-02-03':'ì„¤ë‚ ', '2030-02-04':'ì„¤ë‚ ', '2030-02-05':'ëŒ€ì²´ê³µíœ´ì¼', '2030-05-05':'ì–´ë¦°ì´ë‚ ', '2030-05-06':'ëŒ€ì²´ê³µíœ´ì¼', '2030-05-09':'ì„ê°€íƒ„ì‹ ì¼', '2030-06-05':'ì§€ë°©ì„ ê±°', '2030-09-11':'ì¶”ì„', '2030-09-12':'ì¶”ì„', '2030-09-13':'ì¶”ì„',
        '2031-01-22':'ì„¤ë‚ ', '2031-01-23':'ì„¤ë‚ ', '2031-01-24':'ì„¤ë‚ ', '2031-05-28':'ì„ê°€íƒ„ì‹ ì¼', '2031-09-30':'ì¶”ì„', '2031-10-01':'ì¶”ì„', '2031-10-02':'ì¶”ì„',
        '2032-02-10':'ì„¤ë‚ ', '2032-02-11':'ì„¤ë‚ ', '2032-02-12':'ì„¤ë‚ ', '2032-03-03':'ëŒ€í†µë ¹ì„ ê±°', '2032-04-14':'êµ­íšŒì˜ì›ì„ ê±°', '2032-05-16':'ì„ê°€íƒ„ì‹ ì¼', '2032-05-17':'ëŒ€ì²´ê³µíœ´ì¼', '2032-08-16':'ëŒ€ì²´ê³µíœ´ì¼', '2032-09-18':'ì¶”ì„', '2032-09-19':'ì¶”ì„', '2032-09-20':'ì¶”ì„', '2032-09-21':'ëŒ€ì²´ê³µíœ´ì¼', '2032-10-04':'ëŒ€ì²´ê³µíœ´ì¼',
        '2033-01-30':'ì„¤ë‚ ', '2033-01-31':'ì„¤ë‚ ', '2033-02-01':'ì„¤ë‚ ', '2033-05-06':'ì„ê°€íƒ„ì‹ ì¼', '2033-08-16':'ëŒ€ì²´ê³µíœ´ì¼', '2033-10-06':'ì¶”ì„', '2033-10-07':'ì¶”ì„', '2033-10-08':'ì¶”ì„', '2033-10-10':'ëŒ€ì²´ê³µíœ´ì¼', '2033-12-26':'ëŒ€ì²´ê³µíœ´ì¼',
        '2034-02-18':'ì„¤ë‚ ', '2034-02-19':'ì„¤ë‚ ', '2034-02-20':'ì„¤ë‚ ', '2034-02-21':'ëŒ€ì²´ê³µíœ´ì¼', '2034-05-25':'ì„ê°€íƒ„ì‹ ì¼', '2034-06-07':'ì§€ë°©ì„ ê±°', '2034-09-26':'ì¶”ì„', '2034-09-27':'ì¶”ì„', '2034-09-28':'ì¶”ì„',
        '2035-02-07':'ì„¤ë‚ ', '2035-02-08':'ì„¤ë‚ ', '2035-02-09':'ì„¤ë‚ ', '2035-05-15':'ì„ê°€íƒ„ì‹ ì¼', '2035-09-15':'ì¶”ì„', '2035-09-16':'ì¶”ì„', '2035-09-17':'ì¶”ì„', '2035-09-18':'ëŒ€ì²´ê³µíœ´ì¼',
        '2036-01-27':'ì„¤ë‚ ', '2036-01-28':'ì„¤ë‚ ', '2036-01-29':'ì„¤ë‚ ', '2036-04-09':'êµ­íšŒì˜ì›ì„ ê±°', '2036-05-02':'ì„ê°€íƒ„ì‹ ì¼', '2036-10-03':'ê°œì²œì ˆ', '2036-10-04':'ì¶”ì„', '2036-10-05':'ì¶”ì„', '2036-10-06':'ëŒ€ì²´ê³µíœ´ì¼',
        '2037-02-14':'ì„¤ë‚ ', '2037-02-15':'ì„¤ë‚ ', '2037-02-16':'ì„¤ë‚ ', '2037-02-17':'ëŒ€ì²´ê³µíœ´ì¼', '2037-03-04':'ëŒ€í†µë ¹ì„ ê±°', '2037-05-22':'ì„ê°€íƒ„ì‹ ì¼', '2037-08-17':'ëŒ€ì²´ê³µíœ´ì¼', '2037-09-23':'ì¶”ì„', '2037-09-24':'ì¶”ì„', '2037-09-25':'ì¶”ì„', '2037-10-05':'ëŒ€ì²´ê³µíœ´ì¼',
        '2038-02-03':'ì„¤ë‚ ', '2038-02-04':'ì„¤ë‚ ', '2038-02-05':'ì„¤ë‚ ', '2038-05-11':'ì„ê°€íƒ„ì‹ ì¼', '2038-06-02':'ì§€ë°©ì„ ê±°', '2038-08-16':'ëŒ€ì²´ê³µíœ´ì¼', '2038-09-12':'ì¶”ì„', '2038-09-13':'ì¶”ì„', '2038-09-14':'ì¶”ì„', '2038-09-15':'ëŒ€ì²´ê³µíœ´ì¼', '2038-10-04':'ëŒ€ì²´ê³µíœ´ì¼', '2038-10-11':'ëŒ€ì²´ê³µíœ´ì¼',
        '2039-01-23':'ì„¤ë‚ ', '2039-01-24':'ì„¤ë‚ ', '2039-01-25':'ì„¤ë‚ ', '2039-05-01':'ì„ê°€íƒ„ì‹ ì¼', '2039-05-02':'ëŒ€ì²´ê³µíœ´ì¼', '2039-10-01':'ì¶”ì„', '2039-10-02':'ì¶”ì„', '2039-10-03':'ì¶”ì„', '2039-10-04':'ëŒ€ì²´ê³µíœ´ì¼', '2039-10-10':'ëŒ€ì²´ê³µíœ´ì¼', '2039-12-26':'ëŒ€ì²´ê³µíœ´ì¼',
        '2040-02-11':'ì„¤ë‚ ', '2040-02-12':'ì„¤ë‚ ', '2040-02-13':'ì„¤ë‚ ', '2040-02-14':'ëŒ€ì²´ê³µíœ´ì¼', '2040-04-11':'êµ­íšŒì˜ì›ì„ ê±°', '2040-05-18':'ì„ê°€íƒ„ì‹ ì¼', '2040-09-20':'ì¶”ì„', '2040-09-21':'ì¶”ì„', '2040-09-22':'ì¶”ì„'
    };

    // [ë³´ìƒ ìŠ¤í‹°ì»¤ ë°ì´í„°ë² ì´ìŠ¤]
    const stickerDB = {
        1: ['â­ï¸','â¤ï¸','â˜€ï¸','â˜ï¸','â„ï¸','ğŸ”¥','ğŸ’§','ğŸ€','ğŸµ','ğŸ“·','ğŸ“š','âœï¸','ğŸ§¸','ğŸˆ','ğŸ”‘','ğŸ§©','ğŸª','ğŸš²','ğŸš—','ğŸ '], 
        2: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ'], 
        3: ['ğŸŒ·','ğŸŒ¸','ğŸŒ¹','ğŸŒº','ğŸŒ»','ğŸŒ¼','ğŸŒ½','ğŸŒ¾','ğŸŒ¿','â˜˜ï¸','ğŸ','ğŸ‚','ğŸƒ','ğŸ‡','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ’','ğŸ“','ğŸ¥','ğŸ…','ğŸ¥¥','ğŸ¥‘'], 
        4: ['ğŸ’','ğŸ’','ğŸ‘‘','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸš€','ğŸ›¸','ğŸŒ','ğŸŒ•','ğŸŒˆ','âš¡','ğŸ”®','ğŸ§¿','ğŸª¬','ğŸ§â€â™‚ï¸','ğŸ§œâ€â™€ï¸'] 
    };
    
    // [ì‹œì¦Œ í•œì • ìŠ¤í‹°ì»¤]
    const seasonalStickers = {
        'newyear': ['ğŸŒ…','ğŸ§§','ğŸ‰','ğŸª','ğŸ™‡','ğŸ’°','ğŸ','ğŸŠ','ğŸ‰'],
        'chuseok': ['ğŸŒ•','ğŸ','ğŸŒ°','ğŸ','ğŸ±','ğŸ¦—','ğŸŒ¾','ğŸ¡'],
        'christmas': ['ğŸ„','ğŸ…','ğŸ','ğŸ¦Œ','ğŸ›·','â›„','ğŸ””','ğŸ•¯ï¸','ğŸ‚'],
        'birthday': ['ğŸ‚','ğŸ°','ğŸ','ğŸ¥³','ğŸ•¯ï¸','ğŸˆ','ğŸ‰','ğŸ‘‘'],
        'korea': ['ğŸ‡°ğŸ‡·','ğŸ…','ğŸ»','ğŸœ','ğŸ¥‹']
    };

    const eventIcons = [
        'â˜€ï¸','ğŸŒ¤ï¸','â˜ï¸','ğŸŒ§ï¸','â›ˆï¸','ğŸŒ©ï¸','ğŸŒ¨ï¸','â„ï¸','ğŸŒªï¸','ğŸŒ«ï¸','ğŸŒˆ','â˜”','ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ¤£','ğŸ˜‚','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Š','ğŸ˜‡','ğŸ¥°','ğŸ˜','ğŸ¤©','ğŸ˜˜','ğŸ˜—','â˜ºï¸','ğŸ˜š','ğŸ˜™','ğŸ¥²','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜¶â€ğŸŒ«ï¸','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜Œ','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ˜µâ€ğŸ’«','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ¥¸','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ ','ğŸ«','ğŸ¢','ğŸ¥','ğŸ¦','ğŸª','ğŸ©','ğŸ¨','ğŸ’’','â›ª','ğŸ•Œ','ğŸ›•','ğŸ•','ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›'
    ];
    const medsIcons = ['ğŸ€', 'ğŸŒ¿', 'ğŸŒ±', 'ğŸƒ', 'ğŸŒ¾', 'ğŸŒ·', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ§¡', 'ğŸ’™', 'ğŸ’œ', 'ğŸ¤', 'ğŸ›¡ï¸', 'âœ…', 'â•', 'ğŸ’§', 'ğŸ¥£', 'ğŸµ', 'ğŸ', 'ğŸ‹', 'ğŸ“', 'ğŸ', 'ğŸ¯', 'ğŸ’Š', 'ğŸ’Š', 'ğŸ’Š', 'ğŸ©º', 'ğŸŒ¡ï¸'];
    const exerIcons = ['ğŸƒ', 'ğŸƒâ€â™€ï¸', 'ğŸƒâ€â™‚ï¸', 'ğŸ‘Ÿ', 'ğŸ§—', 'ğŸ§—â€â™€ï¸', 'ğŸ§—â€â™‚ï¸', 'ğŸš´', 'ğŸš´â€â™€ï¸', 'ğŸš´â€â™‚ï¸', 'ğŸ‹ï¸', 'ğŸ‹ï¸â€â™€ï¸', 'ğŸ‹ï¸â€â™‚ï¸', 'ğŸ§˜', 'ğŸ§˜â€â™€ï¸', 'ğŸ§˜â€â™‚ï¸', 'ğŸ¤º', 'ğŸ‡', 'â›·ï¸', 'ğŸ‚', 'ğŸ„', 'ğŸ„â€â™€ï¸', 'ğŸ„â€â™‚ï¸', 'ğŸŠ', 'ğŸŠâ€â™€ï¸', 'ğŸŠâ€â™‚ï¸', 'ğŸš£', 'ğŸš£â€â™€ï¸', 'ğŸš£â€â™‚ï¸', 'ğŸ§—', 'ğŸ’¦', 'ğŸ’ª', 'ğŸ”¥'];

    function getFixedRandomIcon(dateStr, type) {
        const list = type === 'meds' ? medsIcons : exerIcons;
        let hash = 0; for (let i = 0; i < dateStr.length; i++) hash = dateStr.charCodeAt(i) + ((hash << 5) - hash);
        return list[Math.abs(hash) % list.length];
    }

    const items = [
        { id: 'm_p4', label: '+4 ê·¹íˆ ìƒìŠ¹', desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'mood', color: 'rgba(255, 50, 50, 0.3)', type: 'check' },
        { id: 'm_p3', label: '+3 ìƒë‹¹í•œ ìƒìŠ¹', desc: 'ìƒë‹¹í•œ ì§€ì¥, ì£¼ë³€ì—ì„œ í˜ë“¤ì–´í•¨', section: 'mood', color: 'rgba(255, 50, 50, 0.2)', type: 'check' },
        { id: 'm_p2', label: '+2 ë¶„ëª…í•œ ìƒìŠ¹', desc: 'ë‹¤ì†Œ ì§€ì¥, ì „ê³¼ ë‹¤ë¥´ë‹¤ëŠ” ì§€ì ', section: 'mood', color: 'rgba(255, 50, 50, 0.1)', type: 'check' },
        { id: 'm_p1', label: '+1 ë¯¸ì„¸í•œ ìƒìŠ¹', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ë³¸ì¸ì€ ê¸°ë¶„ ì¢‹ìŒ', section: 'mood', color: 'rgba(255, 50, 50, 0.05)', type: 'check' },
        { id: 'm_0',  label: '0  ë³´í†µ ê¸°ë¶„',   desc: 'í‰ì˜¨í•˜ê³  ì •ìƒì ì¸ ìƒíƒœ', section: 'mood', color: '#ffffff', type: 'check' }, 
        { id: 'm_m1', label: '-1 ë¯¸ì„¸í•œ ì €í•˜', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ì˜ìš• ì €í•˜', section: 'mood', color: 'rgba(50, 50, 255, 0.05)', type: 'check' },
        { id: 'm_m2', label: '-2 ë¶„ëª…í•œ ì €í•˜', desc: 'ì¼ìƒì„ ìœ ì§€í•˜ë ¤ ë…¸ë ¥ í•„ìš”', section: 'mood', color: 'rgba(50, 50, 255, 0.1)', type: 'check' },
        { id: 'm_m3', label: '-3 ìƒë‹¹í•œ ì €í•˜', desc: 'ë…¸ë ¥í•´ë„ ê¸°ëŠ¥ì´ ë–¨ì–´ì§', section: 'mood', color: 'rgba(50, 50, 255, 0.2)', type: 'check' },
        { id: 'm_m4', label: '-4 ê·¹íˆ ì €í•˜',   desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'mood', color: 'rgba(50, 50, 255, 0.3)', type: 'check' },
        { id: 'mixed', label: 'í˜¼ì¬ ìƒíƒœ',     desc: 'ìë™ ì²´í¬ë©ë‹ˆë‹¤', section: 'mood', color: '#f3e5f5', type: 'mixed' },
        { id: 's_anx', label: 'ë‘ë ¤ì›€/ì†Œì‹¬í•¨/ê±±ì •/ë¶ˆì•ˆ', desc: '-4 ë„ˆë¬´ ì—†ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_ang', label: 'ì§œì¦/ë¶„ë…¸', desc: '-4 ë„ˆë¬´ ì—†ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_mot', label: 'ê´€ì‹¬/í¥ë¯¸/ì¦ê±°ì›€/ì†Œë¹„/ê³„íš', desc: '-4 ë§¤ìš° ê°ì†Œ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_act', label: 'í™œë™ëŸ‰', desc: '-4 ë§¤ìš° ê°ì†Œ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_tsp', label: 'ìƒê°ì˜ ì†ë„ì™€ ì–‘', desc: '-4 ë§¤ìš° ëŠë¦¬ê³  ì ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ë¹ ë¥´ê³  ë§ìŒ', section: 'scale', type: 'scale' },
        { id: 's_tct', label: 'ìƒê°ì˜ ë‚´ìš©', desc: '-4 ê·¹íˆ ë¶€ì •ì , 0 ì ë‹¹, 4 ê·¹íˆ ê¸ì •ì ', section: 'scale', type: 'scale' },
        { id: 'sleep', label: 'ìˆ˜ë©´ì‹œê°„ (ì‹œê°„)', desc: '0~24ì‹œê°„', section: 'body', type: 'sleep' },
        { id: 'weight',label: 'ì²´ì¤‘ (kg) *ì¼ìš”ì¼ë§Œ', desc: 'ì¼ìš”ì¼ ê¶Œì¥', section: 'body', type: 'weight' },
        { id: 'period',label: 'ìƒë¦¬ê¸°ê°„', desc: '', section: 'body', type: 'check', colorGroup: 'period' },
        { id: 'alcoh', label: 'ìŒì£¼', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'binge', label: 'í­ì‹', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'pain',  label: 'í†µì¦ ë° ì‹ ì²´ì¦ìƒ', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'cry',   label: 'ìš¸ìŒ', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'panic', label: 'ê³µí™©ë°œì‘', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'hyper', label: 'ê³¼í˜¸í¡', desc: '', section: 'body', type: 'check', colorGroup: 'neg' },
        { id: 'meds',  label: 'ì•½ë¬¼ë³µìš©', desc: '', section: 'body', type: 'check', colorGroup: 'pos' },
        { id: 'exer',  label: 'ìš´ë™', desc: '', section: 'body', type: 'check', colorGroup: 'pos' },
        { id: 'event', label: 'ìƒí™œì‚¬ê±´ (í´ë¦­)', desc: 'í´ë¦­í•˜ì—¬ ê¸°ë¡', section: 'event', type: 'event' }
    ];

    let user = null, target = null, curDate = new Date();
    let modalTarget = { day: null, id: null };
    let myChart = null; 
    let currentTheme = localStorage.getItem('mood_theme') || 'default';
    let selectedIcon = '';
    
    const gridWrapper = document.getElementById('grid-container');
    const aDown = document.getElementById('arrow-down');
    const aRight = document.getElementById('arrow-right');
    if (gridWrapper) {
        gridWrapper.addEventListener('scroll', checkScroll);
    }
    function checkScroll() {
        if (gridWrapper.scrollHeight - gridWrapper.scrollTop > gridWrapper.clientHeight + 20) aDown.classList.add('visible');
        else aDown.classList.remove('visible');
        if (gridWrapper.scrollWidth - gridWrapper.scrollLeft > gridWrapper.clientWidth + 20) aRight.classList.add('visible');
        else aRight.classList.remove('visible');
    }

    window.onload = () => {
        const savedId = localStorage.getItem('mood_saved_id');
        const savedPw = localStorage.getItem('mood_saved_pw'); 
        if(savedId && savedPw) {
            document.getElementById('l-id').value = savedId;
            document.getElementById('l-pw').value = savedPw; 
            document.getElementById('remember-me').checked = true;
        }
        applyTheme(currentTheme);
        renderIconGrid(); 
    };

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); }
    function toggleAuth(m) { document.getElementById('login-form').classList.toggle('hidden', m !== 'login'); document.getElementById('join-form').classList.toggle('hidden', m !== 'join'); }
    async function join() {
        if(!document.getElementById('j-agree').checked) return alert("ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        const id = document.getElementById('j-id').value, pw = document.getElementById('j-pw').value, h = document.getElementById('j-hosp').value;
        if(!id || !pw || !h) return alert('í•„ìˆ˜ ì…ë ¥ ëˆ„ë½');
        const hashedPw = await hashPassword(pw);
        const { error } = await sb.rpc('register_user_secure', { p_id: id, p_pw: hashedPw, p_hosp: h });
        if(error) alert('ì˜¤ë¥˜: ' + error.message); else if(error && error.message.includes('duplicate')) alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); else { alert('ê°€ì… ì™„ë£Œ.'); toggleAuth('login'); }
    }
    async function login() {
        const id = document.getElementById('l-id').value;
        const pw = document.getElementById('l-pw').value;
        if(document.getElementById('remember-me').checked) { localStorage.setItem('mood_saved_id', id); localStorage.setItem('mood_saved_pw', pw); } 
        else { localStorage.removeItem('mood_saved_id'); localStorage.removeItem('mood_saved_pw'); }
        const hashedPw = await hashPassword(pw); 
        const { error } = await sb.rpc('get_records_secure', { p_user: id, p_pw: hashedPw, p_target: id, p_start: '2000-01-01', p_end: '2000-01-01' });
        if(error && error.message.includes('ë¡œê·¸ì¸')) return alert('ë¡œê·¸ì¸ ì‹¤íŒ¨.');
        user = { username: id, password: hashedPw, role: (id==='admin'?'doctor':'patient') }; 
        target = id;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-badge').innerText = id + (user.role==='doctor'?'(ì˜ë£Œì§„)':'');
        if(user.role==='doctor') { 
            document.getElementById('doc-panel').classList.add('active'); target = null; toggleSidebar(); 
            ['pink','green','dark'].forEach(t => unlockTheme(t, false));
        } else { 
            // 7ì¼ ì´ë‚´ ë°ì´í„°ë¡œë§Œ ë³´ìƒ ì²´í¬
            checkUnlockStatus(id, hashedPw, user.role);
            checkSeasonalEvent(); // [NEW] ì‹œì¦Œ ì´ë²¤íŠ¸
            loadUserStickers(); 
            loadPlacedStickers(); 
            renderTable(); 
        }
    }

    // Helper to check timeliness (7ì¼ ì´ë‚´ ì‘ì„± ì—¬ë¶€)
    function isTimely(record) {
        if (!record.updated_at) return true; // DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ ë°ì´í„°ëŠ” ì¸ì •
        const targetDate = new Date(record.record_date);
        const writeDate = new Date(record.updated_at);
        // ë‚ ì§œ ì°¨ì´ ê³„ì‚° (ë°€ë¦¬ì´ˆ -> ì¼)
        const diffTime = writeDate - targetDate;
        const diffDays = diffTime / (1000 * 60 * 60 * 24);
        // 7ì¼ ì´ë‚´ (+1ì¼ ì—¬ìœ )
        return diffDays <= 8 && diffDays >= -1; 
    }

    async function checkUnlockStatus(id, pw, role) {
        if(role === 'doctor') return;
        const { data } = await sb.rpc('get_records_secure', { p_user: id, p_pw: pw, p_target: id, p_start: '2000-01-01', p_end: '2099-12-31' });
        
        if (data && data.length > 0) {
            // ìœ íš¨í•œ ë°ì´í„°ë§Œ í•„í„°ë§ (7ì¼ ì´ë‚´ ì‘ì„±)
            const validData = data.filter(r => isTimely(r));
            const uniqueDates = Array.from(new Set(validData.map(r => r.record_date))).sort();
            const activeDays = uniqueDates.length;
            document.getElementById('total-days-display').innerText = `ê´€ì°° ${activeDays}ì¼`;
            
            // ìŠ¤íŠ¸ë¦­ ê³„ì‚°
            const streak = calculateStreak(uniqueDates);
            updateBadgeDisplay(streak);

            if (activeDays >= 30) unlockTheme('pink', true);
            if (activeDays >= 180) unlockTheme('green', true);
            if (activeDays >= 365) unlockTheme('dark', true);

            checkWeeklyReward(validData);
        }
    }

    function calculateStreak(sortedDates) {
        if (sortedDates.length === 0) return 0;
        let streak = 0;
        const today = new Date(); today.setHours(0,0,0,0);
        
        const lastRecord = new Date(sortedDates[sortedDates.length-1]);
        const diff = (today - lastRecord) / (1000 * 60 * 60 * 24);
        if (diff > 1) return 0;

        let current = new Date(lastRecord);
        for (let i = sortedDates.length - 1; i >= 0; i--) {
            const d = new Date(sortedDates[i]);
            // ë‚ ì§œ ë¹„êµ (ì‹œê°„ì œì™¸)
            if (current.getFullYear() === d.getFullYear() && current.getMonth() === d.getMonth() && current.getDate() === d.getDate()) {
                streak++;
                current.setDate(current.getDate() - 1); 
            } else if (current.getTime() > d.getTime()) {
                // ê±´ë„ˆë›´ ë‚ ì§œê°€ ìˆë‹¤ë©´ ë£¨í”„ ì¢…ë£Œ (ì •ë ¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ)
                break; 
            }
        }
        return streak;
    }

    function updateBadgeDisplay(streak) {
        const streakEl = document.getElementById('streak-display');
        const badgeContainer = document.getElementById('badge-container');
        
        if (streak > 1) {
            streakEl.innerText = `ì—°ì† ${streak}ì¼ğŸ”¥`;
            streakEl.classList.remove('hidden');
        } else {
            streakEl.classList.add('hidden');
        }

        let badges = '';
        if (streak >= 3) badges += '<span title="3ì¼ ì—°ì†" class="badge-icon">ğŸ¥‰</span>';
        if (streak >= 7) badges += '<span title="7ì¼ ì—°ì†" class="badge-icon">ğŸ¥ˆ</span>';
        if (streak >= 30) badges += '<span title="30ì¼ ì—°ì†" class="badge-icon">ğŸ¥‡</span>';
        if (streak >= 100) badges += '<span title="100ì¼ ì—°ì†" class="badge-icon">ğŸ†</span>';
        badgeContainer.innerHTML = badges;
    }

    function checkSeasonalEvent() {
        const today = new Date();
        const month = today.getMonth() + 1;
        const date = today.getDate();
        const md = `${String(month).padStart(2,'0')}-${String(date).padStart(2,'0')}`;
        
        let eventKey = null;
        if (md === '01-01') eventKey = 'newyear';
        else if (md === '12-25') eventKey = 'christmas';
        else if (krHolidays[`${today.getFullYear()}-${md}`] === 'ì„¤ë‚ ') eventKey = 'newyear';
        else if (krHolidays[`${today.getFullYear()}-${md}`] === 'ì¶”ì„') eventKey = 'chuseok';
        else if (krHolidays[md]) eventKey = 'korea';

        // ìƒì¼ ì²´í¬ (ìˆ«ìë¡œ ëë‚˜ëŠ” IDë§Œ)
        const idMatch = user.username.match(/(\d{2})(\d{2})$/); 
        if (idMatch) {
            const m = parseInt(idMatch[1]);
            const d = parseInt(idMatch[2]);
            if (month === m && date === d) eventKey = 'birthday';
        }

        if (eventKey) {
            giveSpecialReward(eventKey);
        }
    }

    function giveSpecialReward(eventKey) {
        const storageKey = `event_reward_${user.username}_${eventKey}_${new Date().getFullYear()}`;
        if (!localStorage.getItem(storageKey)) {
            const stickers = seasonalStickers[eventKey] || seasonalStickers['korea'];
            const myKey = `my_stickers_${user.username}`;
            let myStickers = JSON.parse(localStorage.getItem(myKey) || "[]");
            let newCount = 0;
            stickers.forEach(s => {
                if (!myStickers.includes(s)) {
                    myStickers.push(s);
                    newCount++;
                }
            });
            if (newCount > 0) {
                localStorage.setItem(myKey, JSON.stringify(myStickers));
                let msg = "íŠ¹ë³„í•œ ë‚ ì´ë„¤ìš”!";
                if(eventKey==='birthday') msg = "ìƒì¼ ì¶•í•˜í•©ë‹ˆë‹¤! ğŸ‚";
                else if(eventKey==='christmas') msg = "ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤! ğŸ„";
                else if(eventKey==='newyear') msg = "ìƒˆí•´ ë³µ ë§ì´ ë°›ìœ¼ì„¸ìš”! ğŸ™‡";
                else if(eventKey==='chuseok') msg = "í’ì„±í•œ í•œê°€ìœ„ ë˜ì„¸ìš”! ğŸŒ•";
                
                alert(`${msg}\n[ì‹œì¦Œ í•œì • ìŠ¤í‹°ì»¤] ê¾¸ëŸ¬ë¯¸ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!\nê°€ë°©ì„ í™•ì¸í•´ë³´ì„¸ìš”.`);
                loadUserStickers();
            }
            localStorage.setItem(storageKey, 'true');
        }
    }

    function checkWeeklyReward(records) {
        const lastRewardKey = `last_reward_${user.username}`;
        const lastRewardStr = localStorage.getItem(lastRewardKey);
        const lastRewardDate = lastRewardStr ? new Date(lastRewardStr) : new Date(0);
        const now = new Date();
        
        const diffDays = (now - lastRewardDate) / (1000 * 60 * 60 * 24);
        if (diffDays >= 7) {
            const recentLogs = records.filter(r => {
                const d = new Date(r.record_date);
                return (now - d) / (1000 * 60 * 60 * 24) <= 7;
            }).length;

            if (recentLogs >= 3) {
                const hasScore = records.some(r => (r.category === 'score_ls' || r.category === 'score_mssi') && r.value > 0);
                giveReward(hasScore);
                localStorage.setItem(lastRewardKey, now.toISOString());
            }
        }
    }

    function giveReward(hasBonus) {
        let tier = 1;
        const rand = Math.random();
        if (hasBonus) {
            if (rand < 0.5) tier = 2; else if (rand < 0.8) tier = 3; else tier = 4;
        } else {
            if (rand < 0.8) tier = 1; else tier = 2;
        }

        const tierIcons = stickerDB[tier];
        const newIcon = tierIcons[Math.floor(Math.random() * tierIcons.length)];
        
        const myKey = `my_stickers_${user.username}`;
        let myStickers = JSON.parse(localStorage.getItem(myKey) || "[]");
        
        if (!myStickers.includes(newIcon)) {
            myStickers.push(newIcon);
            localStorage.setItem(myKey, JSON.stringify(myStickers));
            
            let itemName = "ë°˜ì§ì´ëŠ” ì•„ì´í…œ";
            let msg = "ê¾¸ì¤€íˆ ê¸°ë¶„ì„ ê´€ì°°í•˜ì‹  ë‹¹ì‹ ì—ê²Œ";
            if(tier===2) { itemName = "ê·€ì—¬ìš´ ì¹œêµ¬"; msg = "ìŠ¤ìŠ¤ë¡œë¥¼ ì˜ ëŒë³´ì‹œëŠ”êµ°ìš”!"; }
            if(tier===3) { itemName = "íŠ¹ë³„í•œ ì˜¤ë¸Œì íŠ¸"; msg = "ì •ë§ ëŒ€ë‹¨í•´ìš”! í›Œë¥­í•©ë‹ˆë‹¤."; }
            if(tier===4) { itemName = "ì „ì„¤ì˜ ì•„ì´ì½˜"; msg = "ë‹¹ì‹ ì˜ ê¸°ë¡ì€ ì „ì„¤ì´ ë  ê±°ì˜ˆìš”!"; }

            alert(`${msg}\n[${newIcon} ${itemName}] ìŠ¤í‹°ì»¤ê°€ ìƒê²¼ì–´ìš”!\nê¸°ë¶„ê¸°ë¡ì§€ ì–´ë””ë“  ë¶™ì—¬ë³´ì„¸ìš”!`);
            loadUserStickers(); 
        }
    }

    function loadUserStickers() {
        const myKey = `my_stickers_${user.username}`;
        let earned = JSON.parse(localStorage.getItem(myKey) || "[]");
        let allStickers = [...stickerDB[1]]; 
        earned.forEach(s => { if(!allStickers.includes(s)) allStickers.push(s); });

        const container = document.getElementById('sticker-list-container');
        container.innerHTML = '';
        const listDiv = document.createElement('div');
        listDiv.className = 'sticker-list';
        
        allStickers.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            div.innerText = icon;
            div.draggable = true;
            div.ondragstart = (e) => { e.dataTransfer.setData("text/plain", icon); toggleStickerInventory(); };
            div.onclick = (e) => { spawnSticker(icon, 150, window.scrollY + 200); toggleStickerInventory(); };
            listDiv.appendChild(div);
        });
        container.appendChild(listDiv);
    }

    function toggleStickerInventory() {
        const inv = document.getElementById('sticker-inventory');
        inv.classList.toggle('show');
    }

    function spawnSticker(icon, x, y, dbId = null) {
        const layer = document.getElementById('sticker-layer');
        const el = document.createElement('div');
        el.className = 'sticker-placed';
        el.innerText = icon;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        if (dbId) el.dataset.dbId = dbId; 

        let isDragging = false;
        let startX, startY, initLeft, initTop;

        const startDrag = (cx, cy) => { isDragging = true; startX = cx; startY = cy; initLeft = parseFloat(el.style.left); initTop = parseFloat(el.style.top); el.style.zIndex = 1000; };
        const moveDrag = (cx, cy) => { if (!isDragging) return; el.style.left = (initLeft + cx - startX) + 'px'; el.style.top = (initTop + cy - startY) + 'px'; };
        const endDrag = async () => {
            if (!isDragging) return;
            isDragging = false; el.style.zIndex = '';
            if (user.role !== 'doctor') {
                const finalX = parseFloat(el.style.left);
                const finalY = parseFloat(el.style.top);
                if(el.dataset.dbId) await sb.rpc('delete_sticker_secure', { p_user: user.username, p_pw: user.password, p_id: parseInt(el.dataset.dbId) });
                const { error } = await sb.rpc('save_sticker_secure', { p_user: user.username, p_pw: user.password, p_icon: icon, p_x: finalX, p_y: finalY });
            }
        };

        el.addEventListener('mousedown', e => { startDrag(e.clientX, e.clientY); });
        window.addEventListener('mousemove', e => { moveDrag(e.clientX, e.clientY); });
        el.addEventListener('mouseup', endDrag);
        el.addEventListener('touchstart', e => { startDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        window.addEventListener('touchmove', e => { moveDrag(e.touches[0].clientX, e.touches[0].clientY); }, {passive: false});
        el.addEventListener('touchend', endDrag);

        el.ondblclick = async () => {
            if(confirm('ì´ ìŠ¤í‹°ì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?')) {
                if(el.dataset.dbId && user.role !== 'doctor') {
                    await sb.rpc('delete_sticker_secure', { p_user: user.username, p_pw: user.password, p_id: parseInt(el.dataset.dbId) });
                }
                el.remove();
            }
        };
        layer.appendChild(el);
    }

    async function loadPlacedStickers() {
        const layer = document.getElementById('sticker-layer');
        layer.innerHTML = '';
        const { data } = await sb.rpc('get_stickers_secure', { p_user: user.username, p_pw: user.password, p_target: target });
        if (data) {
            data.forEach(s => spawnSticker(s.icon, s.pos_x, s.pos_y, s.id));
        }
    }

    const gridEl = document.getElementById('grid-container');
    gridEl.ondragover = (e) => e.preventDefault();
    gridEl.ondrop = (e) => {
        e.preventDefault();
        const icon = e.dataTransfer.getData("text/plain");
        if (icon) {
            const rect = gridEl.getBoundingClientRect();
            const x = e.clientX - rect.left + gridEl.scrollLeft;
            const y = e.clientY - rect.top + gridEl.scrollTop;
            spawnSticker(icon, x, y);
            if (user.role !== 'doctor') {
                sb.rpc('save_sticker_secure', { p_user: user.username, p_pw: user.password, p_icon: icon, p_x: x, p_y: y });
            }
        }
    };

    function unlockTheme(themeName, alertMsg) {
        const btn = document.getElementById(`theme-${themeName}`);
        if (btn && btn.classList.contains('locked')) {
            btn.classList.remove('locked'); btn.innerHTML = btn.innerHTML.replace('ğŸ”’', ''); 
            if(alertMsg) {
                const storageKey = `unlocked_${themeName}_${user.username}`;
                if (!localStorage.getItem(storageKey)) { alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ê¾¸ì¤€í•œ ê¸°ë¡ ë•ë¶„ì— [${themeName}] í…Œë§ˆê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤!`); localStorage.setItem(storageKey, 'true'); }
            }
        }
    }
    function setTheme(themeName) {
        const btn = document.getElementById(`theme-${themeName}`);
        if (btn.classList.contains('locked')) return alert("ì•„ì§ ì ê²¨ìˆëŠ” í…Œë§ˆì…ë‹ˆë‹¤. ê¾¸ì¤€íˆ ê¸°ë¡í•´ë³´ì„¸ìš”!");
        currentTheme = themeName; localStorage.setItem('mood_theme', themeName); applyTheme(themeName);
    }
    function applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        const targetBtn = document.getElementById(`theme-${themeName}`);
        if(targetBtn) targetBtn.classList.add('active');
    }

    function renderIconGrid() {
        const container = document.getElementById('icon-container');
        container.innerHTML = '';
        eventIcons.forEach(icon => {
            const div = document.createElement('div');
            div.className = 'icon-item';
            div.innerText = icon;
            div.onclick = () => selectIcon(div, icon);
            container.appendChild(div);
        });
    }
    
    function selectIcon(el, icon) {
        document.querySelectorAll('.icon-item.selected').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');
        selectedIcon = icon;
        document.getElementById('selected-icon').value = icon;
    }

    function openEventModal(day, id, txt) { 
        modalTarget = { day, id }; 
        document.getElementById('modal-title').innerText = `${day}ì¼ ìƒí™œì‚¬ê±´`;
        let content = txt || "";
        selectedIcon = "";
        document.querySelectorAll('.icon-item.selected').forEach(i => i.classList.remove('selected'));
        if (content.length > 0) {
            const firstChar = Array.from(content)[0];
            if (eventIcons.includes(firstChar)) {
                selectedIcon = firstChar;
                const iconDivs = document.querySelectorAll('.icon-item');
                for(let div of iconDivs) { if(div.innerText === selectedIcon) { div.classList.add('selected'); break; } }
                content = content.substring(firstChar.length).trim();
            }
        }
        document.getElementById('modal-text').value = content;
        document.getElementById('event-modal').style.display = 'flex'; 
    }
    
    function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
    function saveEventFromModal() { 
        let txt = document.getElementById('modal-text').value.trim();
        if (selectedIcon) txt = selectedIcon + " " + txt;
        const cell = document.querySelector(`td[data-d="${modalTarget.day}"][data-c="${modalTarget.id}"]`); 
        if(cell) { cell.innerText = txt; updateVisuals(cell, {type:'event'}, txt); } 
        saveData(modalTarget.day, modalTarget.id, txt); 
        closeEventModal(); 
    }
    
    function openPwModal() { document.getElementById('pw-old').value=''; document.getElementById('pw-new').value=''; document.getElementById('pw-cfm').value=''; document.getElementById('pw-modal').style.display = 'flex'; }
    function closePwModal() { document.getElementById('pw-modal').style.display = 'none'; }
    function doLogout() { location.reload(); }
    async function changePassword() {
        const o = document.getElementById('pw-old').value, n = document.getElementById('pw-new').value, c = document.getElementById('pw-cfm').value;
        if(!o || !n) return alert("ì…ë ¥ í•„ìš”"); if(n!==c) return alert("ë¶ˆì¼ì¹˜");
        const ho = await hashPassword(o), hn = await hashPassword(n);
        const { data } = await sb.rpc('change_password_secure', { p_user: user.username, p_old_pw: ho, p_new_pw: hn });
        if(data==='success') { alert("ì™„ë£Œ. ì¬ë¡œê·¸ì¸í•˜ì„¸ìš”."); location.reload(); } else alert("ì‹¤íŒ¨");
    }
    function moveMonth(n) { curDate.setMonth(curDate.getMonth() + n); renderTable(); }
    function jumpToDate(val) { curDate = new Date(val); renderTable(); }
    async function exportData() { if(user.role === 'doctor') return alert("ë¶ˆê°€"); alert("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘..."); const { data } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: user.username, p_start: '2000-01-01', p_end: '2099-12-31' }); if(!data || !data.length) return alert("ë°ì´í„° ì—†ìŒ"); let csv = "data:text/csv;charset=utf-8,Date,Category,Value\n"; data.forEach(r => csv += `${r.record_date},${r.category},"${r.value.replace(/"/g, '""')}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `mood_${user.username}.csv`; link.click(); }
    async function importData(input) { const f = input.files[0]; if(!f) return; if(!confirm("ê¸°ì¡´ ê¸°ë¡ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return; const r = new FileReader(); r.onload = async (e) => { const rows = e.target.result.split("\n").slice(1); for(let row of rows) { const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if(cols.length>=3) { const d = cols[0].trim(), c = cols[1].trim(), v = cols[2].replace(/^"|"$/g,'').trim(); if(d && c) await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: d, p_cat: c, p_val: v }); } } alert("ì—…ë¡œë“œ ì™„ë£Œ"); loadData(); }; r.readAsText(f); }

    function createSelect(min, max) {
        let s = document.createElement('select'); s.className = 'cell-select'; s.add(new Option('', ''));
        for(let i=min; i<=max; i++) s.add(new Option(i, i));
        return s;
    }

    function updateVisuals(cell, item, value) {
        cell.style.backgroundColor = ''; 
        if (value === '' || value === null) return;
        if (item.section === 'scale') {
            const val = parseInt(value);
            if (val > 0) { const alpha = 0.05 + (val * 0.06); cell.style.backgroundColor = `rgba(255, 82, 82, ${alpha})`; } 
            else if (val < 0) { const alpha = 0.05 + (Math.abs(val) * 0.06); cell.style.backgroundColor = `rgba(33, 150, 243, ${alpha})`; } 
            else { cell.style.backgroundColor = '#ffffff'; }
        } else if (item.type === 'sleep') {
            const val = parseFloat(value);
            if (val < 7) { let intensity = (7 - val) / 7; cell.style.backgroundColor = `rgba(255, 82, 82, ${intensity * 0.5})`; } 
            else if (val > 7) { let intensity = (val - 7) / 17; cell.style.backgroundColor = `rgba(33, 150, 243, ${intensity * 0.5})`; }
        } else if (item.type === 'check' || (item.id === 'meds' || item.id === 'exer')) {
            if (value && value !== '') {
                if (item.colorGroup === 'period') cell.style.backgroundColor = 'rgba(244, 143, 177, 0.4)';
                else if (item.colorGroup === 'neg') cell.style.backgroundColor = 'rgba(100, 181, 246, 0.3)';
                else if (item.colorGroup === 'pos') cell.style.backgroundColor = 'rgba(129, 199, 132, 0.4)';
            }
        } else if (item.type === 'event') {
            if (value && value.trim() !== '') cell.style.backgroundColor = 'rgba(255, 245, 157, 0.5)';
        }
    }

    function checkMin(el) { if(el.value < 0) el.value = 0; }

    async function updateMixedState(day) {
        setTimeout(() => {
            let cnt = 0;
            const moodItems = items.filter(i => i.section === 'mood' && i.id !== 'mixed');
            moodItems.forEach(i => { const t = document.querySelector(`td[data-d="${day}"][data-c="${i.id}"]`); if(t && t.classList.contains('checked')) cnt++; });
            const mixedCell = document.querySelector(`td[data-d="${day}"][data-c="mixed"]`);
            if(cnt >= 2) { if(!mixedCell.classList.contains('checked')) { mixedCell.classList.add('checked'); saveData(day, 'mixed', 'Y'); } } 
            else { if(mixedCell.classList.contains('checked')) { mixedCell.classList.remove('checked'); saveData(day, 'mixed', null); } }
        }, 50);
    }

    async function saveData(day, cat, val) {
        if(user.role==='doctor') return;
        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const date = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: date, p_cat: cat, p_val: val });
    }

    async function saveMonthlyScore(type, val) {
        if(user.role==='doctor') return;
        const date = `${curDate.getFullYear()}-${String(curDate.getMonth()+1).padStart(2,'0')}-01`;
        await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: date, p_cat: `score_${type}`, p_val: val });
    }

    async function loadData() {
        document.querySelectorAll('.checked').forEach(e=>e.classList.remove('checked'));
        document.querySelectorAll('input, select').forEach(e => { 
            if(!e.id.includes('search') && !e.id.includes('date') && !e.id.includes('score') && !e.id.includes('pw') && !e.id.includes('modal')) {
                e.value=''; if(e.parentElement.tagName === 'TD') e.parentElement.style.backgroundColor = '';
            }
        });
        document.querySelectorAll('.cell-event').forEach(e => { e.innerText = ''; e.style.backgroundColor = ''; });

        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const lastDay = new Date(y, m, 0).getDate();
        const start = `${y}-${String(m).padStart(2,'0')}-01`;
        const end = `${y}-${String(m).padStart(2,'0')}-${lastDay}`;

        const { data, error } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: target, p_start: start, p_end: end });
        if(error) { if(error.message.includes('ì°¾ì„ ìˆ˜')) return alert("í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); else return alert("ì¡°íšŒ ì˜¤ë¥˜: " + error.message); }
        if(user.role === 'doctor' && (!data || data.length === 0)) alert("í•´ë‹¹ ì›”ì˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");

        data?.forEach(rec => {
            if(rec.category === 'score_ls') document.getElementById('score-ls').value = rec.value;
            else if(rec.category === 'score_mssi') document.getElementById('score-mssi').value = rec.value;
            else {
                const day = new Date(rec.record_date).getDate();
                const item = items.find(i => i.id === rec.category);
                const cell = document.querySelector(`td[data-d="${day}"][data-c="${rec.category}"]`);
                if(cell) {
                    if(item && (item.id === 'meds' || item.id === 'exer')) {
                        cell.innerText = rec.value;
                        updateVisuals(cell, item, 'Y');
                    }
                    else if(rec.category === 'mixed' || cell.classList.contains('cell-check') || cell.classList.contains('cell-mixed')) {
                        if(rec.value === 'Y') { cell.classList.add('checked'); if(item) updateVisuals(cell, item, 'Y'); }
                    } else if(cell.classList.contains('cell-event')) {
                        cell.innerText = rec.value;
                        if(item) updateVisuals(cell, item, rec.value);
                    } else if(cell.querySelector('select')) {
                        cell.querySelector('select').value = rec.value;
                        if(item || cell.dataset.s === 'scale') { const targetItem = item || items.find(i => i.section === 'scale'); updateVisuals(cell, targetItem, rec.value); }
                    } else if(cell.querySelector('input')) {
                        cell.querySelector('input').value = rec.value;
                        if(item) updateVisuals(cell, item, rec.value);
                    }
                }
            }
        });

        if(user.role !== 'doctor') {
            const today = new Date();
            if(today.getFullYear() === y && today.getMonth() + 1 === m) {
                const lastDayOfCurrentMonth = new Date(y, m, 0).getDate();
                if(today.getDate() >= lastDayOfCurrentMonth - 7) {
                    const lsVal = document.getElementById('score-ls').value;
                    const mssiVal = document.getElementById('score-mssi').value;
                    if(!lsVal || !mssiVal) setTimeout(() => alert("ğŸ“¢ [ì•Œë¦¼] ì´ë²ˆ ë‹¬ í‰ê°€ë¥¼ ì§„í–‰í•´ì£¼ì„¸ìš”!\n(ìƒë‹¨ë°” [ì›”ê°„] í•­ëª© ì…ë ¥)"), 500);
                }
            }
        }
    }

    async function openChartModal(type) {
        toggleSidebar(); document.getElementById('chart-modal').style.display = 'flex';
        const title = type === 'ls' ? 'ì›”ê°„ìƒí™œìŠµê´€ì ìˆ˜ ì¶”ì„¸' : 'ê¸°ë¶„ì•ˆì •ì„±í‰ê°€ì ìˆ˜ ì¶”ì„¸';
        document.getElementById('chart-title').innerText = title;
        const { data } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: target, p_start: '2000-01-01', p_end: '2099-12-31' });
        if(!data || data.length === 0) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const targetCat = `score_${type}`;
        const points = data.filter(r => r.category === targetCat).map(r => ({ x: r.record_date, y: parseInt(r.value) })).sort((a,b) => new Date(a.x) - new Date(b.x));
        drawDashboardChart(points, title, type === 'ls' ? '#10B981' : '#6366F1');
    }
    function closeChartModal() { document.getElementById('chart-modal').style.display = 'none'; }
    function drawDashboardChart(points, label, color) {
        const ctx = document.getElementById('scoreChart').getContext('2d');
        if(myChart) myChart.destroy();
        if(points.length === 0) return;
        const dates = points.map(p => new Date(p.x).getTime());
        const minTime = Math.min(...dates), maxTime = Math.max(...dates);
        const buffer = 28 * 24 * 3600 * 1000;
        const minYear = new Date(minTime - buffer).getFullYear(), maxYear = new Date(maxTime + buffer).getFullYear();
        const annotations = {};
        const bgColors = ['rgba(248, 250, 252, 0.6)', 'rgba(240, 253, 244, 0.6)', 'rgba(239, 246, 255, 0.6)', 'rgba(254, 252, 232, 0.6)'];
        for (let y = minYear; y <= maxYear; y++) {
            annotations['year'+y] = { type: 'box', xMin: luxon.DateTime.fromObject({year:y, month:1, day:1}).toMillis(), xMax: luxon.DateTime.fromObject({year:y, month:12, day:31}).toMillis(), backgroundColor: bgColors[(y - minYear) % bgColors.length], borderWidth: 0, label: { display: true, content: y+'ë…„', position: 'start', yAdjust: 20, font: {size:12, weight:'bold'}, color: '#475569' } };
        }
        myChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: [{ label: label, data: points, borderColor: color, backgroundColor: color + '10', fill: true, tension: 0.25, pointRadius: 5, borderWidth: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMì›”' } }, min: minTime - buffer, max: maxTime + buffer }, y: { beginAtZero: true, max: 200 } }, plugins: { annotation: { annotations: annotations }, legend: { display: false } } }
        });
    }

    function openEventModal(day, id, txt) { modalTarget = { day, id }; document.getElementById('modal-title').innerText = `${day}ì¼ ìƒí™œì‚¬ê±´`; document.getElementById('modal-text').value = txt || ""; document.getElementById('event-modal').style.display = 'flex'; document.getElementById('modal-text').focus(); }
    function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
    function saveEventFromModal() { const txt = document.getElementById('modal-text').value; const cell = document.querySelector(`td[data-d="${modalTarget.day}"][data-c="${modalTarget.id}"]`); if(cell) { cell.innerText = txt; updateVisuals(cell, {type:'event'}, txt); } saveData(modalTarget.day, modalTarget.id, txt); closeEventModal(); }
    function openPwModal() { document.getElementById('pw-old').value=''; document.getElementById('pw-new').value=''; document.getElementById('pw-cfm').value=''; document.getElementById('pw-modal').style.display = 'flex'; }
    function closePwModal() { document.getElementById('pw-modal').style.display = 'none'; }
    function doLogout() { location.reload(); }
    async function changePassword() {
        const o = document.getElementById('pw-old').value, n = document.getElementById('pw-new').value, c = document.getElementById('pw-cfm').value;
        if(!o || !n) return alert("ì…ë ¥ í•„ìš”"); if(n!==c) return alert("ë¶ˆì¼ì¹˜");
        const ho = await hashPassword(o), hn = await hashPassword(n);
        const { data } = await sb.rpc('change_password_secure', { p_user: user.username, p_old_pw: ho, p_new_pw: hn });
        if(data==='success') { alert("ì™„ë£Œ. ì¬ë¡œê·¸ì¸í•˜ì„¸ìš”."); location.reload(); } else alert("ì‹¤íŒ¨");
    }
    function moveMonth(n) { curDate.setMonth(curDate.getMonth() + n); renderTable(); }
    function jumpToDate(val) { curDate = new Date(val); renderTable(); }
    async function exportData() { if(user.role === 'doctor') return alert("ë¶ˆê°€"); alert("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘..."); const { data } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: user.username, p_start: '2000-01-01', p_end: '2099-12-31' }); if(!data || !data.length) return alert("ë°ì´í„° ì—†ìŒ"); let csv = "data:text/csv;charset=utf-8,Date,Category,Value\n"; data.forEach(r => csv += `${r.record_date},${r.category},"${r.value.replace(/"/g, '""')}"\n`); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = `mood_${user.username}.csv`; link.click(); }
    async function importData(input) { const f = input.files[0]; if(!f) return; if(!confirm("ê¸°ì¡´ ê¸°ë¡ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return; const r = new FileReader(); r.onload = async (e) => { const rows = e.target.result.split("\n").slice(1); for(let row of rows) { const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if(cols.length>=3) { const d = cols[0].trim(), c = cols[1].trim(), v = cols[2].replace(/^"|"$/g,'').trim(); if(d && c) await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: d, p_cat: c, p_val: v }); } } alert("ì—…ë¡œë“œ ì™„ë£Œ"); loadData(); }; r.readAsText(f); }
</script>
</body>
</html>
