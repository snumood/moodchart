<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê¸°ë¶„ê¸°ë¡ì§€ 3.10 | ë¶„ë‹¹ì„œìš¸ëŒ€í•™êµë³‘ì›</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

<style>
    :root { 
        --primary: #005eb8; --primary-dark: #004a94; --today-bg: #fffde7; --today-border: #d50000; --text: #2c3e50; --border: #ccc;
        --bg-block-mood: #fff5f5; --bg-block-scale: #fffdeb; --bg-block-body: #e8f5e9; --bg-block-event: #ffffff;
        --header-h: 46px; --top-bar-h: 38px; --cell-h: 34px; --col-w: 140px; --date-w: 44px;
    }
    body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; margin: 0; background: #f0f2f5; color: var(--text); font-size: 12px; overflow: hidden; height: 100dvh; position: relative; }
    .hidden { display: none !important; }
    input, button, select, textarea { outline: none; font-family: inherit; font-size: inherit; }
    a { text-decoration: none; color: inherit; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    #auth-screen { 
        height: 100dvh; display: flex; justify-content: center; align-items: center; 
        position: fixed; width: 100%; z-index: 9999; top: 0; left: 0;
        background: url('https://github.com/snumood/moodchart/blob/main/bg2.jpg?raw=true') no-repeat center center fixed; background-size: cover;
    }
    #auth-screen::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: -1; }
    .auth-box { width: 90%; max-width: 400px; padding: 30px; background: rgba(255, 255, 255, 0.95); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; }
    .auth-inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 10px; }
    .save-login-wrap { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin: 10px 0; align-items: center; }
    .warning-text { color: #d32f2f; font-weight: bold; font-size: 11px; }
    .toggle-auth { margin-top: 20px; font-size: 13px; color: #555; cursor: pointer; text-decoration: underline; display: inline-block; }
    .legal-text { text-align: left; font-size: 12px; margin: 15px 0; background: #f1f3f5; padding: 12px; border-radius: 6px; color: #444; line-height: 1.5; word-break: keep-all; border: 1px solid #eee; }

    .container { height: 100dvh; display: flex; flex-direction: column; background: #fff; position: relative; }
    .header { height: var(--header-h); display: flex; justify-content: space-between; align-items: center; padding: 0 10px; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .month-nav { font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 8px; color: #222; }
    .btn-nav { background: white; border: 1px solid #ccc; padding: 0 8px; cursor: pointer; border-radius: 4px; font-size: 12px; height: 28px; display: flex; align-items: center; justify-content: center; }
    #date-picker { border: 1px solid #ccc; padding: 0 5px; border-radius: 4px; height: 28px; font-size: 13px; cursor: pointer; width: 115px; }
    .btn-menu { font-size: 24px; background: none; border: none; cursor: pointer; color: #333; padding: 0 5px; }

    .top-assessment-bar { height: var(--top-bar-h); background: #f8f9fa; border-bottom: 1px solid #bbb; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 12px; flex-shrink: 0; padding: 0 10px; overflow-x: auto; white-space: nowrap; z-index: 90; }
    .top-assessment-bar a { font-weight: bold; color: var(--primary); text-decoration: underline; font-size: 11px; }
    .top-assessment-bar input { width: 50px; height: 24px; text-align: center; border: 1px solid #999; border-radius: 4px; font-size: 12px; padding: 0; font-weight: bold; }

    .grid-wrapper { flex: 1; overflow: auto; background: #fff; position: relative; -webkit-overflow-scrolling: touch; height: calc(100dvh - var(--header-h) - var(--top-bar-h)); }
    table { border-collapse: separate; border-spacing: 0; table-layout: fixed; width: max-content; margin-bottom: 80px; }
    th, td { border-right: 1px solid #ddd; border-bottom: 1px solid #ddd; text-align: center; height: var(--cell-h); padding: 0; vertical-align: middle; width: var(--date-w); min-width: var(--date-w); max-width: var(--date-w); overflow: hidden; white-space: nowrap; background-clip: padding-box; }
    
    thead tr:nth-child(1) th { position: sticky; top: 0; z-index: 30; height: 34px; background: #fff; border-bottom: 1px solid #999; color: #444; }
    thead tr:nth-child(2) th { position: sticky; top: 34px; z-index: 30; height: 30px; background: #fff; border-bottom: 2px solid #999; }
    .col-label { position: sticky !important; left: 0 !important; z-index: 40 !important; width: var(--col-w) !important; min-width: var(--col-w) !important; max-width: var(--col-w) !important; border-right: 2px solid #999; text-align: left; padding-left: 10px; font-weight: 700; font-size: 11px; color: #222; background-color: inherit; }
    thead tr:nth-child(1) th.col-label, thead tr:nth-child(2) th.col-label { z-index: 50 !important; background-color: #fff; }

    .block-divider td, .block-divider th { border-top: 3px solid #888 !important; }
    .bg-scale { background-color: var(--bg-block-scale); }
    .bg-body { background-color: var(--bg-block-body); }
    .bg-event { background-color: var(--bg-block-event); }

    .today-header { background-color: var(--today-bg) !important; color: #d50000; border: 2px solid var(--today-border) !important; border-bottom: none !important; }
    .today-dow { background-color: var(--today-bg) !important; border-left: 2px solid var(--today-border) !important; border-right: 2px solid var(--today-border) !important; border-bottom: 2px solid var(--today-border) !important; color: #d50000; font-weight: bold; }
    .today-badge { display: block; font-size: 9px; color: #fff; background: var(--today-border); border-radius: 4px; width: 36px; margin: 0 auto; line-height: 1.3; margin-bottom: 2px; font-weight: 800; }

    .active-row td { box-shadow: inset 0 0 0 1000px rgba(0, 94, 184, 0.05); } 
    .active-col { box-shadow: inset 0 0 0 1000px rgba(0, 94, 184, 0.05); }
    .day-sun { color: #e53935; background-color: #fff5f5 !important; border-right: 2px solid #888 !important; }
    .day-sat { color: #1e88e5; background-color: #f0f8ff !important; }
    .day-holiday { color: #e53935 !important; background-color: #ffebee !important; font-weight: bold; }

    .cell-check { cursor: pointer; color: #ccc; font-size: 14px; }
    .cell-check.checked { font-weight: 900; color: #000; font-size: 16px; }
    .cell-check.checked::after { content: "âœ”"; }
    .cell-mixed { font-size: 14px; color: #ccc; pointer-events: none; }
    .cell-mixed.checked { color: #7b1fa2; font-weight: bold; }
    .cell-mixed.checked::after { content: "âœ”"; }
    .cell-icon { cursor: pointer; font-size: 18px; line-height: 1; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .cell-select { width: 100%; height: 100%; border: none; background: transparent; text-align-last: center; -webkit-appearance: none; cursor: pointer; font-weight: 600; font-size: 11px; padding: 0; margin: 0; }
    .cell-input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; font-size: 11px; padding: 0; margin: 0; min-width: 0; }
    .cell-event { cursor: pointer; text-align: center; padding: 0; color: #222; font-size: 22px; line-height: 1; }
    .disabled-cell { background-color: #eee !important; pointer-events: none; color: #aaa; }

    .scroll-arrow { position: absolute; width: 36px; height: 36px; border-radius: 50%; background: rgba(0, 94, 184, 0.6); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; pointer-events: none; z-index: 900; opacity: 0; transition: opacity 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.2); animation: floatArrow 1.5s infinite ease-in-out; }
    .scroll-arrow.visible { opacity: 1; }
    .arrow-down { bottom: 20px; left: 50%; transform: translateX(-50%); } 
    .arrow-right { top: 50%; right: 15px; transform: translateY(-50%); animation-name: floatArrowH; }
    @keyframes floatArrow { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, 5px); } }
    @keyframes floatArrowH { 0%, 100% { transform: translate(0, -50%); } 50% { transform: translate(5px, -50%); } }

    #sidebar { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: white; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 2000; transition: right 0.3s ease; display: flex; flex-direction: column; }
    #sidebar.open { right: 0; }
    .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: flex-end; align-items: center; background: var(--primary); color: white; height: 50px; }
    .sidebar-content { padding: 20px; overflow-y: auto; flex: 1; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1500; display: none; }
    .sidebar-overlay.show { display: block; }
    .menu-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
    .menu-title { font-weight: bold; font-size: 13px; color: #666; margin-bottom: 10px; }
    .menu-item { display: block; padding: 10px 0; font-size: 13px; color: #333; cursor: pointer; }
    .menu-item:hover { color: var(--primary); font-weight: bold; }
    .user-badge { background: #e3f2fd; color: var(--primary); padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; display: inline-block; margin-bottom: 10px; }

    #doc-panel { display: none; margin-bottom: 15px; background: #e3f2fd; padding: 10px; border-radius: 8px; }
    #doc-panel.active { display: block; }
    #doc-panel input { width: 70%; padding: 8px; border: 1px solid #fff; border-radius: 4px; }
    #doc-panel button { width: 25%; padding: 8px; background: var(--primary); color: white; border: none; border-radius: 4px; font-weight: bold; }

    .modal-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 320px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .icon-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; max-height: 180px; overflow-y: auto; overflow-x: hidden; margin-bottom: 15px; padding: 5px; border: 1px solid #eee; border-radius: 8px; background: #fafafa; }
    .icon-item { cursor: pointer; font-size: 24px; text-align: center; padding: 4px; border-radius: 8px; background: white; border: 1px solid #eee; transition: all 0.2s; }
    .icon-item:hover { background-color: #fff9c4; transform: scale(1.1); }
    .icon-item.selected { background-color: #fff176; border: 2px solid #fbc02d; }
    .icon-empty { font-size: 11px; color: #999; text-align: center; grid-column: span 5; padding: 20px; }
    
    .gift-tab { display: flex; margin-bottom: 10px; border-bottom: 1px solid #eee; }
    .gift-tab-item { flex: 1; text-align: center; padding: 8px; cursor: pointer; font-size: 12px; color: #888; border-bottom: 2px solid transparent; }
    .gift-tab-item.active { color: var(--primary); font-weight: bold; border-bottom: 2px solid var(--primary); }

    .gold-tier-1 { background: linear-gradient(135deg, #fffde7, #fff9c4) !important; border: 1px solid #fbc02d !important; }
    .gold-tier-2 { background: linear-gradient(135deg, #e0f2f1, #fff9c4, #fce4ec) !important; border: 2px solid #fbc02d !important; box-shadow: 0 0 8px rgba(251, 192, 45, 0.4); }
    .gold-tier-3 { background: linear-gradient(135deg, #fffde7, #fbc02d, #f9a825, #fffde7) !important; background-size: 200% 200% !important; border: 2px solid #e65100 !important; box-shadow: 0 0 15px rgba(251, 192, 45, 0.7); animation: shimmer 3s infinite linear; }
    @keyframes shimmer { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; transform: scale(1.03); } 100% { background-position: 0% 50%; } }

    .admin-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
    .stat-val { font-size: 24px; font-weight: bold; color: var(--primary); margin-top: 5px; }
    .stat-label { font-size: 12px; color: #666; }

    .chart-modal-content { background: white; padding: 20px; border-radius: 20px; width: 95%; height: 80%; max-width: 800px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
    .chart-container { flex: 1; position: relative; width: 100%; min-height: 0; }
    .modal-header { font-weight: bold; margin-bottom: 15px; font-size: 15px; display: flex; justify-content: space-between; color: var(--primary); }
    .modal-textarea { width: 100%; height: 80px; border: 1px solid #ccc; padding: 10px; resize: none; border-radius: 6px; font-size: 13px; margin-top: 10px; }
    .modal-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
    .modal-btns { text-align: right; margin-top: 10px; }
    .btn-modal { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-save { background: var(--primary); color: white; }
    .btn-cancel { background: #eee; color: #333; margin-right: 5px; }
    
    @media (max-width: 768px) { :root { --col-w: 130px; } }
</style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">ê¸°ë¶„ê¸°ë¡ì§€</h2>
        <div id="login-form">
            <input id="l-id" class="auth-inp" placeholder="ì•„ì´ë””">
            <input id="l-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <div class="save-login-wrap">
                <label style="cursor:pointer; display:flex; align-items:center; gap:5px;"><input type="checkbox" id="remember-me"> ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥</label>
                <div class="warning-text">â€»ê³µìš©ê¸°ê¸°ì—ì„œ ë¹„ë°€ë²ˆí˜¸ìœ ì¶œì£¼ì˜</div>
            </div>
            <button class="btn-auth" onclick="login()">ë¡œê·¸ì¸</button>
            <span class="toggle-auth" onclick="toggleAuth('join')">íšŒì›ê°€ì…</span>
        </div>
        <div id="join-form" class="hidden">
            <input id="j-id" class="auth-inp" placeholder="í¬ë§ ì•„ì´ë””">
            <input id="j-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input id="j-hosp" class="auth-inp" placeholder="ë“±ë¡ë²ˆí˜¸ ë˜ëŠ” ì´ë‹ˆì…œ+ìƒë…„ì›”ì¼ (í•„ìˆ˜)">
            <div style="font-size:11px; color:#666; text-align:left; margin-bottom:5px;">ì˜ˆ: 43445678 ë˜ëŠ” HGD19990305</div>
            <div class="legal-text">ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš©ì´ ì•„ë‹ˆë©° ëª¨ë“  ì‚¬ìš© ì±…ì„ì€ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ ë° ë¯¼ê°ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”. ìµëª… í”„ë¡œê·¸ë¨ì´ë¯€ë¡œ ê³„ì •ì„ ë¶„ì‹¤í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            <label style="font-size:12px; cursor:pointer; display:block; text-align:left; margin-bottom:15px;"><input type="checkbox" id="j-agree"> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.</label>
            <button class="btn-auth" style="background:#28a745;" onclick="join()">ê°€ì…ì™„ë£Œ</button>
            <span class="toggle-auth" onclick="toggleAuth('login')">ëŒì•„ê°€ê¸°</span>
        </div>
    </div>
</div>

<div id="main-screen" class="hidden">
    <div class="container">
        <div class="header">
            <div class="month-nav">
                <button class="btn-nav" onclick="moveMonth(-1)">â—€</button>
                <input type="date" id="date-picker" onchange="jumpToDate(this.value)">
                <button class="btn-nav" onclick="moveMonth(1)">â–¶</button>
            </div>
            <button class="btn-menu" onclick="toggleSidebar()">â˜°</button>
        </div>
        <div class="top-assessment-bar">
            <a href="https://snumood.github.io/homepage/ls.html" target="_blank">ì›”ê°„ìƒí™œìŠµê´€ì ìˆ˜</a>
            <input id="score-ls" type="number" inputmode="decimal" placeholder="ì " min="0" onblur="saveMonthlyScore('ls', this.value)">
            <span style="color:#ddd">|</span>
            <a href="https://snumood.github.io/homepage/mssi.html" target="_blank">ê¸°ë¶„ì•ˆì •ì„±í‰ê°€ì ìˆ˜</a>
            <input id="score-mssi" type="number" inputmode="decimal" placeholder="ì " min="0" onblur="saveMonthlyScore('mssi', this.value)">
        </div>
        <div class="grid-wrapper" id="grid-container">
            <table id="mood-table">
                <thead><tr id="header-row"><th class="col-label">í•­ëª© / ë‚ ì§œ</th></tr><tr id="dow-row"><th class="col-label" style="background:#fff;">ìš”ì¼</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <div id="arrow-down" class="scroll-arrow arrow-down">â–¼</div>
        <div id="arrow-right" class="scroll-arrow arrow-right">â–¶</div>
    </div>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
    <div class="sidebar-header"><span style="cursor:pointer; font-size:20px; font-weight:bold;" onclick="toggleSidebar()">âœ•</span></div>
    <div class="sidebar-content">
        <div class="user-badge" id="user-badge"></div>
        <div id="doc-panel" class="hidden"><div style="font-weight:bold; margin-bottom:5px;">í™˜ì ì¡°íšŒ</div><div style="display:flex; gap:5px;"><input id="search-id" placeholder="ID/ë²ˆí˜¸" style="flex:1; padding:5px;"><button onclick="searchPatient()">ê²€ìƒ‰</button></div></div>
        
        <div id="admin-menu" class="menu-section hidden"><div class="menu-title">ê´€ë¦¬ì ì „ìš©</div><div class="menu-item" onclick="openAdminStats()">ğŸ‘‘ ê´€ë¦¬ì í†µê³„</div></div>

        <div class="menu-section"><div class="menu-title">ê³„ì • ê´€ë¦¬</div><div class="menu-item" onclick="openPwModal()">ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div><div class="menu-item" onclick="doLogout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div></div>
        <div class="menu-section"><div class="menu-title">ì„ ë¬¼</div><div class="menu-item" onclick="openGiftModal()">ğŸ ì„ ë¬¼ìƒì</div></div>
        <div class="menu-section"><div class="menu-title">ë°ì´í„° ê´€ë¦¬</div><div class="menu-item" onclick="exportData()">ğŸ’¾ ëª¨ë“  ê¸°ë¡ì„ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ</div><input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importData(this)"><div class="menu-item" onclick="document.getElementById('import-file').click()">ğŸ“‚ íŒŒì¼ì„ ê¸°ë¡ìœ¼ë¡œ ì—…ë¡œë“œ (ì´ì „ê¸°ë¡ì‚­ì œ)</div></div>
        <div class="menu-section"><div class="menu-title">ì•ˆë‚´</div><a href="https://drive.google.com/file/d/1UKEOr5OjR42Ipv64zL1FsI8XPLvz3QhI/view?usp=sharing" target="_blank" class="menu-item">ğŸ“– ê¸°ë¶„ê¸°ë¡ì§€ ì‘ì„±ë°©ë²• ë³´ê¸°</a></div>
        <div style="font-size:10px; color:#999; line-height:1.4; margin-top:20px;">ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš©ì´ ì•„ë‹ˆë©° ëª¨ë“  ì‚¬ìš© ì±…ì„ì€ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ ë° ë¯¼ê°ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ì£¼ì˜í•˜ì„¸ìš”. ìµëª… í”„ë¡œê·¸ë¨ì´ë¯€ë¡œ ê³„ì •ì„ ë¶„ì‹¤í•˜ë©´ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
</div>

<div id="gift-modal" class="modal-wrap">
    <div class="modal-content">
        <div class="modal-header"><span>ğŸ ì„ ë¬¼ìƒì</span><span style="cursor:pointer;" onclick="closeGiftModal()">âœ•</span></div>
        <div class="gift-tab"><div class="gift-tab-item active" onclick="switchGiftTab('my')" id="tab-my">ëª¨ì€ ì„ ë¬¼í•¨</div><div class="gift-tab-item" onclick="switchGiftTab('received')" id="tab-received">ë°›ì€ ì„ ë¬¼í•¨</div></div>
        <div id="gift-list-container" class="icon-grid"></div>
        <div id="gift-actions" style="margin-top:10px; text-align:center;">
            <div id="my-actions"><p style="font-size:12px; color:#666; margin-bottom:10px;">ì„±ì‹¤íˆ ê¸°ë¡í•˜ë©´ ìƒˆë¡œìš´ ì„ ë¬¼ì„ ë°œê²¬í•  ìˆ˜ ìˆì–´ìš”!</p><button class="btn-modal btn-save" style="width:100%;" onclick="tryUnlockGift()">ìƒì ì—´ì–´ë³´ê¸°</button></div>
            <div id="received-actions" class="hidden"><p style="font-size:12px; color:#666;">ëˆ„êµ°ê°€ì—ê²Œ ë°›ì€ ì„ ë¬¼ì€ ìƒí™œì‚¬ê±´ê¸°ë¡ì— ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</p></div>
            <div id="selected-gift-action" class="hidden" style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;"><div style="font-size:30px; margin-bottom:5px;" id="preview-icon"></div><button id="btn-gift-action" class="btn-modal" style="background:#ff9800; color:white; width:100%;">ëˆ„êµ°ê°€ì—ê²Œ ì„ ë¬¼í•˜ê¸°</button><div style="font-size:10px; color:#d32f2f; margin-top:5px;">* ì„ ë¬¼í•˜ë©´ ì„ ë¬¼í•¨ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤!</div></div>
        </div>
    </div>
</div>

<div id="event-modal" class="modal-wrap">
    <div class="modal-content">
        <div class="modal-header"><span id="modal-title"></span><span style="cursor:pointer;" onclick="closeEventModal()">âœ•</span></div>
        <div style="font-size:11px; color:#666; margin-bottom:5px;">ë³´ìœ í•œ ì´ëª¨í‹°ì½˜ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div id="event-icon-container" class="icon-grid"></div>
        <input type="hidden" id="selected-event-icon">
        <textarea id="modal-text" class="modal-textarea" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
        <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="closeEventModal()">ì·¨ì†Œ</button><button class="btn-modal btn-save" onclick="saveEventFromModal()">ì €ì¥í•˜ê¸°</button></div>
    </div>
</div>

<div id="pw-modal" class="modal-wrap">
    <div class="modal-content">
        <div class="modal-header"><span>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span><span style="cursor:pointer;" onclick="closePwModal()">âœ•</span></div>
        <input type="password" id="pw-old" class="modal-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"><input type="password" id="pw-new" class="modal-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"><input type="password" id="pw-cfm" class="modal-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
        <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="closePwModal()">ì·¨ì†Œ</button><button class="btn-modal btn-save" onclick="changePassword()">ë³€ê²½í•˜ê¸°</button></div>
    </div>
</div>

<div id="chart-modal" class="modal-wrap">
    <div class="chart-modal-content">
        <div class="modal-header"><span id="chart-title">ì¶”ì„¸ ê·¸ë˜í”„</span><span style="cursor:pointer; font-size:20px;" onclick="closeChartModal()">âœ•</span></div>
        <div class="chart-container"><canvas id="scoreChart"></canvas></div>
    </div>
</div>

<div id="admin-modal" class="modal-wrap">
    <div class="chart-modal-content">
        <div class="modal-header"><span>ğŸ‘‘ ê´€ë¦¬ì í†µê³„</span><span style="cursor:pointer;" onclick="closeAdminModal()">âœ•</span></div>
        <div class="admin-stat-grid">
            <div class="stat-card"><div class="stat-label">ì´ ê°€ì… ìœ ì €</div><div class="stat-val" id="adm-total">0</div></div>
            <div class="stat-card"><div class="stat-label">ì‹¤ í™œë™ ìœ ì €(2ê°œì›”)</div><div class="stat-val" id="adm-active">0</div></div>
        </div>
        <div class="chart-container"><canvas id="adminChart"></canvas></div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://vzybcxvwpqhdmrxbxzmq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bAlzb9dPdxb5lpzudvqwHQ_MxpUVkNj';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function hashPassword(str) { const msgBuffer = new TextEncoder().encode(str); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join(''); }

    const rewardIcons = ['ğŸ’','ğŸ’','ğŸ’–','ğŸ°','ğŸ¦„','ğŸ¬','ğŸ­','ğŸ€','ğŸ¦‹','ğŸ§š','â›²','ğŸ¡','ğŸ ','ğŸ”®','ğŸ†','ğŸ‡','ğŸŒŒ','ğŸª','ğŸŒ™','ğŸŒ•','ğŸŒ','ğŸµï¸','ğŸŒº','ğŸŒ¹','ğŸŒ·','ğŸˆ','ğŸ§¸','ğŸ§','ğŸ‚','ğŸ¥','ğŸ“','ğŸ’','ğŸ‘','ğŸ‡','ğŸ¥‚','ğŸ¹','ğŸ»','ğŸ¹','ğŸ¼','ğŸ¨','ğŸ§µ','ğŸ‘‘','ğŸ‘œ','ğŸ§¥','ğŸ‘ ','ğŸ•¶ï¸','ğŸ—ï¸','âšœï¸','âœ¨','ğŸ','ğŸ†','ğŸ¥‡','ğŸ…','ğŸ‘‘','ğŸµï¸','ğŸ—ï¸','ğŸ','ğŸ’Œ','ğŸ’','âœ¨','âš¡','ğŸ”¥','ğŸŒˆ','ğŸŒŠ','ğŸš','ğŸª¸','ğŸ§œ','ğŸ§š','ğŸ§','ğŸ‰','ğŸ¦„','ğŸ¦Œ','ğŸ•Šï¸','ğŸ¦¢','ğŸ¦š','ğŸ’®','ğŸª·','ğŸŒ»','ğŸ€','ğŸ','ğŸ‚','ğŸ„','ğŸŒ°','ğŸ“','ğŸŠ','ğŸ','ğŸ','ğŸ¯','ğŸ¥‚','ğŸ¾','ğŸ·','ğŸ°','ğŸ‚','ğŸ¡','ğŸ§','ğŸ¦','ğŸ§','ğŸ¥¨','ğŸ®','ğŸ«','ğŸª'];
    const medsIcons = ['ğŸ’Š','ğŸ©º','ğŸ©¹','ğŸ›Œ','ğŸ§¸','ğŸµ','â˜•','ğŸ¥›','ğŸ¯','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ¥£','ğŸ¥—','ğŸ¥ª','ğŸŒ¿','ğŸŒ±','ğŸƒ','ğŸ€','â˜˜ï¸','ğŸŒµ','ğŸŒ»','ğŸŒ¼','ğŸŒ·','ğŸŒ¸','ğŸŒ¹','ğŸŒº','ğŸ’','ğŸŒ','ğŸŒ','âœ¨','ğŸŒŸ','â­ï¸','ğŸ’«','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ¤','ğŸ¤','â¤ï¸â€ğŸ©¹','ğŸ’–','ğŸ’—','ğŸ’“','ğŸ’','ğŸ’•','ğŸ’Œ','ğŸ›¡ï¸','âœ…','ğŸ•¯ï¸','ğŸ“–','ğŸ›','ğŸ§˜','ğŸ§˜â€â™€ï¸','ğŸ¼','ğŸ¶'];
    const exerIcons = ['ğŸƒ','ğŸƒâ€â™€ï¸','ğŸƒâ€â™‚ï¸','ğŸš¶','ğŸš¶â€â™€ï¸','ğŸš¶â€â™‚ï¸','ğŸ’ƒ','ğŸ•º','ğŸ‘¯','ğŸ§–','ğŸ§—','ğŸ§—â€â™€ï¸','ğŸ§—â€â™‚ï¸','ğŸ¤º','ğŸ‡','â›·ï¸','ğŸ‚','ğŸ„','ğŸ„â€â™€ï¸','ğŸ„â€â™‚ï¸','ğŸš£','ğŸš£â€â™€ï¸','ğŸš£â€â™‚ï¸','ğŸŠ','ğŸŠâ€â™€ï¸','ğŸŠâ€â™‚ï¸','â›¹ï¸','â›¹ï¸â€â™€ï¸','â›¹ï¸â€â™‚ï¸','ğŸ‹ï¸','ğŸ‹ï¸â€â™€ï¸','ğŸ‹ï¸â€â™‚ï¸','ğŸš´','ğŸš´â€â™€ï¸','ğŸš´â€â™‚ï¸','ğŸšµ','ğŸšµâ€â™€ï¸','ğŸšµâ€â™‚ï¸','ğŸ¤¸','ğŸ¤¸â€â™€ï¸','ğŸ¤¸â€â™‚ï¸','ğŸ¤¼','ğŸ¤¼â€â™€ï¸','ğŸ¤¼â€â™‚ï¸','ğŸ¤½','ğŸ¤½â€â™€ï¸','ğŸ¤½â€â™‚ï¸','ğŸ¤¾','ğŸ¤¾â€â™€ï¸','ğŸ¤¾â€â™‚ï¸','ğŸ¤¹','ğŸ¤¹â€â™€ï¸','ğŸ¤¹â€â™‚ï¸','ğŸ§˜','ğŸ§˜â€â™€ï¸','ğŸ§˜â€â™‚ï¸','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ›¶','ğŸ¥…','ğŸ’','ğŸ¥','ğŸ','ğŸ‘','ğŸ³','ğŸ¥','âš¾','ğŸˆ','ğŸ‰','ğŸ','ğŸ¾','ğŸ¸','ğŸ“','ğŸ¥Š','ğŸ¥‹','ğŸ¥…','â›³','â›¸','ğŸ£','ğŸ½','ğŸ¿','ğŸ›·','ğŸ¥Œ'];
    const cheerMessages = ["ê¾¸ì¤€íˆ ìŠ¤ìŠ¤ë¡œì˜ ê¸°ë¶„ì„ ê´€ì°°í•œ ë‹¹ì‹ ì—ê²Œ ì„ ë¬¼ì„ ë“œë ¤ìš”!", "ì˜¤ëŠ˜ë„ ìì‹ ì„ ëŒë³´ëŠ” ë‹¹ì‹ ì´ ë©‹ì§‘ë‹ˆë‹¤!", "ì‘ì€ ê¸°ë¡ë“¤ì´ ëª¨ì—¬ ë” ë‚˜ì€ ë‚´ì¼ì„ ë§Œë“­ë‹ˆë‹¤.", "ë‹¹ì‹ ì˜ ê¾¸ì¤€í•¨ì´ ë¹›ì„ ë°œí•˜ê³  ìˆì–´ìš”.", "ê¸°ë¶„ì„ ê¸°ë¡í•˜ëŠ” ê²ƒì€ ë‚˜ë¥¼ ì‚¬ë‘í•˜ëŠ” ì²« ê±¸ìŒì…ë‹ˆë‹¤.", "í˜ë“  ìˆœê°„ì—ë„ ê¸°ë¡ì„ ë©ˆì¶”ì§€ ì•Šì€ ë‹¹ì‹ ì„ ì‘ì›í•´ìš”.", "ë‹¹ì‹ ì˜ í•˜ë£¨í•˜ë£¨ê°€ ì†Œì¤‘í•˜ê²Œ ê¸°ë¡ë˜ê³  ìˆìŠµë‹ˆë‹¤.", "ìŠ¤ìŠ¤ë¡œë¥¼ ì´í•´í•˜ë ¤ëŠ” ë…¸ë ¥ì— ë°•ìˆ˜ë¥¼ ë³´ëƒ…ë‹ˆë‹¤!", "ì¡°ê¸ˆì”© ë” ë‹¨ë‹¨í•´ì§€ëŠ” ë§ˆìŒì„ ëŠê»´ë³´ì„¸ìš”.", "ì˜¤ëŠ˜ ë°›ì€ ì„ ë¬¼ì²˜ëŸ¼, ë‹¹ì‹ ì˜ í•˜ë£¨ë„ ì„ ë¬¼ ê°™ê¸°ë¥¼.", "ê¸°ë¡ì€ ì‚¬ë¼ì§€ì§€ ì•Šê³  ë‹¹ì‹ ì„ ì§€íƒ±í•´ ì¤„ ê±°ì˜ˆìš”.", "ì ì‹œ ì‰¬ì–´ê°€ë„ ê´œì°®ì•„ìš”, ê¾¸ì¤€í•¨ë§Œ ìƒì§€ ë§ˆì„¸ìš”.", "ë‹¹ì‹ ì˜ ì„±ì‹¤í•¨ì´ ë©‹ì§„ ì„ ë¬¼ì„ ê°€ì ¸ì™”ë„¤ìš”!", "ë‚˜ë¥¼ ì•Œì•„ê°€ëŠ” ì—¬ì •ì— í•¨ê»˜í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.", "ì–´ë–¤ ê¸°ë¶„ì´ë“  ê´œì°®ì•„ìš”, ê¸°ë¡í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œ ì¶©ë¶„í•©ë‹ˆë‹¤.", "ë§ˆìŒì˜ ë‚ ì”¨ë¥¼ ì‚´í”¼ëŠ” ë‹¹ì‹ ì€ ì§€í˜œë¡œìš´ ì‚¬ëŒì…ë‹ˆë‹¤.", "ì˜¤ëŠ˜ë„ í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°”êµ°ìš”, ì¶•í•˜í•´ìš”!", "ì„ ë¬¼ ìƒì ì†ì— ë‹´ê¸´ ì‘ì›ì˜ ë§ˆìŒì„ ë°›ì•„ì£¼ì„¸ìš”.", "ë‹¹ì‹ ì˜ ëª¨ë“  ê°ì •ì„ ì¡´ì¤‘í•˜ê³  ì‘ì›í•©ë‹ˆë‹¤.", "ê¸°ë¡ì„ í†µí•´ ë” í–‰ë³µí•´ì§ˆ ë‹¹ì‹ ì„ ê¸°ëŒ€í•©ë‹ˆë‹¤."];

    const items = [
        { id: 'm_p4', label: '+4 ê·¹íˆ ìƒìŠ¹', desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'mood', color: 'rgba(255, 50, 50, 0.3)', type: 'check' },
        { id: 'm_p3', label: '+3 ìƒë‹¹í•œ ìƒìŠ¹', desc: 'ìƒë‹¹í•œ ì§€ì¥, ì£¼ë³€ì—ì„œ í˜ë“¤ì–´í•¨', section: 'mood', color: 'rgba(255, 50, 50, 0.2)', type: 'check' },
        { id: 'm_p2', label: '+2 ë¶„ëª…í•œ ìƒìŠ¹', desc: 'ë‹¤ì†Œ ì§€ì¥, ì „ê³¼ ë‹¤ë¥´ë‹¤ëŠ” ì§€ì ', section: 'mood', color: 'rgba(255, 50, 50, 0.1)', type: 'check' },
        { id: 'm_p1', label: '+1 ë¯¸ì„¸í•œ ìƒìŠ¹', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ë³¸ì¸ì€ ê¸°ë¶„ ì¢‹ìŒ', section: 'mood', color: 'rgba(255, 50, 50, 0.05)', type: 'check' },
        { id: 'm_0',  label: '0  ë³´í†µ ê¸°ë¶„',   desc: 'í‰ì˜¨í•˜ê³  ì •ìƒì ì¸ ìƒíƒœ', section: 'mood', color: '#ffffff', type: 'check' }, 
        { id: 'm_m1', label: '-1 ë¯¸ì„¸í•œ ì €í•˜', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ì˜ìš• ì €í•˜', section: 'mood', color: 'rgba(50, 50, 255, 0.05)', type: 'check' },
        { id: 'm_m2', label: '-2 ë¶„ëª…í•œ ì €í•˜', desc: 'ì¼ìƒì„ ìœ ì§€í•˜ë ¤ ë…¸ë ¥ í•„ìš”', section: 'mood', color: 'rgba(50, 50, 255, 0.1)', type: 'check' },
        { id: 'm_m3', label: '-3 ìƒë‹¹í•œ ì €í•˜', desc: 'ë…¸ë ¥í•´ë„ ê¸°ëŠ¥ì´ ë–¨ì–´ì§', section: 'mood', color: 'rgba(50, 50, 255, 0.2)', type: 'check' },
        { id: 'm_m4', label: '-4 ê·¹íˆ ì €í•˜',   desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'mood', color: 'rgba(50, 50, 255, 0.3)', type: 'check' },
        { id: 'mixed', label: 'í˜¼ì¬ ìƒíƒœ',     desc: 'ìë™ ì²´í¬ë©ë‹ˆë‹¤', section: 'mood', color: '#f3e5f5', type: 'mixed' },
        { id: 's_anx', label: 'ë‘ë ¤ì›€/ì†Œì‹¬í•¨/ê±±ì •/ë¶ˆì•ˆ', desc: '-4 ë„ˆë¬´ ì—†ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_ang', label: 'ì§œì¦/ë¶„ë…¸', desc: '-4 ë„ˆë¬´ ì—†ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_mot', label: 'ê´€ì‹¬/í¥ë¯¸/ì¦ê±°ì›€/ì†Œë¹„/ê³„íš', desc: '-4 ë§¤ìš° ê°ì†Œ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_act', label: 'í™œë™ëŸ‰', desc: '-4 ë§¤ìš° ê°ì†Œ, 0 ì ë‹¹, 4 ê·¹íˆ ì¦ê°€', section: 'scale', type: 'scale' },
        { id: 's_tsp', label: 'ìƒê°ì˜ ì†ë„ì™€ ì–‘', desc: '-4 ë§¤ìš° ëŠë¦¬ê³  ì ìŒ, 0 ì ë‹¹, 4 ê·¹íˆ ë¹ ë¥´ê³  ë§ìŒ', section: 'scale', type: 'scale' },
        { id: 's_tct', label: 'ìƒê°ì˜ ë‚´ìš©', desc: '-4 ê·¹íˆ ë¶€ì •ì , 0 ì ë‹¹, 4 ê·¹íˆ ê¸ì •ì ', section: 'scale', type: 'scale' },
        { id: 'sleep', label: 'ìˆ˜ë©´ì‹œê°„ (ì‹œê°„)', desc: '0~24ì‹œê°„', section: 'body', type: 'sleep' },
        { id: 'weight',label: 'ì²´ì¤‘ (kg) *ì¼ìš”ì¼ë§Œ', desc: 'ì¼ìš”ì¼ ê¶Œì¥', section: 'body', type: 'weight' },
        { id: 'period',label: 'ìƒë¦¬ê¸°ê°„', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'alcoh', label: 'ìŒì£¼', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'binge', label: 'í­ì‹', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'pain',  label: 'í†µì¦ ë° ì‹ ì²´ì¦ìƒ', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'cry',   label: 'ìš¸ìŒ', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'panic', label: 'ê³µí™©ë°œì‘', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'hyper', label: 'ê³¼í˜¸í¡', desc: '', section: 'body', type: 'check', colorGroup: 'symptom' },
        { id: 'meds',  label: 'ì•½ë¬¼ë³µìš©', desc: '', section: 'body', type: 'check', colorGroup: 'meds' },
        { id: 'exer',  label: 'ìš´ë™', desc: '', section: 'body', type: 'check', colorGroup: 'exer' },
        { id: 'event', label: 'ìƒí™œì‚¬ê±´ê¸°ë¡ (í´ë¦­)', desc: 'í´ë¦­í•˜ì—¬ ê¸°ë¡', section: 'event', type: 'event' }
    ];

    let user = null, target = null, curDate = new Date();
    let modalTarget = { day: null, id: null };
    let currentGiftTab = 'my', selectedInventoryId = null, replyTargetItemId = null;
    let myChart = null;

    // ì´ˆê¸°í™”
    window.onload = () => {
        const savedId = localStorage.getItem('mood_saved_id');
        const savedPw = localStorage.getItem('mood_saved_pw'); 
        if(savedId && savedPw) {
            document.getElementById('l-id').value = savedId;
            document.getElementById('l-pw').value = savedPw; 
            document.getElementById('remember-me').checked = true;
        }
    };

    function toggleAuth(m) { 
        document.getElementById('login-form').classList.toggle('hidden', m !== 'login'); 
        document.getElementById('join-form').classList.toggle('hidden', m !== 'join'); 
    }

    async function login() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        const hashedPw = await hashPassword(pw); 
        const { error } = await sb.rpc('get_records_secure', { p_user: id, p_pw: hashedPw, p_target: id, p_start: '2000-01-01', p_end: '2000-01-01' });
        if(error) return alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        user = { username: id, password: hashedPw, role: (id==='admin'?'doctor':'patient') }; target = id;
        
        if(document.getElementById('remember-me').checked) { localStorage.setItem('mood_saved_id', id); localStorage.setItem('mood_saved_pw', pw); } 
        else { localStorage.removeItem('mood_saved_id'); localStorage.removeItem('mood_saved_pw'); }

        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-badge').innerText = id;
        
        if(user.role === 'doctor') {
            document.getElementById('doc-panel').classList.remove('hidden');
            if(user.username === 'admin') document.getElementById('admin-menu').classList.remove('hidden');
            target = null; toggleSidebar();
        } else {
            renderTable();
        }
    }

    async function join() {
        if(!document.getElementById('j-agree').checked) return alert("ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        const id = document.getElementById('j-id').value, pw = document.getElementById('j-pw').value, h = document.getElementById('j-hosp').value;
        if(!id || !pw || !h) return alert('í•„ìˆ˜ ì…ë ¥ ëˆ„ë½');
        const hashedPw = await hashPassword(pw);
        const { error } = await sb.rpc('register_user_secure', { p_id: id, p_pw: hashedPw, p_hosp: h });
        if(error) alert('ì˜¤ë¥˜: ' + error.message);
        else if(error && error.message.includes('duplicate')) alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.'); 
        else { alert('ê°€ì… ì™„ë£Œ.'); toggleAuth('login'); }
    }

    // ëˆ„ë½ë˜ì—ˆë˜ ë Œë”ë§ í•¨ìˆ˜ ë³µêµ¬
    function renderTable() {
        const year = curDate.getFullYear(), month = curDate.getMonth(), lastDay = new Date(year, month+1, 0).getDate();
        const header = document.getElementById('header-row'), dowRow = document.getElementById('dow-row'), body = document.getElementById('table-body');
        header.innerHTML = '<th class="col-label">í•­ëª© / ë‚ ì§œ</th>'; dowRow.innerHTML = '<th class="col-label" style="background:#fff;">ìš”ì¼</th>'; body.innerHTML = '';
        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        for(let d=1; d<=lastDay; d++) {
            const dt = new Date(year, month, d), isToday = new Date().toDateString() === dt.toDateString();
            let th = document.createElement('th'); th.innerHTML = isToday ? `<span class='today-badge'>TODAY</span>${d}` : d;
            if(dt.getDay()===0) th.className='day-holiday'; if(isToday) th.classList.add('today-header'); header.appendChild(th);
            let td = document.createElement('th'); td.innerText = days[dt.getDay()];
            if(dt.getDay()===0) td.className='day-holiday'; if(isToday) td.classList.add('today-dow'); dowRow.appendChild(td);
        }
        items.forEach(item => {
            let tr = document.createElement('tr'); tr.className = 'bg-' + item.section;
            let th = document.createElement('th'); th.className = 'col-label'; th.innerText = item.label; tr.appendChild(th);
            for(let d=1; d<=lastDay; d++) {
                let td = document.createElement('td'); td.dataset.d = d; td.dataset.c = item.id;
                if(item.type === 'check') td.onclick = () => { if(user.role==='doctor') return; const v = td.classList.toggle('checked') ? 'Y' : null; saveData(d, item.id, v); };
                else if(item.type === 'sleep' || item.type === 'scale') {
                    let s = document.createElement('select'); s.add(new Option('',''));
                    const range = item.type==='sleep' ? [0,24] : [-4,4];
                    for(let i=range[0]; i<=range[1]; i++) s.add(new Option(i,i));
                    s.onchange = (e) => { saveData(d, item.id, e.target.value); if(item.type==='sleep') updateSleepColor(td, e.target.value); else updateScaleColor(td, e.target.value); };
                    td.appendChild(s);
                } else if(item.type === 'event') td.onclick = () => openEventModal(d, item.id, td.getAttribute('title'));
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });
        loadData();
    }

    async function loadData() {
        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const lastDay = new Date(y, m, 0).getDate();
        const start = `${y}-${String(m).padStart(2,'0')}-01`;
        const end = `${y}-${String(m).padStart(2,'0')}-${lastDay}`;
        const { data } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: target, p_start: start, p_end: end });
        
        data?.forEach(rec => {
            const day = new Date(rec.record_date).getDate();
            const cell = document.querySelector(`td[data-d="${day}"][data-c="${rec.category}"]`);
            if(cell) {
                const item = items.find(i => i.id === rec.category);
                if(item?.type === 'event') {
                    const chars = Array.from(rec.value);
                    cell.innerText = /\p{Emoji}/u.test(chars[0]) ? chars[0] : 'â­ï¸';
                    cell.setAttribute('title', rec.value);
                } else if(item?.type === 'check') {
                    if(rec.category === 'mixed' && rec.value === 'Y') cell.classList.add('checked');
                    else if(item.colorGroup) updateCheckVisual(cell, item, rec.value);
                    else if(rec.value === 'Y') cell.classList.add('checked');
                } else if(cell.querySelector('select')) {
                    cell.querySelector('select').value = rec.value;
                    if(item.type==='sleep') updateSleepColor(cell, rec.value); else updateScaleColor(cell, rec.value);
                } else if(cell.querySelector('input')) cell.querySelector('input').value = rec.value;
            }
        });
        if(user.role !== 'doctor') { checkGiftReception(); }
    }

    // ëˆ„ë½ë˜ì—ˆë˜ í—¬í¼ í•¨ìˆ˜ë“¤ ë³µêµ¬
    async function saveData(d, c, v) { const y = curDate.getFullYear(), m = curDate.getMonth()+1; const date = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: date, p_cat: c, p_val: v }); }
    async function saveMonthlyScore(type, val) { const date = `${curDate.getFullYear()}-${String(curDate.getMonth()+1).padStart(2,'0')}-01`; const { data } = await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: date, p_cat: `score_${type}`, p_val: val }); if(data?.reward_icon) alert(`ğŸ‰ ë³´ìƒ íšë“! [${data.reward_icon}]`); }
    
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); document.querySelector('.sidebar-overlay').classList.toggle('show'); }
    function closeGiftModal() { document.getElementById('gift-modal').style.display='none'; }
    function openGiftModal() { document.getElementById('gift-modal').style.display='flex'; switchGiftTab('my'); }
    function moveMonth(n) { curDate.setMonth(curDate.getMonth()+n); renderTable(); }
    function jumpToDate(v) { curDate = new Date(v); renderTable(); }
    function updateCheckVisual(c, i, v) { c.classList.toggle('checked', v==='Y'); }
    function updateSleepColor(c, v) { if(!v) {c.style.background=''; return;} const n=parseInt(v); c.style.background = n<7 ? '#ffcdd2' : (n>8 ? '#bbdefb' : ''); }
    function updateScaleColor(c, v) { if(!v) {c.style.background=''; return;} const n=parseInt(v); c.style.background = n>0 ? `rgba(255,0,0,${n*0.1})` : (n<0 ? `rgba(0,0,255,${Math.abs(n)*0.1})` : ''); }
    function openEventModal(d,id,t) { modalTarget={d,id}; document.getElementById('modal-title').innerText=`${d}ì¼ ìƒí™œì‚¬ê±´`; document.getElementById('event-modal').style.display='flex'; 
        let icon='', text=t||''; if(t){const chars=Array.from(t); if(/\p{Emoji}/u.test(chars[0])){icon=chars[0]; text=chars.slice(1).join('').trim();} else {text=t;}}
        document.getElementById('modal-text').value=text; document.getElementById('selected-event-icon').value=icon;
        const container = document.getElementById('event-icon-container'); container.innerHTML='ë¡œë”©ì¤‘...';
        sb.rpc('get_inventory_secure', { p_user: user.username, p_pw: user.password }).then(({ data }) => {
            container.innerHTML='';
            const starDiv = document.createElement('div'); starDiv.className='icon-item'; starDiv.innerText='â­ï¸';
            if(icon==='â­ï¸' || !icon) starDiv.classList.add('selected');
            starDiv.onclick=()=>{ document.querySelectorAll('#event-modal .icon-item').forEach(e=>e.classList.remove('selected')); starDiv.classList.add('selected'); document.getElementById('selected-event-icon').value='â­ï¸'; };
            container.appendChild(starDiv);
            data?.filter(i=>['earn','default','gift','gift_reply','gift_special','gift_reply_special'].includes(i.source) || i.source.startsWith('milestone') || i.source.startsWith('event') || i.source.startsWith('monthly')).forEach(item=>{
                const div=document.createElement('div'); div.className='icon-item'; div.innerText=item.icon;
                if(item.icon===icon){div.classList.add('selected'); starDiv.classList.remove('selected');}
                div.onclick=()=>{ document.querySelectorAll('#event-modal .icon-item').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); document.getElementById('selected-event-icon').value=item.icon; };
                container.appendChild(div);
            });
        });
    }
    function closeEventModal() { document.getElementById('event-modal').style.display='none'; }
    function saveEventFromModal() { 
        const t=document.getElementById('modal-text').value.trim(), i=document.getElementById('selected-event-icon').value||'â­ï¸';
        if(!t){ saveData(modalTarget.d, modalTarget.id, null); const c=document.querySelector(`td[data-d="${modalTarget.d}"][data-c="${modalTarget.id}"]`); if(c){c.innerText=''; c.removeAttribute('title');} }
        else { const v=`${i} ${t}`; saveData(modalTarget.d, modalTarget.id, v); const c=document.querySelector(`td[data-d="${modalTarget.d}"][data-c="${modalTarget.id}"]`); if(c){c.innerText=i; c.setAttribute('title',v);} }
        closeEventModal();
    }
    function doLogout() { location.reload(); }
    function openPwModal() { document.getElementById('pw-old').value=''; document.getElementById('pw-new').value=''; document.getElementById('pw-cfm').value=''; document.getElementById('pw-modal').style.display='flex'; }
    function closePwModal() { document.getElementById('pw-modal').style.display='none'; }
    async function changePassword() {
        const o=document.getElementById('pw-old').value, n=document.getElementById('pw-new').value, c=document.getElementById('pw-cfm').value;
        if(!o||!n) return alert("ì…ë ¥ í•„ìš”"); if(n!==c) return alert("ë¶ˆì¼ì¹˜");
        const ho=await hashPassword(o), hn=await hashPassword(n);
        const {data}=await sb.rpc('change_password_secure', { p_user: user.username, p_old_pw: ho, p_new_pw: hn });
        if(data==='success'){alert("ì™„ë£Œ. ì¬ë¡œê·¸ì¸í•˜ì„¸ìš”."); location.reload();} else alert("ì‹¤íŒ¨");
    }
    async function exportData() { 
        if(user.role==='doctor') return alert("ë¶ˆê°€");
        const { data } = await sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: user.username, p_start: '2000-01-01', p_end: '2099-12-31' });
        if(!data?.length) return alert("ë°ì´í„° ì—†ìŒ");
        let csv = "Date,Category,Value\n"; data.forEach(r => csv += `${r.record_date},${r.category},"${r.value.replace(/"/g, '""')}"\n`);
        const link = document.createElement("a"); link.href = encodeURI("data:text/csv;charset=utf-8,"+csv); link.download = `mood_${user.username}.csv`; link.click();
    }
    async function importData(input) { 
        const f = input.files[0]; if(!f) return; if(!confirm("ê¸°ì¡´ ê¸°ë¡ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.")) return;
        const r = new FileReader(); r.onload = async (e) => { 
            const rows = e.target.result.split("\n").slice(1); 
            for(let row of rows) { 
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                if(cols.length>=3) { const d=cols[0].trim(), c=cols[1].trim(), v=cols[2].replace(/^"|"$/g,'').trim(); if(d&&c) await sb.rpc('upsert_record_secure', { p_user: user.username, p_pw: user.password, p_date: d, p_cat: c, p_val: v }); } 
            } 
            alert("ì—…ë¡œë“œ ì™„ë£Œ"); loadData(); 
        }; r.readAsText(f); 
    }
    function openChartModal(type) { 
        toggleSidebar(); document.getElementById('chart-modal').style.display='flex';
        sb.rpc('get_records_secure', { p_user: user.username, p_pw: user.password, p_target: target, p_start: '2000-01-01', p_end: '2099-12-31' }).then(({ data }) => {
            if(!data?.length) return alert("ë°ì´í„° ì—†ìŒ");
            const points = data.filter(r => r.category === `score_${type}`).map(r => ({ x: r.record_date, y: parseFloat(r.value) })).sort((a,b)=>new Date(a.x)-new Date(b.x));
            const ctx = document.getElementById('scoreChart').getContext('2d'); if(myChart) myChart.destroy();
            const dates=points.map(p=>new Date(p.x).getTime()), minT=Math.min(...dates)-2e9, maxT=Math.max(...dates)+2e9;
            const ann={}; for(let y=new Date(minT).getFullYear(); y<=new Date(maxT).getFullYear(); y++) ann['y'+y]={type:'box', xMin:luxon.DateTime.fromObject({year:y,month:1,day:1}).toMillis(), xMax:luxon.DateTime.fromObject({year:y,month:12,day:31}).toMillis(), backgroundColor:['rgba(248,250,252,0.6)','rgba(240,253,244,0.6)','rgba(239,246,255,0.6)','rgba(254,252,232,0.6)'][(y-2000)%4], borderWidth:0, label:{display:true, content:y+'ë…„', position:'start', yAdjust:20, font:{size:12, weight:'bold'}, color:'#475569'}};
            myChart = new Chart(ctx, { type: 'line', data: { datasets: [{ label: type==='ls'?'ìƒí™œìŠµê´€':'ê¸°ë¶„ì•ˆì •ì„±', data: points, borderColor: type==='ls'?'#10B981':'#6366F1', backgroundColor: type==='ls'?'#10B98110':'#6366F110', fill: true, tension: 0.25, pointRadius: 5, borderWidth: 3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'month', displayFormats: { month: 'MMì›”' } }, min: minT, max: maxT }, y: { beginAtZero: true, max: 200 } }, plugins: { annotation: { annotations: ann }, legend: { display: false } } } });
        });
    }
    function closeChartModal() { document.getElementById('chart-modal').style.display='none'; }
    function closeAdminModal() { document.getElementById('admin-modal').style.display='none'; }
    async function checkGiftReception() {
        if(user.role === 'doctor') return;
        const { data, error } = await sb.rpc('check_gift_reception_secure', { p_user: user.username, p_pw: user.password });
        if(!data || data.status === 'none') return;
        if(data.status === 'milestone') {
            alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${data.msg}\n\n[${data.icon}] ì•„ì´ì½˜ì´ ì„ ë¬¼í•¨ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
        } else if (data.status === 'special_gift') {
            alert(`ğŸ’Œ ëˆ„êµ°ê°€ê°€ ì˜¤ëœ ê¸°ê°„ ì†Œì¤‘í•˜ê²Œ ëª¨ì€ íŠ¹ë³„í•œ ê²ƒì„ ì„ ë¬¼í–ˆìŠµë‹ˆë‹¤.\n\n[${data.icon}] ì•„ì´ì½˜ì´ ì„ ë¬¼í•¨ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.`);
        } else if (data.status === 'normal' && data.count > 0) {
            alert(`ğŸ ëˆ„êµ°ê°€ë¡œë¶€í„° ${data.count}ê°œì˜ ìƒˆë¡œìš´ ì„ ë¬¼ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! [ë°›ì€ ì„ ë¬¼í•¨]ì„ í™•ì¸í•´ë³´ì„¸ìš”.`);
        }
    }
    async function switchGiftTab(tab) {
        currentGiftTab = tab;
        document.querySelectorAll('.gift-tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        document.getElementById('my-actions').classList.toggle('hidden', tab !== 'my');
        document.getElementById('received-actions').classList.toggle('hidden', tab !== 'received');
        document.getElementById('selected-gift-action').classList.add('hidden');
        if(tab === 'received') replyTargetItemId = null;

        const container = document.getElementById('gift-list-container');
        const { data } = await sb.rpc('get_inventory_secure', { p_user: user.username, p_pw: user.password });
        container.innerHTML = '';
        
        const filtered = data ? data.filter(item => {
            if (tab === 'my') return !['gift','gift_reply','gift_reply_special'].includes(item.source) || item.source.startsWith('milestone_sent');
            return ['gift','gift_reply','gift_special','gift_reply_special'].includes(item.source) || item.source.startsWith('milestone_recv');
        }) : [];

        if(filtered.length === 0) { container.innerHTML = '<div class="icon-empty">ë³´ìœ í•œ ì•„ì´ì½˜ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        filtered.forEach(item => {
            const div = document.createElement('div'); div.className = 'icon-item'; div.innerText = item.icon;
            if(item.source.startsWith('milestone_')) {
                const count = parseInt(item.source.split('_')[2]);
                if(count >= 100) div.classList.add('gold-tier-3'); else if(count >= 50) div.classList.add('gold-tier-2'); else div.classList.add('gold-tier-1');
            } else if(item.source.includes('special')) { div.classList.add('gold-tier-3'); }
            div.onclick = () => selectGiftItem(div, item.id, item.icon, item.source);
            container.appendChild(div);
        });

        if (tab === 'my' && replyTargetItemId) document.getElementById('my-actions').innerHTML = '<p style="color:#d32f2f; font-weight:bold;">ğŸ ë³´ë‹µìœ¼ë¡œ ë³´ë‚¼ ì•„ì´ì½˜ì„ ì„ íƒí•˜ì„¸ìš”!</p>';
        else if (tab === 'my') document.getElementById('my-actions').innerHTML = `<p style="font-size:12px; color:#666; margin-bottom:10px;">ì„±ì‹¤íˆ ê¸°ë¡í•˜ë©´ ìƒˆë¡œìš´ ì„ ë¬¼ì„ ë°œê²¬í•  ìˆ˜ ìˆì–´ìš”!</p><button class="btn-modal btn-save" style="width:100%;" onclick="tryUnlockGift()">ìƒì ì—´ì–´ë³´ê¸°</button>`;
    }

    function selectGiftItem(el, id, icon, source) {
        document.querySelectorAll('.icon-item.selected').forEach(e => e.classList.remove('selected'));
        el.classList.add('selected'); selectedInventoryId = id;
        document.getElementById('preview-icon').innerText = icon;
        document.getElementById('selected-gift-action').classList.remove('hidden');
        const btn = document.getElementById('btn-gift-action');

        if (currentGiftTab === 'received') {
            if (source === 'gift' || source === 'gift_special') {
                btn.innerText = "ğŸ ë³´ë‹µí•˜ê¸° (ë‚´ ì„ ë¬¼ ë³´ë‚´ê¸°)";
                btn.onclick = () => { replyTargetItemId = id; switchGiftTab('my'); alert("ë³´ë‹µìœ¼ë¡œ ë³´ë‚¼ ì•„ì´ì½˜ì„ ì„ íƒí•˜ì„¸ìš”."); };
                btn.disabled = false; btn.style.background = '#ff9800';
            } else { btn.innerText = "ğŸ’Œ ë‹µë¡€ ë˜ëŠ” íŠ¹ë³„ ì„ ë¬¼ì…ë‹ˆë‹¤"; btn.disabled = true; btn.style.background = '#ccc'; }
        } else {
            if (replyTargetItemId) { btn.innerText = "ğŸ“¨ ì´ ì•„ì´ì½˜ìœ¼ë¡œ ë³´ë‹µ ì„ ë¬¼ ë³´ë‚´ê¸°"; btn.onclick = () => sendReplyGift(); } 
            else { btn.innerText = "ëˆ„êµ°ê°€ì—ê²Œ ì„ ë¬¼í•˜ê¸°"; btn.onclick = () => sendGiftToRandom(); }
            btn.disabled = false; btn.style.background = '#ff9800';
        }
    }

    function prepareReply(receivedId) { if(!confirm("ì´ ì„ ë¬¼ì— ëŒ€í•œ ë³´ë‹µì„ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?\n'ëª¨ì€ ì„ ë¬¼í•¨'ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.")) return; replyTargetItemId = receivedId; switchGiftTab('my'); }

    async function sendReplyGift() {
        if(!replyTargetItemId || !selectedInventoryId) return;
        if(!confirm("ì„ íƒí•œ ì•„ì´ì½˜ì„ ë³´ë‹µìœ¼ë¡œ ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        const { data, error } = await sb.rpc('send_reply_gift_secure', { p_user: user.username, p_pw: user.password, p_my_item_id: selectedInventoryId, p_received_item_id: replyTargetItemId });
        if(error) return alert("ì˜¤ë¥˜: " + error.message);
        if(data && (data.status === 'success' || data === 'success')) { alert("ğŸ’Œ ë”°ëœ»í•œ ë§ˆìŒì´ ë‹´ê¸´ ë³´ë‹µ ì„ ë¬¼ì„ ë³´ëƒˆìŠµë‹ˆë‹¤!"); replyTargetItemId = null; switchGiftTab('received'); } 
        else if (data && data.status === 'cannot_reply_again') { alert("ì´ë¯¸ ë‹µë¡€ë¡œ ë°›ì€ ì„ ë¬¼ì—ëŠ” ë‹¤ì‹œ ë‹µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); } else { alert("ë³´ë‚¼ ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤."); }
    }

    async function tryUnlockGift() {
        const randIcon = rewardIcons[Math.floor(Math.random() * rewardIcons.length)];
        const { data, error } = await sb.rpc('unlock_reward_secure', { p_user: user.username, p_pw: user.password, p_icon: randIcon });
        if(error) return alert("ì˜¤ë¥˜: " + error.message);
        if(data === 'keep_going') return alert("ì•„ì§ì€ ìƒìê°€ ì—´ë¦¬ì§€ ì•Šë„¤ìš”. ì¡°ê¸ˆ ë” ê¸°ë¡í•´ë³¼ê¹Œìš”?");
        const msg = cheerMessages[Math.floor(Math.random() * cheerMessages.length)];
        alert(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! [${randIcon}] ì•„ì´ì½˜ì„ íšë“í–ˆìŠµë‹ˆë‹¤!\n\n"${msg}"`);
        switchGiftTab('my'); saveData(1, 'dummy', null); 
    }

    async function sendGiftToRandom() {
        if(!selectedInventoryId) return;
        if(!confirm("ì •ë§ ì´ ì•„ì´ì½˜ì„ ëˆ„êµ°ê°€ì—ê²Œ ì„ ë¬¼í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë³´ë‚¸ í›„ì—ëŠ” ì„ ë¬¼í•¨ì—ì„œ ì‚¬ë¼ì§‘ë‹ˆë‹¤)")) return;
        const { data, error } = await sb.rpc('send_gift_secure', { p_user: user.username, p_pw: user.password, p_inv_id: selectedInventoryId });
        if(error) return alert("ì˜¤ë¥˜: " + error.message);
        if(data?.status === 'milestone') alert(`ğŸ ì„ ë¬¼ì´ ëˆ„êµ°ê°€ì—ê²Œ ë°°ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ‰ [íŠ¹ë³„ ë³´ìƒ] ë”°ëœ»í•œ ë§ˆìŒì„ ê°€ì§„ ë‹¹ì‹ ì—ê²Œ íŠ¹ë³„í•œ ì„ ë¬¼ [${data.icon}]ì„ ë“œë ¤ìš”!`);
        else alert("ğŸ ì„ ë¬¼ì´ ëˆ„êµ°ê°€ì—ê²Œ ë°°ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ë”°ëœ»í•œ ë§ˆìŒ ê°ì‚¬í•©ë‹ˆë‹¤.");
        switchGiftTab(currentGiftTab);
    }

    async function openAdminStats() {
        toggleSidebar(); document.getElementById('admin-modal').style.display='flex';
        const { data, error } = await sb.rpc('get_admin_stats_secure', { p_user: user.username, p_pw: user.password });
        if(error) return alert("ê¶Œí•œì´ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ");
        document.getElementById('adm-total').innerText = data.total_users + 'ëª…';
        document.getElementById('adm-active').innerText = data.active_users + 'ëª…';
        const ctx = document.getElementById('adminChart').getContext('2d'); if(myChart) myChart.destroy();
        const labels = data.weekly_data.map(d => d.week_start);
        const gifts = data.weekly_data.map(d => d.gift_count);
        const replies = data.weekly_data.map(d => d.reply_count);
        myChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'ë³´ë‚¸ ì„ ë¬¼', data: gifts, backgroundColor: '#42a5f5' }, { label: 'ë³´ë‚¸ ë‹µë¡€', data: replies, backgroundColor: '#ff9800' } ] }, options: { responsive: true, maintainAspectRatio: false } });
    }
    function closeAdminModal() { document.getElementById('admin-modal').style.display='none'; }
    function searchPatient() { const q = document.getElementById('search-id').value.trim(); if(!q) return alert("ID ì…ë ¥"); target = q; alert(`${target} ë‹˜ì„ ì¡°íšŒí•©ë‹ˆë‹¤.`); toggleSidebar(); renderTable(); }
</script>
</body>
</html>
