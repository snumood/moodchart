<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê¸°ë¶„ê¸°ë¡ì§€ 1.2 | ë¶„ë‹¹ì„œìš¸ëŒ€í•™êµë³‘ì›</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    /* --- ë””ìì¸ ì‹œìŠ¤í…œ (ì—‘ì…€ ì‹±í¬ë¡œìœ¨ 100%) --- */
    :root { 
        --primary: #005eb8; /* SNUH Blue */
        --text: #333;
        --border: #bbb;
        /* ì„¹ì…˜ë³„ ë°°ê²½ìƒ‰ (íŒŒìŠ¤í…”í†¤) */
        --bg-mania: #fff0f0;   /* ê¸°ë¶„ ê³ ì–‘: ì—°í•œ ë¶‰ì€ìƒ‰ */
        --bg-dep: #f0f8ff;     /* ê¸°ë¶„ ì €í•˜: ì—°í•œ í‘¸ë¥¸ìƒ‰ */
        --bg-scale: #fffde7;   /* ì •ì„œ/ìƒê°: ì—°í•œ ë…¸ë€ìƒ‰ */
        --bg-body: #e8f5e9;    /* ì‹ ì²´/ìˆ˜ë©´: ì—°í•œ ì´ˆë¡ìƒ‰ */
        --bg-symptom: #f3e5f5; /* ì£¼ìš” ì¦ìƒ: ì—°í•œ ë³´ë¼ìƒ‰ */
        --bg-event: #fafafa;   /* ìƒí™œ ì‚¬ê±´: ì—°í•œ íšŒìƒ‰ */
        --header-h: 40px;      
        --footer-h: 85px;      
    }

    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; background: #fff; color: var(--text); font-size: 11px; overflow: hidden; }
    .hidden { display: none !important; }
    input, button, select, textarea { outline: none; font-family: inherit; font-size: inherit; }
    a { text-decoration: none; color: inherit; }

    /* ë¡œê·¸ì¸ í™”ë©´ */
    #auth-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: #f4f6f9; }
    .auth-box { width: 380px; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; border: 1px solid #eee; }
    .auth-inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
    .btn-auth { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; margin-top: 5px; transition: 0.2s; }
    .btn-auth:hover { opacity: 0.9; }
    .toggle-auth { margin-top: 15px; font-size: 12px; color: #666; cursor: pointer; text-decoration: underline; display: inline-block; }
    .legal-text { text-align: left; font-size: 11px; margin: 10px 0; background: #eee; padding: 10px; border-radius: 6px; color: #555; line-height: 1.4; word-break: keep-all; }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .container { height: 100vh; display: flex; flex-direction: column; }
    
    /* 1. ìƒë‹¨ í—¤ë” */
    .header { height: var(--header-h); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; }
    .month-nav { font-size: 1.3rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: #222; }
    .btn-nav { background: white; border: 1px solid #ccc; padding: 4px 8px; cursor: pointer; border-radius: 4px; font-size: 12px; height: 26px; display: flex; align-items: center; justify-content: center; white-space: nowrap;}
    .btn-nav:hover { background: #f5f5f5; border-color: #999; }
    #date-picker { border: 1px solid #ccc; padding: 0 5px; border-radius: 4px; height: 24px; font-size: 12px; cursor: pointer; }

    /* 2. ì—‘ì…€ ê·¸ë¦¬ë“œ (ì¤‘ì•™ ìŠ¤í¬ë¡¤ ì˜ì—­) */
    .grid-wrapper { flex: 1; overflow: auto; background: #fff; position: relative; }
    table { border-collapse: separate; border-spacing: 0; min-width: 100%; table-layout: fixed; }
    
    th, td { 
        border-right: 1px solid var(--border); 
        border-bottom: 1px solid var(--border); 
        text-align: center; 
        height: 26px; /* ì˜¤ë°€ì¡°ë°€í•œ ë†’ì´ */
        padding: 0; 
        box-sizing: border-box; 
        vertical-align: middle; 
    }
    
    /* ê³ ì • í—¤ë” (ë‚ ì§œ) */
    thead th { position: sticky; top: 0; background: #f9f9f9; z-index: 10; border-bottom: 2px solid #999; height: 30px; font-weight: bold; }
    /* ê³ ì • ì²« ì—´ (í•­ëª©ëª…) */
    .col-label { 
        position: sticky; left: 0; z-index: 20; 
        width: 160px; min-width: 160px; 
        border-right: 2px solid #888; 
        text-align: left; padding-left: 8px; 
        font-weight: 600; font-size: 11px;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        background: #fff; 
    }
    
    /* ì„¹ì…˜ë³„ í–‰ ë°°ê²½ìƒ‰ ì ìš© */
    tr.sec-mania td, tr.sec-mania .col-label { background-color: var(--bg-mania); }
    tr.sec-dep td, tr.sec-dep .col-label { background-color: var(--bg-dep); }
    tr.sec-scale td, tr.sec-scale .col-label { background-color: var(--bg-scale); }
    tr.sec-body td, tr.sec-body .col-label { background-color: var(--bg-body); }
    tr.sec-symptom td, tr.sec-symptom .col-label { background-color: var(--bg-symptom); }
    tr.sec-event td, tr.sec-event .col-label { background-color: var(--bg-event); }

    /* ìš”ì¼ ë° ê³µíœ´ì¼ */
    .day-sun { color: #e53935; background-color: #fff5f5 !important; border-right: 2px solid #888 !important; }
    .day-sat { color: #1e88e5; background-color: #f0f8ff !important; }
    .day-holiday { color: #e53935 !important; background-color: #ffebee !important; font-weight: bold; }

    /* ì…€ ì…ë ¥ ìŠ¤íƒ€ì¼ */
    .cell-check { cursor: pointer; color: #ddd; font-size: 14px; transition: color 0.1s; }
    .cell-check:hover { color: #aaa; }
    .cell-check.checked { font-weight: 900; color: #000; }
    .cell-check.checked::after { content: "âœ”"; }
    
    .cell-select { width: 100%; height: 100%; border: none; background: transparent; text-align-last: center; -webkit-appearance: none; cursor: pointer; font-weight: 500; }
    .cell-input { width: 100%; height: 100%; border: none; background: transparent; text-align: center; }
    .cell-event { cursor: pointer; text-align: left; padding: 0 5px; color: var(--primary); font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cell-event:hover { text-decoration: underline; background-color: rgba(0,0,0,0.05); }
    .disabled-cell { background-color: #eee !important; pointer-events: none; }

    /* íˆ´íŒ (ì‘ì„±ë²• ì•ˆë‚´) */
    .tooltip-target:hover::after {
        content: attr(data-tip);
        position: fixed; left: 170px; top: 50%; transform: translateY(-50%);
        background: #2d3436; color: #fff; padding: 10px; border-radius: 6px;
        width: 240px; font-size: 12px; line-height: 1.5; z-index: 9999;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none; white-space: pre-wrap;
    }

    /* 3. í•˜ë‹¨ ì„¹ì…˜ (í‰ê°€ & ë§í¬ & í‘¸í„°) */
    .bottom-panel { height: var(--footer-h); flex-shrink: 0; background: #f8f9fa; border-top: 2px solid #ccc; display: flex; flex-direction: column; }
    
    /* ì›”ê°„ í‰ê°€ ì˜ì—­ */
    .monthly-score-bar { 
        display: flex; align-items: center; justify-content: space-between; 
        padding: 8px 15px; background: #fff; border-bottom: 1px solid #eee; 
    }
    .score-group { display: flex; align-items: center; gap: 20px; font-size: 12px; }
    .score-item { display: flex; align-items: center; gap: 8px; }
    .score-input { width: 40px; padding: 3px; border: 1px solid #ccc; border-radius: 3px; text-align: center; }
    .link-btn { color: var(--primary); font-weight: bold; display: flex; align-items: center; gap: 3px; transition: 0.2s; white-space: nowrap;}
    .link-btn:hover { text-decoration: underline; color: #004494; }

    /* í‘¸í„° (ë©´ì±…ì¡°í•­ & ë°ì´í„° ê´€ë¦¬) */
    .footer { flex: 1; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px; color: #666; }
    .footer-warning { line-height: 1.3; max-width: 65%; word-break: keep-all; font-weight: 500; }
    .footer-btns { display: flex; gap: 8px; }

    /* ëª¨ë‹¬ (ìƒí™œì‚¬ê±´ ì…ë ¥) */
    #event-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .modal-header { font-weight: bold; margin-bottom: 12px; font-size: 14px; display: flex; justify-content: space-between; color: var(--primary); }
    .modal-textarea { width: 100%; height: 100px; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; resize: none; border-radius: 6px; margin-bottom: 15px; font-size: 13px; line-height: 1.4; }
    .modal-btns { text-align: right; }
    .btn-modal { padding: 6px 14px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-save { background: var(--primary); color: white; }
    .btn-cancel { background: #eee; color: #333; margin-right: 5px; }

    @media (max-width: 768px) {
        .col-label { width: 120px; min-width: 120px; font-size: 11px; }
        .bottom-panel { height: auto; padding-bottom: 10px; }
        .monthly-score-bar { flex-direction: column; align-items: flex-start; gap: 10px; }
        .footer { flex-direction: column; align-items: flex-start; gap: 10px; margin-top: 5px; }
        .footer-btns { width: 100%; justify-content: space-between; }
        .tooltip-target:hover::after { display: none; }
        .footer-warning { max-width: 100%; }
        .score-group { flex-wrap: wrap; gap: 10px;}
    }
</style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--primary); margin:0 0 20px 0;">ê¸°ë¶„ê¸°ë¡ì§€</h2>
        <div id="login-form">
            <input id="l-id" class="auth-inp" placeholder="ì•„ì´ë””">
            <input id="l-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button class="btn-auth" onclick="login()">ë¡œê·¸ì¸</button>
            <span class="toggle-auth" onclick="toggleAuth('join')">íšŒì›ê°€ì…</span>
        </div>
        <div id="join-form" class="hidden">
            <input id="j-id" class="auth-inp" placeholder="í¬ë§ ì•„ì´ë””">
            <input id="j-pw" class="auth-inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <input id="j-hosp" class="auth-inp" placeholder="ë³‘ì› í™˜ìë²ˆí˜¸ (ì„ íƒ)">
            <div class="legal-text">
                ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš© í”„ë¡œê·¸ë¨ì´ ì•„ë‹™ë‹ˆë‹¤. <br>
                ì´ í”„ë¡œê·¸ë¨ì˜ ì‚¬ìš©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì±…ì„ì€ ì˜ë£Œì§„ì´ ì•„ë‹Œ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ìœ ë…í•˜ì„¸ìš”.
            </div>
            <label style="font-size:12px; cursor:pointer; display:block; text-align:left; margin-bottom:10px;">
                <input type="checkbox" id="j-agree"> ìœ„ ë‚´ìš©ì„ í™•ì¸í•˜ì˜€ìœ¼ë©° ë™ì˜í•©ë‹ˆë‹¤.
            </label>
            <button class="btn-auth" style="background:#28a745;" onclick="join()">ê°€ì…ì™„ë£Œ</button>
            <span class="toggle-auth" onclick="toggleAuth('login')">ëŒì•„ê°€ê¸°</span>
        </div>
    </div>
</div>

<div id="main-screen" class="hidden">
    <div class="container">
        <div class="header">
            <div class="month-nav">
                <button class="btn-nav" onclick="moveMonth(-1)">â—€</button>
                <input type="date" id="date-picker" onchange="jumpToDate(this.value)">
                <button class="btn-nav" onclick="moveMonth(1)">â–¶</button>
            </div>
            <div style="display:flex; align-items:center; gap:8px;">
                <span id="user-display" style="font-weight:bold; font-size:12px;"></span>
                <button class="btn-nav" onclick="location.reload()">ë¡œê·¸ì•„ì›ƒ</button>
                <div id="doc-panel" class="hidden">
                    <input id="search-id" placeholder="í™˜ìID" style="padding:2px 5px; width:70px; height:24px; border:1px solid #ccc; border-radius:4px;">
                    <button class="btn-nav" onclick="loadData()">ì¡°íšŒ</button>
                </div>
            </div>
        </div>

        <div class="grid-wrapper">
            <table id="mood-table">
                <thead>
                    <tr id="header-row"><th class="col-label" style="text-align:center;">í•­ëª© / ë‚ ì§œ</th></tr>
                    <tr id="dow-row"><th class="col-label" style="text-align:center; background:#fff;">ìš”ì¼</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>

        <div class="bottom-panel">
            <div class="monthly-score-bar">
                <div class="score-group">
                    <strong>[ì›”ê°„ ìê°€ í‰ê°€]</strong>
                    <div class="score-item">
                        <a href="https://snumood.github.io/homepage/ls.html" target="_blank" class="link-btn">â–¶ ìƒí™œìŠµê´€ì ìˆ˜</a>
                        <input id="score-ls" type="number" class="score-input" placeholder="ì ìˆ˜" onblur="saveMonthlyScore('ls', this.value)">
                    </div>
                    <div class="score-item">
                        <a href="https://snumood.github.io/homepage/mssi.html" target="_blank" class="link-btn">â–¶ ê¸°ë¶„ì•ˆì •ì„±í‰ê°€</a>
                        <input id="score-mssi" type="number" class="score-input" placeholder="ì ìˆ˜" onblur="saveMonthlyScore('mssi', this.value)">
                    </div>
                </div>
                <div>
                    <a href="https://drive.google.com/file/d/11grOF3LoZ1MYFk0GCB7WaCDRCTsYm7E7/view?usp=sharing" target="_blank" class="link-btn" style="color:#555;">
                        ğŸ“– ê¸°ë¶„ê¸°ë¡ì§€ ì‘ì„±ë°©ë²• ë³´ê¸°
                    </a>
                </div>
            </div>

            <div class="footer">
                <div class="footer-warning">
                    ë³¸ í”„ë¡œê·¸ë¨ì€ ì¢…ì´ ê¸°ë¶„ê¸°ë¡ì§€ë¥¼ ì‚¬ìš©í•˜ê¸° ì–´ë ¤ìš´ ë¶„ë“¤ì„ ìœ„í•´ ë§Œë“  ë¬´ë£Œ ì˜¨ë¼ì¸ í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. ì˜ë£Œìš© í”„ë¡œê·¸ë¨ì´ ì•„ë‹™ë‹ˆë‹¤. <br>
                    ì´ í”„ë¡œê·¸ë¨ì˜ ì‚¬ìš©ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì±…ì„ì€ ì˜ë£Œì§„ì´ ì•„ë‹Œ ì‘ì„±ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. ê°œì¸ì‹ë³„ì •ë³´ë¥¼ ì ì§€ ì•Šë„ë¡ ìœ ë…í•˜ì„¸ìš”.
                </div>
                <div class="footer-btns">
                    <button class="btn-nav" onclick="exportData()" style="border-color:var(--primary); color:var(--primary);">ğŸ’¾ ë°ì´í„° ì €ì¥</button>
                    <input type="file" id="import-file" accept=".csv" style="display:none;" onchange="importData(this)">
                    <button class="btn-nav" onclick="document.getElementById('import-file').click()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="event-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span id="modal-title"></span>
            <span style="cursor:pointer; color:#999;" onclick="closeEventModal()">âœ•</span>
        </div>
        <textarea id="modal-text" class="modal-textarea" placeholder="ì˜¤ëŠ˜ì˜ íŠ¹ë³„í•œ ì‚¬ê±´ì´ë‚˜ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
        <div class="modal-btns">
            <button class="btn-modal btn-cancel" onclick="closeEventModal()">ì·¨ì†Œ</button>
            <button class="btn-modal btn-save" onclick="saveEventFromModal()">ì €ì¥í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // [ì„¤ì •] Supabase
    const SUPABASE_URL = 'https://vzybcxvwpqhdmrxbxzmq.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_bAlzb9dPdxb5lpzudvqwHQ_MxpUVkNj';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // [ê³µíœ´ì¼ ë°ì´í„° 2025~2040: ìƒëµ ì—†ì´ ì „ë¶€ í¬í•¨]
    const krHolidays = {
        // ì–‘ë ¥ ê³ ì •
        '01-01': 'ì‹ ì •', '03-01': 'ì‚¼ì¼ì ˆ', '05-05': 'ì–´ë¦°ì´ë‚ ', '06-06': 'í˜„ì¶©ì¼', 
        '08-15': 'ê´‘ë³µì ˆ', '10-03': 'ê°œì²œì ˆ', '10-09': 'í•œê¸€ë‚ ', '12-25': 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        
        // 2025
        '2025-01-28':'ì„¤ë‚ ', '2025-01-29':'ì„¤ë‚ ', '2025-01-30':'ì„¤ë‚ ', '2025-03-03':'ëŒ€ì²´ê³µíœ´ì¼', '2025-05-06':'ëŒ€ì²´ê³µíœ´ì¼',
        '2025-10-05':'ì¶”ì„', '2025-10-06':'ì¶”ì„', '2025-10-07':'ì¶”ì„', '2025-10-08':'ëŒ€ì²´ê³µíœ´ì¼',
        
        // 2026
        '2026-02-16':'ì„¤ë‚ ', '2026-02-17':'ì„¤ë‚ ', '2026-02-18':'ì„¤ë‚ ', '2026-05-24':'ì„ê°€íƒ„ì‹ ì¼', '2026-05-25':'ëŒ€ì²´ê³µíœ´ì¼',
        '2026-09-24':'ì¶”ì„', '2026-09-25':'ì¶”ì„', '2026-09-26':'ì¶”ì„', 
        
        // 2027
        '2027-02-06':'ì„¤ë‚ ', '2027-02-07':'ì„¤ë‚ ', '2027-02-08':'ì„¤ë‚ ', '2027-02-09':'ëŒ€ì²´ê³µíœ´ì¼', '2027-05-13':'ì„ê°€íƒ„ì‹ ì¼',
        '2027-09-14':'ì¶”ì„', '2027-09-15':'ì¶”ì„', '2027-09-16':'ì¶”ì„',
        
        // 2028
        '2028-01-26':'ì„¤ë‚ ', '2028-01-27':'ì„¤ë‚ ', '2028-01-28':'ì„¤ë‚ ', '2028-05-02':'ì„ê°€íƒ„ì‹ ì¼',
        '2028-10-02':'ì¶”ì„', '2028-10-03':'ê°œì²œì ˆ/ì¶”ì„', '2028-10-04':'ì¶”ì„', '2028-10-05':'ëŒ€ì²´ê³µíœ´ì¼',
        
        // 2029
        '2029-02-12':'ì„¤ë‚ ', '2029-02-13':'ì„¤ë‚ ', '2029-02-14':'ì„¤ë‚ ', '2029-05-20':'ì„ê°€íƒ„ì‹ ì¼', '2029-05-21':'ëŒ€ì²´ê³µíœ´ì¼',
        '2029-09-21':'ì¶”ì„', '2029-09-22':'ì¶”ì„', '2029-09-23':'ì¶”ì„',
        
        // 2030
        '2030-02-02':'ì„¤ë‚ ', '2030-02-03':'ì„¤ë‚ ', '2030-02-04':'ì„¤ë‚ ', '2030-02-05':'ëŒ€ì²´ê³µíœ´ì¼', '2030-05-09':'ì„ê°€íƒ„ì‹ ì¼',
        '2030-09-11':'ì¶”ì„', '2030-09-12':'ì¶”ì„', '2030-09-13':'ì¶”ì„',

        // 2031
        '2031-01-22':'ì„¤ë‚ ', '2031-01-23':'ì„¤ë‚ ', '2031-01-24':'ì„¤ë‚ ', '2031-05-28':'ì„ê°€íƒ„ì‹ ì¼',
        '2031-09-30':'ì¶”ì„', '2031-10-01':'ì¶”ì„', '2031-10-02':'ì¶”ì„',

        // 2032
        '2032-02-10':'ì„¤ë‚ ', '2032-02-11':'ì„¤ë‚ ', '2032-02-12':'ì„¤ë‚ ', '2032-05-16':'ì„ê°€íƒ„ì‹ ì¼', '2032-05-17':'ëŒ€ì²´ê³µíœ´ì¼',
        '2032-09-18':'ì¶”ì„', '2032-09-19':'ì¶”ì„', '2032-09-20':'ì¶”ì„', '2032-09-21':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2033
        '2033-01-30':'ì„¤ë‚ ', '2033-01-31':'ì„¤ë‚ ', '2033-02-01':'ì„¤ë‚ ', '2033-05-06':'ì„ê°€íƒ„ì‹ ì¼',
        '2033-10-07':'ì¶”ì„', '2033-10-08':'ì¶”ì„', '2033-10-09':'ì¶”ì„', '2033-10-10':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2034
        '2034-02-18':'ì„¤ë‚ ', '2034-02-19':'ì„¤ë‚ ', '2034-02-20':'ì„¤ë‚ ', '2034-02-21':'ëŒ€ì²´ê³µíœ´ì¼', '2034-05-25':'ì„ê°€íƒ„ì‹ ì¼',
        '2034-09-26':'ì¶”ì„', '2034-09-27':'ì¶”ì„', '2034-09-28':'ì¶”ì„',

        // 2035
        '2035-02-07':'ì„¤ë‚ ', '2035-02-08':'ì„¤ë‚ ', '2035-02-09':'ì„¤ë‚ ', '2035-05-15':'ì„ê°€íƒ„ì‹ ì¼',
        '2035-09-15':'ì¶”ì„', '2035-09-16':'ì¶”ì„', '2035-09-17':'ì¶”ì„', '2035-09-18':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2036
        '2036-01-27':'ì„¤ë‚ ', '2036-01-28':'ì„¤ë‚ ', '2036-01-29':'ì„¤ë‚ ', '2036-05-02':'ì„ê°€íƒ„ì‹ ì¼',
        '2036-10-03':'ì¶”ì„', '2036-10-04':'ì¶”ì„', '2036-10-05':'ì¶”ì„', '2036-10-06':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2037
        '2037-02-14':'ì„¤ë‚ ', '2037-02-15':'ì„¤ë‚ ', '2037-02-16':'ì„¤ë‚ ', '2037-02-17':'ëŒ€ì²´ê³µíœ´ì¼', '2037-05-22':'ì„ê°€íƒ„ì‹ ì¼',
        '2037-09-23':'ì¶”ì„', '2037-09-24':'ì¶”ì„', '2037-09-25':'ì¶”ì„',

        // 2038
        '2038-02-03':'ì„¤ë‚ ', '2038-02-04':'ì„¤ë‚ ', '2038-02-05':'ì„¤ë‚ ', '2038-05-11':'ì„ê°€íƒ„ì‹ ì¼',
        '2038-09-12':'ì¶”ì„', '2038-09-13':'ì¶”ì„', '2038-09-14':'ì¶”ì„', '2038-09-15':'ëŒ€ì²´ê³µíœ´ì¼',

        // 2039
        '2039-01-23':'ì„¤ë‚ ', '2039-01-24':'ì„¤ë‚ ', '2039-01-25':'ì„¤ë‚ ', '2039-05-01':'ì„ê°€íƒ„ì‹ ì¼', '2039-05-02':'ëŒ€ì²´ê³µíœ´ì¼',
        '2039-10-01':'ì¶”ì„', '2039-10-02':'ì¶”ì„', '2039-10-03':'ì¶”ì„',

        // 2040
        '2040-02-11':'ì„¤ë‚ ', '2040-02-12':'ì„¤ë‚ ', '2040-02-13':'ì„¤ë‚ ', '2040-02-14':'ëŒ€ì²´ê³µíœ´ì¼', '2040-05-19':'ì„ê°€íƒ„ì‹ ì¼',
        '2040-09-20':'ì¶”ì„', '2040-09-21':'ì¶”ì„', '2040-09-22':'ì¶”ì„'
    };

    // [í•­ëª© ë° ì„¹ì…˜ ì •ì˜]
    const items = [
        // ê¸°ë¶„
        { id: 'm_p4', label: '+4 ê·¹íˆ ìƒìŠ¹', desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'mania', type: 'check' },
        { id: 'm_p3', label: '+3 ìƒë‹¹í•œ ìƒìŠ¹', desc: 'ìƒë‹¹í•œ ì§€ì¥, ì£¼ë³€ì—ì„œ í˜ë“¤ì–´í•¨', section: 'mania', type: 'check' },
        { id: 'm_p2', label: '+2 ë¶„ëª…í•œ ìƒìŠ¹', desc: 'ë‹¤ì†Œ ì§€ì¥, ì „ê³¼ ë‹¤ë¥´ë‹¤ëŠ” ì§€ì ', section: 'mania', type: 'check' },
        { id: 'm_p1', label: '+1 ë¯¸ì„¸í•œ ìƒìŠ¹', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ë³¸ì¸ì€ ê¸°ë¶„ ì¢‹ìŒ', section: 'mania', type: 'check' },
        { id: 'm_0',  label: '0  ë³´í†µ ê¸°ë¶„',   desc: 'í‰ì˜¨í•˜ê³  ì •ìƒì ì¸ ìƒíƒœ', section: 'mania', type: 'check' }, 
        { id: 'm_m1', label: '-1 ë¯¸ì„¸í•œ ì €í•˜', desc: 'ë¯¸ë¯¸í•œ ë³€í™”, ì˜ìš• ì €í•˜', section: 'dep', type: 'check' },
        { id: 'm_m2', label: '-2 ë¶„ëª…í•œ ì €í•˜', desc: 'ì¼ìƒì„ ìœ ì§€í•˜ë ¤ ë…¸ë ¥ í•„ìš”', section: 'dep', type: 'check' },
        { id: 'm_m3', label: '-3 ìƒë‹¹í•œ ì €í•˜', desc: 'ë…¸ë ¥í•´ë„ ê¸°ëŠ¥ì´ ë–¨ì–´ì§', section: 'dep', type: 'check' },
        { id: 'm_m4', label: '-4 ê·¹íˆ ì €í•˜',   desc: 'ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ê±°ë‚˜ ì…ì›', section: 'dep', type: 'check' },
        
        // ì •ì„œ ë°˜ì‘ / ìƒê° (ì²™ë„)
        { id: 's_anx', label: 'ì •ì„œ ë°˜ì‘\n(ë¶ˆì•ˆ/ìš°ìš¸ ë“±)', desc: '-4(ë¬´ê°ê°) ~ +4(ê³¼ë¯¼)', section: 'scale', type: 'scale' },
        { id: 's_mot', label: 'ì˜ìš•/í¥ë¯¸', desc: '-4(ë¬´ì˜ìš•) ~ +4(ì¶©ë™ì )', section: 'scale', type: 'scale' },
        { id: 's_tht', label: 'ìƒê°ì˜ ì†ë„/ì–‘', desc: '-4(ëŠë¦¼/ì—†ìŒ) ~ +4(ë¹ ë¦„/ë§ìŒ)', section: 'scale', type: 'scale' },

        // ì‹ ì²´
        { id: 'sleep', label: 'ìˆ˜ë©´ì‹œê°„ (ì‹œê°„)', desc: '0~24ì‹œê°„ ì„ íƒ', section: 'body', type: 'sleep' },
        { id: 'weight',label: 'ì²´ì¤‘ (kg)\n*ì¼ìš”ì¼ë§Œ', desc: 'ì¼ìš”ì¼ ì•„ì¹¨ ì¸¡ì • ê¶Œì¥', section: 'body', type: 'weight' },

        // ì£¼ìš” ì¦ìƒ
        { id: 'panic', label: 'ê³µí™©ë°œì‘ (âˆš)', desc: 'ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê³µí¬/ì‹ ì²´ì¦ìƒ', section: 'symptom', type: 'check' },
        { id: 'hyper', label: 'ê³¼í˜¸í¡ (âˆš)', desc: 'ìˆ¨ì´ ê°€ì˜ê³  ì†ë°œ ì €ë¦¼ ë“±', section: 'symptom', type: 'check' },
        { id: 'cry',   label: 'ìš¸ìŒ (âˆš)', desc: '', section: 'symptom', type: 'check' },
        { id: 'pain',  label: 'í†µì¦ (âˆš)', desc: '', section: 'symptom', type: 'check' },
        { id: 'meds',  label: 'ì•½ë¬¼ë³µìš© (âˆš)', desc: '', section: 'symptom', type: 'check' },
        { id: 'period',label: 'ìƒë¦¬ê¸°ê°„ (âˆš)', desc: '', section: 'symptom', type: 'check' },
        { id: 'alcoh', label: 'ìŒì£¼ (âˆš)', desc: '', section: 'symptom', type: 'check' },
        { id: 'binge', label: 'í­ì‹ (âˆš)', desc: '', section: 'symptom', type: 'check' },
        
        // ìƒí™œ ì‚¬ê±´
        { id: 'event', label: 'ìƒí™œì‚¬ê±´ (í´ë¦­)', desc: 'í´ë¦­í•˜ì—¬ ë‚´ìš©ì„ ê¸°ë¡í•˜ì„¸ìš”', section: 'event', type: 'event' }
    ];

    let user = null, target = null, curDate = new Date();
    let modalTarget = { day: null, id: null };

    // --- ì¸ì¦ ---
    function toggleAuth(m) {
        document.getElementById('login-form').classList.toggle('hidden', m !== 'login');
        document.getElementById('join-form').classList.toggle('hidden', m !== 'join');
    }

    async function join() {
        if(!document.getElementById('j-agree').checked) return alert("ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
        const id = document.getElementById('j-id').value, pw = document.getElementById('j-pw').value, h = document.getElementById('j-hosp').value;
        if(!id || !pw) return alert('í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
        const { error } = await sb.from('user_profiles').insert([{ username:id, password:pw, hospital_id:h }]);
        if(error) alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.'); else { alert('ê°€ì… ì™„ë£Œ.'); toggleAuth('login'); }
    }

    async function login() {
        const id = document.getElementById('l-id').value, pw = document.getElementById('l-pw').value;
        const { data } = await sb.from('user_profiles').select('*').eq('username',id).eq('password',pw).single();
        if(!data) return alert('ë¡œê·¸ì¸ ì‹¤íŒ¨.');
        user = data; target = id;
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('main-screen').classList.remove('hidden');
        document.getElementById('user-display').innerText = id + (user.role==='doctor'?'(ì˜ë£Œì§„)':'');
        if(user.role==='doctor') { document.getElementById('doc-panel').classList.remove('hidden'); target = null; }
        renderTable();
    }

    // --- ë Œë”ë§ ---
    function renderTable() {
        const year = curDate.getFullYear(), month = curDate.getMonth();
        document.getElementById('date-picker').value = `${year}-${String(month+1).padStart(2,'0')}-01`;

        const lastDay = new Date(year, month+1, 0).getDate();
        const header = document.getElementById('header-row');
        const dowRow = document.getElementById('dow-row');
        const body = document.getElementById('table-body');

        // ì´ˆê¸°í™”
        while(header.children.length > 1) header.removeChild(header.lastChild);
        while(dowRow.children.length > 1) dowRow.removeChild(dowRow.lastChild);
        body.innerHTML = '';

        const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

        // í—¤ë” ìƒì„±
        for(let d=1; d<=lastDay; d++) {
            const dt = new Date(year, month, d);
            const dayIdx = dt.getDay();
            const kShort = `${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const kFull = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const hol = krHolidays[kShort] || krHolidays[kFull];
            const isRed = dayIdx === 0 || hol;

            let th = document.createElement('th'); th.innerText = d;
            if(isRed) th.className = 'day-holiday';
            if(hol) th.title = hol;
            if(dayIdx===6 && !isRed) th.className = 'day-sat';
            header.appendChild(th);

            let td = document.createElement('th'); td.innerText = days[dayIdx];
            if(isRed) td.className = 'day-holiday';
            if(dayIdx===6 && !isRed) td.className = 'day-sat';
            dowRow.appendChild(td);
        }

        // ë³¸ë¬¸ ìƒì„±
        items.forEach(item => {
            let tr = document.createElement('tr');
            tr.classList.add('sec-' + item.section); 

            let th = document.createElement('th');
            th.className = 'col-label tooltip-target'; th.innerText = item.label; th.setAttribute('data-tip', item.desc);
            tr.appendChild(th);

            for(let d=1; d<=lastDay; d++) {
                const dt = new Date(year, month, d);
                let td = document.createElement('td');
                if(dt.getDay() === 0) td.style.borderRight = "2px solid #888"; 
                
                td.dataset.d = d; td.dataset.c = item.id; td.dataset.s = item.section;

                // 1. ê¸°ë¶„ (ì²´í¬ë°•ìŠ¤)
                if(item.type === 'check') {
                    td.className = 'cell-check';
                    td.onclick = () => {
                        if(user.role === 'doctor') return;
                        const isChecked = td.classList.contains('checked');
                        // ê¸°ë¶„ ì„¹ì…˜ì´ë©´ 2ê°œ ì œí•œ ì²´í¬
                        if((item.section === 'mania' || item.section === 'dep') && !isChecked) {
                            const cnt = document.querySelectorAll(`tr.sec-mania td[data-d="${d}"].checked, tr.sec-dep td[data-d="${d}"].checked`).length;
                            if(cnt >= 2) return alert("ê¸°ë¶„ í•­ëª©ì€ í•˜ë£¨ì— ìµœëŒ€ 2ê°œê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        }
                        if(isChecked) {
                            td.classList.remove('checked'); saveData(d, item.id, null);
                        } else {
                            td.classList.add('checked'); saveData(d, item.id, 'Y');
                        }
                    };
                }
                // 2. ì²™ë„ (-4~4)
                else if(item.type === 'scale') {
                    let sel = createSelect(-4, 4);
                    sel.onchange = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(sel);
                }
                // 3. ìˆ˜ë©´ (0~24)
                else if(item.type === 'sleep') {
                    let sel = createSelect(0, 24);
                    sel.onchange = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(sel);
                }
                // 4. ì²´ì¤‘
                else if(item.type === 'weight') {
                    let inp = document.createElement('input'); inp.type='number'; inp.className='cell-input';
                    if(dt.getDay() !== 0) { td.className = 'disabled-cell'; inp.disabled = true; }
                    else inp.onblur = (e) => saveData(d, item.id, e.target.value);
                    td.appendChild(inp);
                }
                // 5. ìƒí™œì‚¬ê±´
                else if(item.type === 'event') {
                    td.className = 'cell-event';
                    td.onclick = () => { if(user.role!=='doctor') openEventModal(d, item.id, td.innerText); };
                }
                tr.appendChild(td);
            }
            body.appendChild(tr);
        });
        
        // ì›”ê°„ ì ìˆ˜ ì´ˆê¸°í™”
        document.getElementById('score-ls').value = '';
        document.getElementById('score-mssi').value = '';
        
        if(target) loadData();
    }

    function createSelect(min, max) {
        let s = document.createElement('select'); s.className = 'cell-select';
        s.add(new Option('', ''));
        for(let i=min; i<=max; i++) s.add(new Option(i, i));
        return s;
    }

    // --- ë°ì´í„° ì²˜ë¦¬ ---
    async function saveData(day, cat, val) {
        if(user.role==='doctor') return;
        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const date = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
        
        if(!val) await sb.from('mood_records').delete().match({username:user.username, record_date:date, category:cat});
        else await sb.from('mood_records').upsert({username:user.username, record_date:date, category:cat, value:val});
    }

    // ì›”ê°„ ì ìˆ˜ ì €ì¥
    async function saveMonthlyScore(type, val) {
        if(user.role==='doctor') return;
        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const date = `${y}-${String(m).padStart(2,'0')}-01`;
        await sb.from('mood_records').upsert({
            username: user.username, 
            record_date: date, 
            category: `score_${type}`, 
            value: val 
        });
    }

    async function loadData() {
        if(user.role==='doctor') target = document.getElementById('search-id').value;
        if(!target) return;

        // ì´ˆê¸°í™”
        document.querySelectorAll('.checked').forEach(e=>e.classList.remove('checked'));
        document.querySelectorAll('input, select').forEach(e => { if(!e.id.includes('search') && !e.id.includes('date') && !e.id.includes('score')) e.value=''; });
        document.querySelectorAll('.cell-event').forEach(e => e.innerText = '');

        const y = curDate.getFullYear(), m = curDate.getMonth()+1;
        const lastDay = new Date(y, m, 0).getDate();
        const start = `${y}-${String(m).padStart(2,'0')}-01`;
        const end = `${y}-${String(m).padStart(2,'0')}-${lastDay}`;

        const { data } = await sb.from('mood_records').select('*').eq('username',target).gte('record_date',start).lte('record_date',end);
        
        data?.forEach(rec => {
            // ì›”ê°„ ì ìˆ˜
            if(rec.category === 'score_ls') document.getElementById('score-ls').value = rec.value;
            else if(rec.category === 'score_mssi') document.getElementById('score-mssi').value = rec.value;
            // ì¼ë°˜ ë°ì´í„°
            else {
                const day = new Date(rec.record_date).getDate();
                const cell = document.querySelector(`td[data-d="${day}"][data-c="${rec.category}"]`);
                if(cell) {
                    if(cell.classList.contains('cell-check')) {
                        if(rec.value === 'Y') cell.classList.add('checked');
                    } else if(cell.classList.contains('cell-event')) {
                        cell.innerText = rec.value;
                    } else if(cell.querySelector('select')) {
                        cell.querySelector('select').value = rec.value;
                    } else if(cell.querySelector('input')) {
                        cell.querySelector('input').value = rec.value;
                    }
                }
            }
        });
    }

    // --- ëª¨ë‹¬ ---
    function openEventModal(day, id, txt) {
        modalTarget = { day, id };
        document.getElementById('modal-title').innerText = `${day}ì¼ ìƒí™œì‚¬ê±´`;
        document.getElementById('modal-text').value = txt || "";
        document.getElementById('event-modal').style.display = 'flex';
        document.getElementById('modal-text').focus();
    }
    function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
    function saveEventFromModal() {
        const txt = document.getElementById('modal-text').value;
        const cell = document.querySelector(`td[data-d="${modalTarget.day}"][data-c="${modalTarget.id}"]`);
        if(cell) cell.innerText = txt;
        saveData(modalTarget.day, modalTarget.id, txt);
        closeEventModal();
    }

    // --- ê¸°íƒ€ ---
    function moveMonth(n) { curDate.setMonth(curDate.getMonth() + n); renderTable(); }
    function jumpToDate(val) { curDate = new Date(val); renderTable(); }

    async function exportData() {
        if(user.role === 'doctor') return alert("ë¶ˆê°€");
        const { data } = await sb.from('mood_records').select('*').eq('username', user.username).order('record_date');
        if(!data.length) return alert("ë°ì´í„° ì—†ìŒ");
        let csv = "data:text/csv;charset=utf-8,Date,Category,Value\n";
        data.forEach(r => csv += `${r.record_date},${r.category},"${r.value.replace(/"/g, '""')}"\n`);
        const link = document.createElement("a");
        link.href = encodeURI(csv); link.download = `mood_${user.username}.csv`;
        link.click();
    }

    async function importData(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = async (e) => {
            const rows = e.target.result.split("\n").slice(1);
            let ups = [];
            rows.forEach(row => {
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if(cols.length>=3) ups.push({username:user.username, record_date:cols[0].trim(), category:cols[1].trim(), value:cols[2].replace(/^"|"$/g,'').trim()});
            });
            if(ups.length) { 
                for(let i=0; i<ups.length; i+=100) await sb.from('mood_records').upsert(ups.slice(i,i+100));
                alert("ì™„ë£Œ"); loadData(); 
            }
        };
        r.readAsText(f);
    }
</script>
</body>
</html>
